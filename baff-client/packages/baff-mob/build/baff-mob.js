Ext.define("Baff.app.model.Validations",{override:"Ext.data.Validations",dtPresentMessage:"Must be present",getPresentMessage:function(){return this.dtPresentMessage},getRdpresentMessage:function(){return this.dtPresentMessage},present:function(a,b){if(arguments.length===1){b=a}return !Ext.isEmpty(b)},rdpresent:function(a,b){if(arguments.length===1){b=a}return !Ext.isEmpty(b)&&b!==0}});Ext.define("Baff.app.view.FormPanel",{extend:"Ext.form.Panel",xtype:"formpanel",requires:["Ext.field.Checkbox","Ext.form.FieldSet"],dirty:false,dtValidationError:"Validation Error",config:{invalidFieldCls:"invalid-field"},setCleanRecord:function(a){var b=this;b.getFieldsArray().forEach(function(c){c.resetOriginalValue();c.reset();c.removeCls(b.getInvalidFieldCls());if(a){c.on("change",b.onFieldChange,b);c.on("keyup",b.onFieldChange,b)}});if(b.dirty){b.dirty=false;this.fireEvent("dirtychange",b,false)}},onFieldChange:function(){var a=this;if(!a.dirty){a.dirty=true;this.fireEvent("dirtychange",a,true)}},isDirty:function(){return this.dirty},makeReadOnlyForAll:function(a){this.getFieldsArray().forEach(function(b){b.setReadOnly(a)})},markInvalid:function(c){var b=this;b.getFieldsArray().forEach(function(d){d.removeCls("invalidField")});var a="";c.forEach(function(d){var e=Ext.String.format("field[name={0}]",d.id);var f=b.down(e);a+=f.getLabel()+": "+d.msg+"<br>";f.addCls(b.getInvalidFieldCls())});Ext.Msg.alert(b.dtValidationError,a)}});Ext.define("Baff.app.field.Checkbox",{override:"Ext.field.Checkbox",setReadOnly:function(a){if(a){this.disable()}else{this.enable()}}});Ext.define("Baff.app.field.Slider",{override:"Ext.field.Slider",reset:function(){if(this.originalValue!=null){this.setValue(this.originalValue);this.onSliderChange()}else{this.callParent(arguments)}}});Ext.define("Baff.utility.logger.Logger",{extend:"Ext.Base",config:{enableInfo:true,enableDebug:true,enableError:true},info:null,debug:null,error:null,constructor:function(a){this.initConfig(a);this.setInfoLogger(this.getEnableInfo());this.setDebugLogger(this.getEnableDebug());this.setErrorLogger(this.getEnableError())},setInfoLogger:function(a){if(typeof console!="undefined"&&a){this.info=Function.prototype.bind.call(console.log,console)}else{this.info=function(){return}}},setDebugLogger:function(a){if(typeof console!="undefined"&&a){this.debug=Function.prototype.bind.call(console.debug,console)}else{this.debug=function(){return}}},setErrorLogger:function(a){if(typeof console!="undefined"&&a){this.error=Function.prototype.bind.call(console.error,console)}else{this.error=function(){return}}}});Ext.define("Baff.app.model.EntityModel",{extend:"Ext.data.Model",requires:["Ext.data.Validations","Baff.app.model.Validations"],errorMessages:[],errorFields:[],syncGeneration:0,valid:true,originalRecord:null,dtCannotBeModified:"Cannot be modified",inheritableStatics:{isMasterEntity:function(){return(this.masterEntityType==null||this.masterEntityType==this.getName())},getMasterEntityType:function(){if(this.masterEntityType!=null){return this.masterEntityType}else{return this.getName()}},getEntityIdProperty:function(){return this.entityIdProperty},getMasterEntityIdProperty:function(){return this.masterEntityIdProperty},getPrimaryStoreType:function(){return this.primaryStoreType},getEntityType:function(){return this.getName()},masterEntityType:null,masterEntityIdProperty:null,entityIdProperty:"id",primaryStoreType:null,ACTION:{CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"}},config:{idProperty:"clientId",fields:[{name:"entityId",type:"string"},{name:"masterEntityId",type:"string",allowNull:true},{name:"currencyControl",type:"string",allowNull:true},{name:"versionControl",type:"string",allowNull:true}],setDataFromRaw:false},setData:function(b){var a=this;if(a.getSetDataFromRaw()){a.data=a.raw;return a}else{return a.callParent(arguments)}},doIntegrityValidation:function(a,b){},getMasterEntityType:function(){return this.self.getMasterEntityType()},isMasterEntity:function(){return this.self.isMasterEntity()},getEntityIdProperty:function(){return this.self.entityIdProperty},getMasterEntityIdProperty:function(){return this.self.masterEntityIdProperty},getPrimaryStoreType:function(){return this.self.primaryStoreType},setEntityId:function(a){this.set("entityId",a);if(this.getEntityIdProperty()!=null){this.set(this.getEntityIdProperty(),a)}},setMasterEntityId:function(a){this.set("masterEntityId",a);if(this.getMasterEntityIdProperty()!=null){this.set(this.getMasterEntityIdProperty(),a)}},getEntityId:function(){var a=this.get("entityId");if((a==null||a=="")&&this.getEntityIdProperty()!=null){a=this.get(this.getEntityIdProperty())}if(a==""){a=null}return a},getMasterEntityId:function(){var a=this.get("masterEntityId");if(a==null&&this.isMasterEntity()){a=this.getEntityId()}if((a==null||a=="")&&this.getMasterEntityIdProperty()!=null){a=this.get(this.getMasterEntityIdProperty())}if(a==""){a=null}return a},setVersion:function(a){this.set("versionControl",a)},getVersion:function(){return this.get("versionControl")},isValid:function(b,c){var a=this;if(a.syncGeneration!==a.generation){a.valid=true;a.syncGeneration=a.generation;a.errorMessages=[];a.errorFields=[];a.originalRecord=c;if(b!=a.self.ACTION.DELETE){var d=a.validate();if(!d.isValid()){Ext.iterate(d.all,function(e){this.addError(e.getField(),e.getMessage())},a)}}a.doIntegrityValidation(b,c)}return a.valid},validateNoChange:function(c,b){var a=this;if(a.originalRecord){if(a.get(c)!=a.originalRecord.get(c)){if(!b){b=a.dtCannotBeModified}a.addSingleError(c,b)}}},addError:function(d,c){var b=this;if(typeof d==="object"){for(var a=0;a<d.length;a++){b.addSingleError(d[a],c)}}else{b.addSingleError(d,c)}},addSingleError:function(c,b){var a=this;if(a.errorFields.indexOf(c)===-1){a.errorFields.push(c);a.errorMessages.push({id:c,msg:b});a.valid=false}},getErrors:function(){var a=this;a.isValid();return a.errorMessages},setActionCode:function(a){this.setParam("actionCode",a)},setParam:function(b,a){this.getProxy().setExtraParam(b,a)}});Ext.define("Baff.app.model.ServiceProxy",{extend:"Ext.data.proxy.Ajax",alias:"proxy.serviceproxy",idParam:"entityId",config:{reader:{type:"json",rootProperty:"data",totalProperty:"total",useSimpleAccessors:true},writer:{type:"json",allowSingle:true,encode:true,writeAllFields:true,writeRecordId:false,rootProperty:"data"}},getResponse:function(){return this.getReader().rawData}});Ext.define("Baff.app.model.EntityStore",{extend:"Ext.data.Store",requires:"Baff.app.model.ServiceProxy",model:"Baff.app.model.EntityModel",storeKey:null,masterKey:null,storeType:null,hasLoaded:false,config:{masterEntityId:null,ownerId:null,remoteSort:true,remoteFilter:true,pageSize:25,buffered:true,clearOnPageLoad:false},constructor:function(){var a=this;a.callParent(arguments);a.storeType=a.self.getName();a.setKeys(a.ownerId,a.getMasterEntityId())},load:function(){this.currentPage=1;this.hasLoaded=false;this.callParent(arguments)},onProxyLoad:function(a){var b=this;b.callParent(arguments);if(!b.isLoading()&&a.wasSuccessful()){var c=false;if(!b.hasLoaded){b.hasLoaded=true;c=true}b.fireEvent("postfetch",b,b.getProxy().getResponse(),c)}},removeAll:function(){this.hasLoaded=false;this.callParent(arguments)},flush:function(a){this.removeAll();this.fireEvent("flush",this,a)},hasLoadedData:function(){return this.hasLoaded},setParam:function(b,a){this.getProxy().setExtraParam(b,a)},setKeys:function(a,e){var f=this;f.storeKey=Ext.getClassName(this);var b=null;var c=f.getModel();if(c!=null){b=c.getMasterEntityType()}if(b!=null&&b!=""){f.masterKey=b;if(e!=null){f.storeKey+="|"+e;f.masterKey=b+"|"+e;var d=new Ext.util.Filter({property:"masterEntityId",value:e});f.addFilter(d)}}if(a!=null){f.storeKey+="|"+a}},findEntity:function(a){if(a.getEntityId()!=null){return this.findRecord("entityId",a.getEntityId(),0,false,true,true)}else{return null}},addFilter:function(a){var b=this;b.data.addFilter(a)},removeFilter:function(a){var b=this;b.data.removeFilters(a)}});Ext.define("Baff.utility.storemanager.EntityStoreManager",{extend:"Ext.Base",requires:["Baff.app.model.EntityModel","Baff.app.model.EntityStore"],stores:null,constructor:function(){this.stores=new Ext.util.MixedCollection()},getStoreKey:function(c,a,b){var e=this;var d=c;if(b!=null){d+="|"+b}if(a!=null){d+="|"+a}return d},destroyStore:function(d,a,c){var f=this;var e=f.getStoreKey(d,a,c);var b=f.stores.get(e);if(b!=null){f.stores.removeAtKey(e);b.destroy()}},getStore:function(d,a,c){var f=this;var e=f.getStoreKey(d,a,c);var b=f.stores.get(e);if(b==null){b=Ext.create(d,{masterEntityId:c,ownerId:a});if(b==null){Utils.logger.error("EntityStoreManager::getStore, failed to create new store")}f.stores.add(e,b)}return b},findMaster:function(c,f){var h=this;var b=h.getMasteringStores(c);var d=Ext.create(c);var a=d.getPrimaryStoreType();if(a!==null){var e=new Ext.util.Filter({property:"storeType",value:a,exactMatch:true});b=b.filter(e)}var g=null;b.each(function(){if(this.getCount()>0){g=this.findRecord("entityId",f,0,false,true,true);if(g!=null){return false}}});return g},getMasteringStores:function(b,e){var f=this;var a=b;var c=true;if(e!=null){a+="|"+e;if(e==""){c=false}}var d=new Ext.util.Filter({property:"masterKey",value:a,exactMatch:c});return f.stores.filter(d)},flushMasteredStores:function(a,c,e){var d=this;if(e==null){e=false}if(c==null){c=""}var b=d.getMasteringStores(a,c);b.each(function(){Utils.logger.info("flushing mastered store = "+this.storeKey);this.flush(e)})},flushMasterStores:function(a){var c=this;var b=c.getMasteringStores(a);b.each(function(){Utils.logger.info("flushing master store = "+this.storeKey);this.flush()})},flushMasteringStores:function(a,b){var c=this;c.flushMasterStores(a);c.flushMasteredStores(a,b)}});Ext.define("Baff.utility.versionmanager.MasterModel",{extend:"Ext.data.Model",config:{fields:[{name:"entityType",type:"string"},{name:"entityId",type:"string"},{name:"versionControl",type:"string"},{name:"data",type:"string"}]},idParam:"entityId",getVersion:function(){return this.get("versionControl")},getData:function(){return this.get("data")}});Ext.define("Baff.utility.versionmanager.MasterStore",{extend:"Ext.data.Store",requires:["Baff.utility.versionmanager.MasterModel"],config:{model:"Baff.utility.versionmanager.MasterModel"},getMaster:function(b,e){var d=this;var a=d.findBy(function(g,f){if(g.get("entityId")==e&&g.get("entityType")==b){return true}else{return false}});if(a>-1){var c=Ext.create(b);c.set(Ext.decode(d.getAt(a).getData()));return c}else{return null}},removeMaster:function(b,d){var c=this;var a=c.findBy(function(f,e){if(f.get("entityId")==d&&f.get("entityType")==b){return true}else{return false}});if(a>-1){Utils.logger.info("MasterStore::removeMaster, removing type: "+b+" ,id: "+d);c.removeAt(a)}},storeMaster:function(d){var c=this;var b=d.getMasterEntityType();var g=d.getEntityId();c.removeMaster(b,g);var a=Ext.create("Baff.utility.versionmanager.MasterModel");a.set("entityId",g);a.set("entityType",b);a.set("versionControl",d.getVersion());var e=d.getData({serialize:true});var f=Ext.encode(e);a.set("data",f);c.add(a);return a},flushMaster:function(c){var d=this;Utils.logger.info("MasterStore::flushMaster, removing type: "+c);var a=[];var b=0;d.each(function(e){if(e.get("entityType")==c){a[b]=e;b++}});d.remove(a)}});Ext.define("Baff.utility.versionmanager.VersionManager",{extend:"Ext.Base",requires:["Baff.utility.storemanager.EntityStoreManager","Baff.utility.versionmanager.MasterStore"],masterStore:null,constructor:function(){this.masterStore=Ext.create("Baff.utility.versionmanager.MasterStore")},getVersion:function(a,d){Utils.logger.info("VersionManager::getVersion");var c=this;if(d==null||a===""||d===""){return}var b=this.getMaster(a,d);if(b!=null){return b.getVersion()}else{return null}},refreshData:function(b,e,d){Utils.logger.info("VersionManager::refreshData");var c=this;if(b!=null&&b!=""){if(d==null){if(e!=null){c.loadMaster(b,e);Utils.entityStoreManager.flushMasterStores(b)}else{c.flushMaster(b);Utils.entityStoreManager.flushMasteringStores(b)}}else{var a=Ext.create(b,d);c.storeMaster(a);Utils.entityStoreManager.flushMasteringStores(b,e)}}},getMaster:function(a,d){Utils.logger.info("VersionManager::getMaster");var c=this;var b=c.masterStore.getMaster(a,d);if(b==null){b=c.setMaster(a,d)}return b},setMaster:function(b,d){Utils.logger.info("VersionManager::setMaster");var c=this;var a=c.getMasterEntityFromPrimaryStore(b,d);if(a==null){c.loadMaster(b,d)}else{c.storeMaster(a)}return a},loadMaster:function(a,d){Utils.logger.info("VersionManager::loadMaster, type= "+a+" ,id= "+d);var b=this;b.masterStore.removeMaster(a,d);var c=null;if(Utils.userSecurityManager!=null){c=Utils.userSecurityManager.getUserName()}Ext.ClassManager.get(a).load(d,{params:{entityId:d,username:c},callback:function(e,f){if(!f.success||f.getRecords().length==0){Utils.logger.info("VersionManager::loadMaster, failed to load master of type= "+a+" ,id= "+d);Utils.entityStoreManager.flushMasteredStores(a,d,true)}else{b.storeMaster(e);Utils.entityStoreManager.flushMasteredStores(a,d)}}})},storeMaster:function(b){Utils.logger.info("VersionManager::storeMaster");var a=this;a.masterStore.storeMaster(b)},flushMaster:function(a){Utils.logger.info("VersionManager::flushMaster");var b=this;b.masterStore.flushMaster(a)},getMasterEntityFromPrimaryStore:function(a,c){Utils.logger.info("VersionManager::getMasterEntityFromPrimaryStore");var b=this;return Utils.entityStoreManager.findMaster(a,c)}});Ext.define("Baff.utility.usersecurity.UserPermissionsStore",{extend:"Ext.data.Store",requires:"Baff.app.model.ServiceProxy",config:{fields:[{name:"permission",type:"string"}],proxy:{type:"serviceproxy",actionMethods:{read:"POST"}}},findUserRole:function(a){return this.find("permission",a)}});Ext.define("Baff.utility.usersecurity.UserSecurityManager",{extend:"Ext.Base",requires:["Baff.utility.usersecurity.UserPermissionsStore"],permissionStore:null,username:null,config:{serviceRootUrl:"/user",defaultPermissions:null},constructor:function(a){this.initConfig(a);this.permissionStore=Ext.create("Baff.utility.usersecurity.UserPermissionsStore")},getUserName:function(){return this.username},logon:function(e,b,a,d){Utils.logger.info("UserSecurityManager::logon");var c=this;c.username=e;c.permissionStore.getProxy().setUrl(this.getServiceRootUrl()+"/permission/findAll.json");c.permissionStore.load({params:{username:e,password:b},callback:function(g,f,h){a(f,h,d)}})},isUserInRole:function(a){Utils.logger.info("UserSecurityManager::isUserInRole");var b=this;var c=false;Ext.Array.each(a,function(e,d){if(b.permissionStore.findUserRole(e)!==-1){c=true;return false}});return c},logoff:function(){Utils.logger.info("UserSecurityManager::isUserInRole");var a=this;Ext.Ajax.request({url:a.getServiceRootUrl()+"/logout.json"});a.permissionStore.removeAll();a.username=null}});Ext.define("Baff.utility.refdata.LocalRefDataProvider",{extend:"Ext.Base",loadRefDataStore:function(a){if(a.getStoreId()==="REF.DATA.NOCLASS"){a.add([{key:"REF.DATA.NULL",code:0,decode:"Not Applicable"}])}}});Ext.define("Baff.utility.refdata.RefDataModel",{extend:"Ext.data.Model",config:{fields:[{name:"key",type:"string"},{name:"code",type:"int"},{name:"decode",type:"string"}]}});Ext.define("Baff.utility.refdata.RefDataManager",{extend:"Ext.Base",requires:["Baff.utility.refdata.RefDataModel"],config:{serviceRootUrl:null},constructor:function(a){this.initConfig(a)},getRefDataStore:function(a){var c=this;var b=Ext.getStore(a);if(b==null){b=c.createRefDataStore(a)}return b},createRefDataStore:function(a){var e=this;var b=Ext.create("Ext.data.Store",{storeId:a,model:Baff.utility.refdata.RefDataModel});if(e.getServiceRootUrl()!=null){var c=e.getServiceRootUrl()+"/find.json";var d=Ext.create("Baff.app.model.ServiceProxy",{url:c});d.setExtraParam("refdataclass",a);b.setProxy(d);b.load()}else{Utils.localRefDataProvider.loadRefDataStore(b)}return b},getCode:function(e,a){var f=this;if(a==null){var d=e.split(".");if(d.length==3){a=d[0]+"."+d[1]}else{Utils.logger.error("Invalid reference data class specified");return null}}else{e=a+"."+e}var c=f.getRefDataStore(a);var b=c.findRecord("key",e);if(b){return b.get("code")}else{Utils.logger.error("Reference data not found - ensure reference data has been loaded, class= "+a+", key= "+e);return null}},getCodeDecodeArray:function(a){var f=this;var g=[],b;var c=f.getRefDataStore(a);var e=c.count();if(e<1){Utils.logger.error("Reference data not found - ensure reference data has been loaded");return null}for(var d=0;d<e;d++){b=c.getAt(d);g[d]=b.data}return g},getDecode:function(e,a){var d=this;var c=d.getRefDataStore(a);var b=c.findRecord("code",e);if(b){return b.get("decode")}else{Utils.logger.error("Reference data not found - ensure reference data has been loaded");return null}}});Ext.define("Baff.utility.Globals",{extend:"Ext.Base",application:null,viewport:null,applicationName:"MyApp",securityServiceRootUrl:"myapp/user",refdataServiceRootUrl:"myapp/refdata",useVersionManager:true,checkVersionOnView:true,setVersionFromMaster:true,autoRefreshOnLock:true,splashScreenDelay:2000,mainView:"mainnavigation",manageUsers:false,defaultPermissions:"myapp.read, myapp.update",defaultUsername:"",defaultPassword:"",logInfo:true,logDebug:true,logError:true,version:"[Development]",constructor:function(a){var b=this;b.version=a.getBuildProperty("$BUILD_VERSION$",b.version)}});Ext.define("Baff.utility.Utilities",{extend:"Ext.Base",alternateClassName:"Utils",singleton:true,requires:["Baff.utility.logger.Logger","Baff.utility.storemanager.EntityStoreManager","Baff.utility.versionmanager.VersionManager","Baff.utility.usersecurity.UserSecurityManager","Baff.utility.refdata.LocalRefDataProvider","Baff.utility.refdata.RefDataManager","Baff.utility.Globals"],entityStoreManager:null,versionManager:null,userSecurityManager:null,refDataManager:null,localRefDataProvider:null,workflowManager:null,logger:null,globals:null,constructor:function(){var a=this;a.globals=Ext.create("Baff.utility.Globals",a);a.entityStoreManager=Ext.create("Baff.utility.storemanager.EntityStoreManager");a.versionManager=Ext.create("Baff.utility.versionmanager.VersionManager");a.userSecurityManager=Ext.create("Baff.utility.usersecurity.UserSecurityManager",{serviceRootUrl:a.globals.securityServiceRootUrl,defaultPermissions:a.globals.defaultPermissions});a.refDataManager=Ext.create("Baff.utility.refdata.RefDataManager",{serviceRootUrl:a.globals.refdataServiceRootUrl});a.localRefDataProvider=Ext.create("Baff.utility.refdata.LocalRefDataProvider");a.logger=Ext.create("Baff.utility.logger.Logger",{enableInfo:a.getBuildProperty("$LOGGER_INFO$",a.globals.logInfo),enableDebug:a.getBuildProperty("$LOGGER_DEBUG$",a.globals.logDebug),enableError:a.getBuildProperty("$LOGGER_ERROR$",a.globals.logError)})},getBuildProperty:function(b,a){if(b[0]=="$"){return a}else{if(b=="true"){return true}else{if(b=="false"){return false}else{return b}}}}});Ext.define("Baff.app.controller.ActivityController",{extend:"Ext.app.Controller",requires:["Baff.utility.Utilities"],alias:"controller.activity",allowRead:true,allowUpdate:true,ID:null,identifier:null,currentRecord:null,entityStore:null,entityModel:null,masterEntityId:null,activityView:null,extMasterEntityId:null,extContext:null,filterContext:null,activeContextFilters:null,isInitialized:false,contextSet:false,dataRefresh:true,refreshButton:null,closeButton:null,isActive:false,OPERATION:{SAVE:"OPERATION_SAVE",REMOVE:"OPERATION_REMOVE",LOAD:"OPERATION_LOAD"},RESULT:{OK:"RESULT_OK",FAIL_SYSTEM_ERROR:"RESULT_FAIL_SYSTEM_ERROR",FAIL_VALIDATION_ERROR:"RESULT_FAIL_VALIDATION_ERROR",FAIL_WARNING:"RESULT_FAIL_WARNING",FAIL_STALE_DATA:"RESULT_FAIL_STALE_DATA"},HTTP_RESPONSE_OK:200,dtLoading:"Please wait....",dtAckTitle:"Acknowledge",dtResponseFailMsg:"Server responded with code: ",dtWarningTitle:"Warning",dtValidationErrorTitle:"Validation Error",dtContinue:" ....Continue ?",dtSystemErrorTitle:"System Error",config:{control:{viewSelector:{initialize:"onViewInit"}},refs:{viewSelector:""},activityId:null,shareStoreId:null,storeOwner:true,storeSelector:"",modelSelector:"",refreshButtonSelector:"",closeButtonSelector:"",readOnly:false,setupOnActivate:true,setupOnLaunch:false,readRoles:null,updateRoles:null,autoRefreshOnLock:null,checkVersionOnView:null,useVersionManager:null,setVersionFromMaster:null,msgAckOptLock:"This data has been updated, please refresh",msgAckOptLockRefresh:"This data has been updated, refreshing...",fireOnMasterChange:true,dependentOnMaster:null,fireOnEntityChange:false,listenForEntityChange:false,contextHandlerMap:null,contextListener:false,contextSetterMap:null,resetOnContextChange:true,dependentOnContext:false,ackSave:false,ackRemove:false,ackSaveMessage:"Save successful",ackRemoveMessage:"Delete successful",defaultSaveActionCode:"SAVE",defaultRemoveActionCode:"REMOVE"},init:function(){var a=this;a.ID=Ext.id(a,"AC");a.identifier=a.self.getName()+"-"+a.ID;a.entityModel=Ext.ClassManager.get(a.getModelSelector());a.extContext=new Ext.util.HashMap();a.filterContext=new Ext.util.HashMap();if(a.getDependentOnMaster()==null){if(a.entityModel.isMasterEntity()){a.setDependentOnMaster(false)}else{a.setDependentOnMaster(true)}}if(a.getUseVersionManager()==null){a.setUseVersionManager(Utils.globals.useVersionManager!=null?Utils.globals.useVersionManager:true)}if(a.getCheckVersionOnView()==null){if(a.entityModel.isMasterEntity()){a.setCheckVersionOnView(true)}else{a.setCheckVersionOnView(Utils.globals.checkVersionOnView!=null?Utils.globals.checkVersionOnView:false)}}if(a.getSetVersionFromMaster()==null){if(a.entityModel.isMasterEntity()){a.setSetVersionFromMaster(false)}else{a.setSetVersionFromMaster(Utils.globals.setVersionFromMaster!=null?Utils.globals.setVersionFromMaster:true)}}if(a.getAutoRefreshOnLock()==null){a.setAutoRefreshOnLock(Utils.globals.autoRefreshOnLock!=null?Utils.globals.autoRefreshOnLock:true)}Utils.logger.info("ActivityController["+this.identifier+"]::init")},onViewInit:function(a){var b=this;Utils.logger.info("ActivityController["+this.identifier+"]::onViewInit");if(a!=b.activityView){b.activityView=a;b.isInitialized=false;b.activityView.setController(b);b.setupAccessRights();b.getApplication().on("afterinit",b.afterInit,b);b.activityView.on("painted",b.afterInit,b)}},afterInit:function(){var a=this;Utils.logger.info("ActivityController["+this.identifier+"]::afterInit");if(!a.isInitialized){a.isInitialized=true;a.addApplicationListeners();a.onLaunch()}},onLaunch:function(){Utils.logger.info("ActivityController["+this.identifier+"]::onLaunch");var b=this;var a=b.getRefreshButtonSelector();if(a===""){a=b.activityView.getRefreshButton()}if(a!==""){b.refreshButton=b.lookupReference(a);b.refreshButton.on("tap",b.onRefreshButton,b)}if(b.getStoreSelector()==""){b.showWidget(b.refreshButton,false)}a=b.getCloseButtonSelector();if(a===""){a=b.activityView.getCloseButton()}if(a!==""){b.closeButton=b.lookupReference(a);b.closeButton.on("tap",b.onCloseButton,b)}b.activityView.on("beforedestroy",b.beforeDestroy,b);if((b.getDependentOnMaster()&&!b.entityModel.isMasterEntity())||(b.getDependentOnContext()&&!b.contextSet)){Utils.logger.info("Disabling view on launch: "+this.identifier);b.activityView.disable()}if(b.getSetupOnLaunch()){b.setup()}},setupAccessRights:function(){Utils.logger.info("ActivityController["+this.identifier+"]::setupAccessRights");var b=this;var a=b.getReadRoles();var c=b.getUpdateRoles();if(a!=null){b.allowRead=Utils.userSecurityManager.isUserInRole(a);b.allowUpdate=false}if(c!=null){b.allowUpdate=Utils.userSecurityManager.isUserInRole(c)}if(b.allowUpdate==true){b.allowRead=true}},manageViewState:function(){Utils.logger.info("ActivityController["+this.identifier+"]::manageViewState");var a=this;if((!a.getDependentOnMaster()||a.isMasterSet())&&(!a.getDependentOnContext()||a.isContextSet())){a.activityView.enable()}else{a.activityView.disable()}},setupAccessControl:function(){Utils.logger.info("ActivityController["+this.identifier+"]:setupAccessControl");var a=this;if(!a.allowUpdate||a.getReadOnly()){if(!a.allowUpdate&&!a.allowRead){Utils.logger.info("ActivityController["+this.identifier+"]:setupAccessControl - access not allowed");a.activityView.disable();a.activityView.hide()}else{Utils.logger.info("ActivityController["+this.identifier+"]:setupAccessControl - read only access");a.makeReadOnly()}}else{a.makeReadOnly(false)}},makeReadOnly:function(a){},onRefreshButton:function(){Utils.logger.info("ActivityController["+this.identifier+"]::onRefreshButton");var a=this;a.refreshCache()},onCloseButton:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onCloseButton");var a=this;if(a.activityView.getPopup()){a.closePopup()}},addApplicationListeners:function(){Utils.logger.info("ActivityController["+this.identifier+"]:addApplicationListeners");var b=this;var a=b.activityView.getParent();if(a!=null&&a.isXType("domainview")){var c=a.getController();if(b.getDependentOnMaster()){a.on("masterentitychange",b.onMasterEntityChange,b)}if(b.entityModel.isMasterEntity()&&b.getFireOnMasterChange()){if(c!=null){b.activityView.on("masterentitychange",c.onMasterEntityChange,c)}}if(b.getListenForEntityChange()){a.on("entitychange",b.onEntityChange,b)}if(b.getFireOnEntityChange()){if(c!=null){b.activityView.on("entitychange",c.onEntityChange,c)}}if(b.getContextHandlerMap()!=null||b.getContextListener()){a.on("contextchange",b.onContextChange,b)}if(b.getContextSetterMap()!=null){if(c!=null){b.activityView.on("contextchange",c.onContextChange,c)}}if(c!=null){b.activityView.on("dataintegrityissue",c.onDataIntegrityIssue,c)}}},beforeDestroy:function(){Utils.logger.info("ActivityController["+this.identifier+"]::beforeDestroy");var a=this;a.detachStore()},onActivateView:function(){Utils.logger.info("ActivityController["+this.identifier+"]::onActivateView");var a=this;a.isActive=true;if(a.getSetupOnActivate()&&!a.activityView.isDisabled()){a.setup(a.extMasterEntityId)}},onDeactivateView:function(){Utils.logger.info("ActivityController["+this.identifier+"]::onDeactivateView");var a=this;a.isActive=false},setup:function(b,a){Utils.logger.info("ActivityController["+this.identifier+"]::setup");var c=this;if(!c.isInitialized){c.afterInit()}if(!c.getDependentOnMaster()){b=c.masterEntityId=null}else{if(b==null){if(a!=null){b=a.getMasterEntityId()}if(b==null){b=c.masterEntityId}if(b==null){if(!c.checkDataIntegrity()){}return}}}if(b!=c.masterEntityId||c.entityStore==null){c.dataRefresh=true;if(b!=c.masterEntityId){c.masterEntityId=b;c.setCurrentRecord(null)}c.setupStore()}if(a!=null&&a!=c.currentRecord){c.dataRefresh=true}if(c.dataRefresh){c.setupAccessControl();if(!c.isAccessAllowed()){return}c.prepareActivity(a);c.refresh(a)}else{if(c.entityStore==null||!c.entityStore.isLoading()){if(c.entityStore!=null&&!c.entityStore.hasLoadedData()){c.refresh(a)}else{if(c.checkDataIntegrity()){if(c.checkVersionOnView(c.currentRecord)){}}c.setCurrentRecord(c.currentRecord)}}}},refreshContextFilters:function(){Utils.logger.info("ActivityController["+this.identifier+"]::refreshContextFilters");var a=this;if(a.entityStore==null){return}if(a.entityStore!=null&&a.activeContextFilters!=null){Ext.Array.each(a.activeContextFilters,function(b){a.entityStore.removeFilter(b)})}a.activeContextFilters=null;if(a.filterContext!=null){a.activeContextFilters=new Array();a.filterContext.each(function(b,d){var c=new Ext.util.Filter({property:b,value:d});a.activeContextFilters.push(c);a.entityStore.addFilter(c)})}},setupStore:function(){Utils.logger.info("ActivityController["+this.identifier+"]::setupStore");var a=this,b;a.detachStore();if(a.getStoreSelector()==""){return}if(a.getDependentOnMaster()&&a.masterEntityId==null){return}if(a.getStoreOwner()){b=a.ID}else{b=a.getSharedStoreId()}a.entityStore=Utils.entityStoreManager.getStore(a.getStoreSelector(),b,a.masterEntityId);if(a.entityStore==null){Utils.logger.error("ActivityController["+this.identifier+"]::setup failed to get store, "+a.getStoreSelector()+" ,owner= "+a.ID+" ,masterid= "+a.masterEntityId);return}a.entityStore.on("postfetch",a.onPostFetch,a);a.entityStore.on("flush",a.onStoreFlush,a);a.entityStore.getProxy().on("exception",a.onLoadException,a)},detachStore:function(){Utils.logger.info("ActivityController["+this.identifier+"]::detachStore");var a=this;if(a.entityStore!=null){if(a.getStoreOwner()){Utils.entityStoreManager.destroyStore(a.getStoreSelector(),a.ID,a.masterEntityId)}else{a.entityStore.un("postfetch",a.onPostFetch,a);a.entityStore.un("flush",a.onStoreFlush,a);a.entityStore.getProxy().un("exception",a.onLoadException,a)}}a.entityStore=null},reset:function(){this.currentRecord=null;this.dataRefresh=true;this.setup(this.extMasterEntityId)},prepareActivity:function(){},refresh:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::refresh");var b=this;b.showWaitMask(true);if(b.getUseVersionManager()&&b.getDependentOnMaster()){if(Utils.versionManager.getMaster(b.entityModel.getMasterEntityType(),b.masterEntityId)==null){return}}b.refreshContextFilters();if(a==null){a=b.currentRecord}b.setCurrentRecord(a);b.dataRefresh=false;if(b.entityStore!=null){b.entityStore.load()}else{b.refreshWithNoStore(a)}},refreshWithNoStore:function(b){var c=this;c.showWaitMask(false);if(c.checkDataIntegrity()==false){return}var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(true,a,null,null)},onStoreFlush:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::onStoreFlush");var b=this;if(b.isActive&&!b.activityView.isDisabled()){if(c==true){b.detachStore();b.refreshWithNoStore()}else{b.refresh()}}else{b.showWaitMask(false)}},onPostFetch:function(b,a,d){Utils.logger.info("ActivityController["+this.identifier+"]::onPostFetch, load state= "+this.isStoreLoaded);var c=this;if(a.message!=null){c.showAlertMessage(c.dtAckTitle,a.message)}if(d){c.onStoreFirstLoaded()}else{c.onStoreFetchMore()}},onStoreFirstLoaded:function(){var b=this;if(b.checkDataIntegrity()){var a=(b.allowUpdate&&!b.isReadOnly);b.prepareView(true,a,null,null)}this.showWaitMask(false)},prepareView:function(c,b,a,d){},onStoreFetchMore:function(){},onLoadException:function(c,b,a){Utils.logger.info("ActivityController["+this.identifier+"]::onLoadException");var d=this;d.doLoadException(b)},doLoadException:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::doLoadException");var d=this;if(d.activityView.isHidden()){return}d.showWaitMask(false);var c;if(a.status!=d.HTTP_RESPONSE_OK){c=d.dtResponseFailMsg+a.status+" ("+a.statusText+")"}else{var b=Ext.decode(a.responseText);c=b.message}d.processSystemFailure(c)},setCurrentRecord:function(b){Utils.logger.info("ActivityController["+this.identifier+"]::setCurrentRecord");var d=this;var c=(d.isActive&&!d.dataRefresh);var a=false;if(d.currentRecord!=b){d.currentRecord=b;c=true;a=true}if(c){d.fireContextEvent(b)}if(a){if(d.entityModel.isMasterEntity()&&d.getFireOnMasterChange()){d.activityView.fireEvent("masterentitychange",d,b,d.entityModel.getName())}if(d.getFireOnEntityChange()){d.activityView.fireEvent("entitychange",d,b,d.entityModel.getName())}}},fireContextEvent:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::fireContextEvent");var c=this;if(c.getContextSetterMap()!=null){var b=new Ext.util.HashMap();Ext.Array.each(c.getContextSetterMap(),function(d){var e=null;if(a!=null){e=a.get(d.fieldName)}b.replace(d.contextMap,e)});c.activityView.fireEvent("contextchange",c,b)}},getCurrentRecord:function(){return this.currentRecord},refreshCache:function(a,d){Utils.logger.info("ActivityController["+this.identifier+"]::refreshCache");var c=this;if(c.entityStore!=null){c.showWaitMask(true)}if(c.getUseVersionManager()){var b=c.getMasterType(a);var e=c.getMasterId(a);Utils.versionManager.refreshData(b,e,d)}else{if(c.entityStore!=null){c.entityStore.flush()}}},checkVersionOnView:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::checkVersionOnView");var b=this;if(b.checkVersion(a)==false){b.processOpLock(a,b.OPERATION.LOAD);return false}return true},checkVersion:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::checkVersion");var d=this;if(a!=null&&d.getUseVersionManager()&&d.getCheckVersionOnView()){var c=a.getVersion();if(c!=null&&c!=""){var f=d.getMasterId(a);var b=d.getMasterType(a);var e=Utils.versionManager.getVersion(b,f);if(e==null){return null}if(c!==e){return false}else{return true}}}return null},checkDataIntegrity:function(){Utils.logger.info("ActivityController["+this.identifier+"]::checkDataIntegrity");var a=this;if(a.getUseVersionManager()&&a.getDependentOnMaster()){if(Utils.versionManager.getMaster(a.entityModel.getMasterEntityType(),a.masterEntityId)==null){Utils.logger.error("ActivityController["+this.identifier+"]::checkDataIntegrity - failed for type= "+a.entityModel.getMasterEntityType()+" , id= "+a.masterEntityId);a.activityView.fireEvent("dataintegrityissue",a);return false}}return true},onMasterEntityChange:function(a,d,b){Utils.logger.info("ActivityController["+this.identifier+"]::onMasterEntityChange");var c=this;if(a==c||!c.getDependentOnMaster()||c.entityModel.getMasterEntityType()!=b){return}if(d==null){c.extMasterEntityId=null}else{c.extMasterEntityId=d.getEntityId()}c.manageViewState();if(c.masterEntityId!=c.extMasterEntityId){c.dataRefresh=true;c.setCurrentRecord(null);if(c.isActive&&!c.activityView.isDisabled()){c.setup(c.extMasterEntityId)}}if(c.isActive&&!c.activityView.isDisabled()){c.setup(c.extMasterEntityId)}},isMasterSet:function(){Utils.logger.info("ActivityController["+this.identifier+"]::isMasterSet");var a=this;return(a.extMasterEntityId!=null)},onEntityChange:function(a,b,c){Utils.logger.info("ActivityController["+this.identifier+"]::onEntityChange");var d=this},onContextChange:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::onContextChange");var d=this;if(d==a){return}var e=d.getContextHandlerMap();var b=false;c.each(function(f,g){d.extContext.replace(f,g);Ext.Array.each(e,function(h){if(f==h.contextMap){if(d.changeContext(h.fieldName,g)){b=true}}})});d.manageViewState();if(b&&d.getResetOnContextChange()){d.dataRefresh=true;d.setCurrentRecord(null);if(d.isActive&&!d.activityView.isDisabled()){d.setup(d.extMasterEntityId)}}},isContextSet:function(){return this.filterContext.getCount()>0},getExternalContext:function(c,b){Utils.logger.info("ActivityController["+this.identifier+"]::getExternalContext");var d=this;if(b){if(d.extContext.containsKey(c)){var a={};a.key=c;a.value=d.extContext.get(c);return a}else{return null}}else{return d.extContext.get(c)}},changeContext:function(e,d){Utils.logger.info("ActivityController["+this.identifier+"]::changeContext");var c=this;var a=false;var b=c.filterContext.get(e);if(d!==null&&d!=""){if(d!=b){c.filterContext.replace(e,d);a=true}}else{if(b!=null){c.filterContext.removeByKey(e);a=true}}return a},prepareRecord:function(c,b){Utils.logger.info("ActivityController["+this.identifier+"]::prepareRecord");var e=this;if(c==e.OPERATION.SAVE){b.setActionCode(e.getDefaultSaveActionCode())}else{if(c==e.OPERATION.REMOVE){b.setActionCode(e.getDefaultRemoveActionCode())}}if(e.getUseVersionManager()&&e.getSetVersionFromMaster()){var f=e.getMasterId(b);var d=e.getMasterType(b);var a=Utils.versionManager.getVersion(d,f);if(a!=null&&b.getVersion()==null){b.setVersion(a)}}if(Utils.userSecurityManager!=null&&Utils.userSecurityManager.getUserName()!=null){b.setParam("username",Utils.userSecurityManager.getUserName())}b.setParam("entityId",b.getEntityId())},saveExec:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::saveExec");var b=this;b.showWaitMask(true);a.save({scope:b,success:b.saveRecordSuccess,failure:b.saveRecordFail},b)},saveRecordSuccess:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::saveRecordSuccess");var d=this;var b=a.getProxy().getResponse();d.saveSuccess(a,b)},saveRecordFail:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::saveRecordFail");var d=this;var b=a.getProxy().getResponse();d.saveFail(a,b,c)},saveSuccess:function(a,b){Utils.logger.info("ActivityController["+this.identifier+"]::saveSuccess");var d=this;d.showWaitMask(false);if(d.getAckSave()||b.message!=null){var c=d.getAckSaveMessage();if(b.message!=null){c=b.message}d.showAlertMessage(d.dtAckTitle,c)}d.setCurrentRecord(a);d.refreshCache(a,b.master)},saveFail:function(a,c,b){Utils.logger.info("ActivityController["+this.identifier+"]::saveFail");var d=this;d.operationFail(this.OPERATION.SAVE,a,c,b)},removeExec:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::removeExec");var b=this;b.showWaitMask(true);a.erase({scope:b,success:b.removeRecordSuccess,failure:b.removeRecordFail},b)},removeRecordSuccess:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::removeRecordSuccess");var d=this;var b=a.getProxy().getResponse();d.removeSuccess(a,b)},removeRecordFail:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::saveRecordFail");var d=this;var b=a.getProxy().getResponse();d.removeFail(a,b,c)},removeSuccess:function(a,b){Utils.logger.info("ActivityController["+this.identifier+"]::removeSuccess");var d=this;d.showWaitMask(false);if(d.getAckRemove()||b.message!=null){var c=d.getAckRemoveMessage();if(b.message!=null){c=b.message}d.showAlertMessage(d.dtAckTitle,c)}d.setCurrentRecord(null);d.refreshCache(a)},removeFail:function(a,c,b){Utils.logger.info("ActivityController["+this.identifier+"]::removeFail");this.operationFail(this.OPERATION.REMOVE,a,c,b)},onRecordUpdate:function(b,a,e){Utils.logger.info("ActivityController["+this.identifier+"]::onRecordUpdate");var d=this;if(d.getUseVersionManager()){var f=d.getMasterId(a);var c=d.getMasterType(a);Utils.versionManager.refreshData(c,f,e)}},operationFail:function(d,a,c,b){Utils.logger.info("ActivityController["+this.identifier+"]::operationFail");var f=this;f.showWaitMask(false);if(c==null||c.resultType==null){var e=f.dtResponseFailMsg+"BEX888";if(b!=null){var g=b.getResponse();if(g!=null&&g.status!=f.HTTP_RESPONSE_OK){e=f.dtResponseFailMsg+g.status+" ("+g.statusText+")"}}f.processSystemFailure(e);return}switch(c.resultType){case f.RESULT.FAIL_VALIDATION_ERROR:f.processValidationError(c,a,d);break;case f.RESULT.FAIL_WARNING:f.processWarning(c,a,d);break;case f.RESULT.FAIL_STALE_DATA:f.processOpLock(a,d);break;default:f.processSystemFailure(c.message)}},processValidationError:function(c,a,b){Utils.logger.info("ActivityController["+this.identifier+"]::processValidationError");var d=this;if(c.message!==null){d.showAlertMessage(d.dtValidationErrorTitle,c.message)}},processWarning:function(c,a,b){Utils.logger.info("ActivityController["+this.identifier+"]::processWarning");var d=this;Ext.Msg.confirm(d.dtWarningTitle,c.message+"</br></br>"+d.dtContinue,function(e){if(e==="yes"){a.setActionCode(c.resultCode);if(b===d.OPERATION.SAVE){d.saveExec(a)}else{if(b===d.OPERATION.REMOVE){d.removeExec(a)}}}})},processOpLock:function(a,b){Utils.logger.info("ActivityController["+this.identifier+"]::processOpLock");var c=this,d;if(!c.procOpLock){c.procOpLock=true;if(c.getAutoRefreshOnLock()){d=c.getMsgAckOptLockRefresh()}else{d=c.getMsgAckOptLock()}c.showAlertMessage(c.dtWarningTitle,d);if(c.getAutoRefreshOnLock()){c.setCurrentRecord(null);c.refreshCache()}c.procOpLock=false}else{if(Utils.globals.application!=null){Utils.globals.application.fireEvent("systemfailure")}}},processSystemFailure:function(b){Utils.logger.info("ActivityController["+this.identifier+"]::processSystemFailure");var a=this;if(b==null||b==""){b=a.dtSystemError}a.showAlertMessage(a.dtSystemErrorTitle,b,function(){if(Utils.globals.application!=null){Utils.globals.application.fireEvent("systemfailure")}})},enableWidget:function(b,a){if(b==null){return}if(a==null||a==true){b.enable()}else{b.disable()}},showWidget:function(b,a){if(b==null){return}if(a==null||a==true){b.show()}else{b.hide()}},isAccessAllowed:function(){return(this.allowRead||this.allowUpdate)},setAccessRights:function(b,a){this.allowRead=false;this.allowUpdate=false;if(b==true){this.allowRead=true;if(a==true){this.allowUpdate=true}}},isDeactivationPromptRequired:function(){return false},showWaitMask:function(a){var b=this;if(a){b.activityView.setMasked({xtype:"loadmask",message:b.dtLoading})}else{b.activityView.setMasked(false)}},showAlertMessage:function(b,a,c){Ext.Msg.alert(b,a,c)},getMasterType:function(a){var c=this;var b=null;if(a!=null){b=a.getMasterEntityType()}if(b==null||b==""){if(c.entityModel!=null){b=c.entityModel.getMasterEntityType()}}if(b==""){b=null}return b},getMasterId:function(a){var b=this;var c=null;if(a!=null){c=a.getMasterEntityId()}if(c==null||c==""){c=b.masterEntityId}if(c==""){c=null}return c},lookupReference:function(a){var b=this;return b.activityView.down("#"+a)},showPopup:function(a,c,b){var e=this;var f=e.activityView.domainController;if(f==null){var d=e.activityView.getParent();if(d!=null&&d.isXType("domainview")){f=d.getController()}}if(f!=null){return f.showPopup(a,c,b)}else{return null}if(c!=null){e.isActive=false}},closePopup:function(){var a=this;if(a.activityView.getPopup()){a.activityView.fireEvent("closepopup",a);Ext.Viewport.animateActiveItem(Ext.Viewport.down("domainview"),{type:"slide",direction:"right"})}}});Ext.define("Baff.app.controller.DomainController",{extend:"Ext.app.Controller",requires:"Baff.utility.Utilities",alias:"controller.entity",allowAccess:true,ID:null,identifier:null,domainView:null,parentView:null,popupView:null,currentMasterEntity:null,currentMasterEntityType:null,currentContext:null,dtNewTitle:"New",dtContinueWithoutSavingMsg:"Continue without saving changes?",dtWorkflowStoppedMsg:"Current workflow will be stopped",dtWorkflowStoppedContinueMsg:"Current workflow will be stopped, continue?",dtLoading:"Please wait....",dtDataIntegrityIssue:"Data integrity issue detected, recovering...",config:{control:{viewSelector:{initialize:"onViewInit"}},refs:{viewSelector:""},tabBarPosition:"bottom",accessRoles:null,titleSelector:null,titleEntity:null,titleLength:25,includeOriginalTitle:true,popupSelector:"",useVersionManager:true,cascadeMasterEntity:false,cascadeContext:true,cascadeEntity:false},init:function(){var a=this;a.ID=Ext.id(this,"DC");a.identifier=a.self.getName()+"-"+a.ID;a.currentContext=new Ext.util.HashMap();Utils.logger.info("DomainController"+this.identifier+"]:init")},onViewInit:function(){var a=this;Utils.logger.info("DomainController["+this.identifier+"]::onViewInit");a.domainView=a.getViewSelector();a.domainView.setController(a);a.setupAccessRights();a.setupAccessControl();a.getApplication().on("afterinit",a.afterInit,a);a.domainView.on("painted",function(){if(!a.isInitialized){var b=a.domainView.getParent();if(b==null||!b.isXType("domainview")){a.getApplication().fireEvent("afterinit")}}},a)},afterInit:function(){var c=this;Utils.logger.info("DomainController["+this.identifier+"]::afterInit");if(c.isInitialized){return}c.isInitialized=true;var b=c.domainView.getParent();if(b!=null&&b.isXType("domainview")){if(c.getCascadeMasterEntity()){b.on("masterentitychange",c.onMasterEntityChange,c)}if(c.getCascadeContext()){b.on("contextchange",c.onContextChange,c)}if(c.getCascadeEntity()){b.on("entitychange",c.onEntityChange,c)}}else{c.activateView(c.domainView)}var a=Ext.ComponentQuery.query("activityview",c.domainView);Ext.Array.each(a,function(d){d.on("deactivate",function(g,f,e){return false})});Ext.Array.each(a,function(d){d.on("activate",c.onTabChange,c)})},setupAccessRights:function(){Utils.logger.info("ActivityController["+this.identifier+"]::setupAccessControl");var b=this;var a=b.getAccessRoles();if(a!=null){b.allowAccess=Utils.userSecurityManager.isUserInRole(a)}},setupAccessControl:function(){Utils.logger.info("DomainController"+this.identifier+"]:setupAccessControl");var a=this;if(!a.allowAccess){a.domainView.disable();a.domainView.hide();Utils.logger.info("DomainController"+this.identifier+"]:setupAccessControl - access not allowed")}a.removeDisallowedChildren("activityview");a.removeDisallowedChildren("domainview")},removeDisallowedChildren:function(a){Utils.logger.info("DomainController"+this.identifier+"]:removeChildren");var c=this;var b=Ext.ComponentQuery.query(a,c.domainView);Ext.Array.each(b,function(e,d){if(!e.getController().isAccessAllowed()||!c.allowAccess){c.domainView.getTabBar().getComponent(d).hide()}})},onDataIntegrityIssue:function(a){Utils.logger.info("DomainController"+this.identifier+"]:onDataIntegrityIssue");var b=this;Ext.Msg.alert(b.dtAckTitle,b.dtDataIntegrityIssue,function(){var c=b.domainView.items.getAt(0);c.getController().reset();b.changeTab(c)})},onActivateView:function(){Utils.logger.info("DomainController"+this.identifier+"]:onActivateView");var a=this;if(a.domainView.getActiveItem()!=null&&a.domainView.getActiveItem().isXType("activityview")){a.setTitleFromRecord(a.currentMasterEntity)}if(a.getPopupSelector()!=""&&a.popupView==null){a.popupView=a.showPopup(a.getPopupSelector(),a.popupView)}else{a.activateView(a.domainView.getActiveItem())}},showPopup:function(e,b,a,c){Utils.logger.info("DomainController"+this.identifier+"]:showPopup");var d=this;if(b==null){b=Ext.widget(e,{popup:true});if(b==null){Utils.logger.error("Failed to instansiate popup");return}if(c!==false){b.on("closepopup",d.onPopupClose,d)}b.getController().detachStore();b.on("masterentitychange",d.onMasterEntityChange,d);b.on("contextchange",d.onContextChange,d)}b.getController().onMasterEntityChange(d,d.currentMasterEntity,d.currentMasterEntityType);b.getController().onContextChange(d,d.currentContext);b.getController().onEntityChange(d,a,a!=null?a.self.getName():null);b.display(d);return b},onPopupClose:function(){Utils.logger.info("DomainController"+this.identifier+"]:onPopupClose");var a=this;if(a.domainView.getActiveItem().isDisabled()){a.domainView.close()}else{a.domainView.getActiveItem().tab.activate(true);a.activateView(a.domainView.getActiveItem())}},onDeactivateView:function(){Utils.logger.info("DomainController"+this.identifier+"]:onDeactivateView");var a=this},activateRelativeView:function(b,a){Utils.logger.info("DomainController"+this.identifier+"]:activateTabToLeft");var e=this;var c=e.domainView.items.findIndex("id",b.id);var d=c+a;if(d>=0){e.domainView.setActiveItem(d);e.activateView(e.domainView.getActiveItem())}},onTabChange:function(d,c,b){Utils.logger.info("DomainController"+this.identifier+"]:onTabChange");var a=this;a.deactivateView(b);a.activateView(d);return true},changeTab:function(c,a){Utils.logger.info("DomainController"+this.identifier+"]::changeTab");var b=this;if(a==null){a=b.domainView.getActiveItem()}c.un("activate",b.onTabChange,b);if(a!=c){b.domainView.setActiveItem(c);b.deactivateView(a)}b.activateView(c);c.on("activate",b.onTabChange,b)},deactivateView:function(a){Utils.logger.info("DomainController"+this.identifier+"]::deactivateView");var c=this;var b=a;while(b!=null&&b.isXType("domainview")){b.getController().onDeactivateView();b=b.getActiveItem()}if(b!=null&&b.isXType("activityview")){b.getController().onDeactivateView()}},activateView:function(a){Utils.logger.info("DomainController"+this.identifier+"]::activateView");var d=this;var b=a;if(b!=null&&b.isXType("domainview")){if(b.isDisabled()){var c=b.getParent();c.items.forEach(function(e){if(e.isXType("domainview")&&!e.isDisabled()){c.getController().changeTab(e,b);return false}});return}b.getController().onActivateView()}else{if(b!=null&&b.isXType("activityview")){if(b.isDisabled()){var c=b.getParent();c.items.forEach(function(e){if(e.isXType("activityview")&&!e.isDisabled()){c.getController().changeTab(e,b);return false}});return}b.getController().onActivateView();Utils.globals.activeView=b}}},onMasterEntityChange:function(b,a,c){Utils.logger.info("DomainController"+this.identifier+"]:onMasterEntityChange");var d=this;d.currentMasterEntity=a;d.currentMasterEntityType=c;d.setTitleFromRecord(a,c);d.domainView.fireEvent("masterentitychange",b,a,c)},onEntityChange:function(b,a,c){Utils.logger.info("DomainController"+this.identifier+"]:onEntityChange");var d=this;d.setTitleFromRecord(a,c);d.domainView.fireEvent("entitychange",b,a,c)},onContextChange:function(a,b){Utils.logger.info("DomainController"+this.identifier+"]:onContextChange");var c=this;b.each(function(d,e){if(e!==null&&e!=""){c.currentContext.replace(d,e)}else{c.currentContext.removeByKey(d)}});c.domainView.fireEvent("contextchange",a,b)},getCurrentContext:function(b){Utils.logger.info("DomainController["+this.identifier+"]::getCurrentContext");var a=this;return a.currentContext.get(b)},setTitleFromRecord:function(d,h){Utils.logger.info("DomainController"+this.identifier+"]:setTitleFromRecord");var g=this;var b=g.getTitleSelector();var c=g.getTitleEntity();var f=g.domainView.down("#titlebar");if(b==null||c==null||c!=h||f==null){return}var j="";if(g.getIncludeOriginalTitle()){j=g.domainView.getTopTitle()+": "}if(d==null){j+=g.dtNewTitle}else{var e=d.get(b);var a=g.getTitleLength();if(e.length>a){e=e.substring(0,a-3)+"..."}else{e=e.substring(0,a)}j+=e}f.setTitle(j)},isAccessAllowed:function(){return this.allowAccess},getDeactivationPrompt:function(b){Utils.logger.info("DomainController"+this.identifier+"]:getDeactivationPrompt");var d=this;var c="";var a=b;if(a==null){a=d.domainView.getActiveItem()}while(a!=null&&!a.isXType("activityview")){a=a.getActiveItem()}if(a!=null&&a.isXType("activityview")&&a.getController().isDeactivationPromptRequired()){c=d.dtContinueWithoutSavingMsg}return c},showView:function(){Utils.logger.info("DomainController"+this.identifier+"]:showView");var c=this;var a=c.domainView;var b=c.domainView.getParent("domainview");while(b!=null&&b,isXType("domainview")){if(a!=b.getActiveItem()){b.getController().changeTab(a,b.getActiveItem())}a=b;b=b.getParent()}},showWaitMask:function(a){var b=this;if(a){b.getView().setLoading(b.dtLoading)}else{b.getView().setLoading(false)}}});Ext.override("Ext.tab.Tab",{focusable:false});Ext.define("Baff.app.controller.FormController",{extend:"Baff.app.controller.ActivityController",requires:["Baff.utility.Utilities"],alias:"controller.form",formPanel:null,addButton:null,saveButton:null,removeButton:null,revertButton:null,recordAction:"",isReadOnly:false,dtConfirmTitle:"Confirm",dtConfirmDelete:"Delete this record?",dtConfirmRevert:"Discard all changes?",config:{createEnabled:true,updateEnabled:true,deleteEnabled:true,viewExistingRecord:true,manageSingleRecord:true,selectFirstRecord:true,formPanelSelector:"",addButtonSelector:"",saveButtonSelector:"",removeButtonSelector:"",revertButtonSelector:"",promptOnDeactivate:true,revertOnDeactivate:false,submitFormUrl:null,setupNewRecordFromContext:false,confirmRemove:false},init:function(){this.callParent(arguments)},onLaunch:function(){Utils.logger.info("FormController["+this.identifier+"]::onLaunch");var b=this,a;b.showWaitMask(true);a=b.getFormPanelSelector();if(a===""){a=b.activityView.getFormPanel()}if(a!==""){b.formPanel=b.lookupReference(a)}else{b.formPanel=Ext.create("Baff.app.view.FormPanel")}b.formPanel.setCleanRecord(true);b.formPanel.on("dirtychange",b.onFormDirtyChange,b);a=b.getAddButtonSelector();if(a===""){a=b.activityView.getAddButton()}if(a!==""){b.addButton=b.lookupReference(a);b.addButton.on("tap",b.onAddButton,b)}a=b.getRemoveButtonSelector();if(a===""){a=b.activityView.getRemoveButton()}if(a!==""){b.removeButton=b.lookupReference(a);b.removeButton.on("tap",b.onRemoveButton,b)}a=b.getSaveButtonSelector();if(a===""){a=b.activityView.getSaveButton()}if(a!==""){b.saveButton=b.lookupReference(a);b.saveButton.on("tap",b.onSaveButton,b)}a=b.getRevertButtonSelector();if(a===""){a=b.activityView.getRevertButton()}if(a!==""){b.revertButton=b.lookupReference(a);b.revertButton.on("tap",b.onRevertButton,b)}b.callParent(arguments)},setupAccessControl:function(){Utils.logger.info("FormController["+this.identifier+"]:setupAccessControl");var a=this;if(!a.allowUpdate||a.getReadOnly()){if(!a.allowRead){Utils.logger.info("FormController["+this.identifier+"]:setupAccessControl - access not allowed");a.activityView.disable();a.activityView.hide()}else{Utils.logger.info("FormController["+this.identifier+"]:setupAccessControl - read only access");a.makeReadOnly()}}else{a.makeReadOnly(false);if(!a.getCreateEnabled()||a.getManageSingleRecord()||!a.getViewExistingRecord()){a.showWidget(a.addButton,false)}if(!a.getUpdateEnabled()&&!a.getCreateEnabled()){a.showWidget(a.saveButton,false);a.showWidget(a.revertButton,false);a.formPanel.makeReadOnlyForAll(true)}if(!a.getDeleteEnabled()||!a.getViewExistingRecord()){a.showWidget(a.removeButton,false)}}},makeReadOnly:function(a){Utils.logger.info("FormController["+this.identifier+"]:makeReadOnly");var b=this;if(a!=false){a=true}var c=b.formPanel.isHidden();b.formPanel.makeReadOnlyForAll(a);b.showWidget(b.removeButton,!a);b.showWidget(b.saveButton,(!a&&!c));b.showWidget(b.revertButton,(!a&&!c));b.showWidget(b.addButton,!a);b.isReadOnly=a},onDeactivateView:function(){Utils.logger.info("FormController["+this.identifier+"]::onDeactivateView");var a=this;if(a.formPanel.isDirty()){if(a.getRevertOnDeactivate()){a.revertRecord()}}a.callParent(arguments)},onFormDirtyChange:function(c,a){var b=this;b.dirtyChange(c,a)},onAddButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onAddButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.addRecord()}})}else{a.addRecord()}},onSaveButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onSaveButton");this.saveRecord()},onRemoveButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onRemoveButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.removeRecord()}})}else{a.removeRecord()}},onRevertButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onRevertButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.revertRecord()}})}else{a.revertRecord()}},onRefreshButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onRefreshButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.setCurrentRecord(null);a.refreshCache()}})}else{a.setCurrentRecord(null);a.refreshCache()}},onStoreFirstLoaded:function(){Utils.logger.info("FormController["+this.identifier+"]::onStoreFirstLoaded");var a=this;if(a.checkDataIntegrity()==false){a.showWaitMask(false);return}if(a.currentRecord==null||!a.getViewExistingRecord()){if(!a.getManageSingleRecord()&&!a.getSelectFirstRecord()){a.onLoadAdd()}else{a.onLoadSelectFirst()}}else{a.onLoadModify()}},onLoadAdd:function(){Utils.logger.info("FormController["+this.identifier+"]::onLoadAdd");var a=this;this.addRecord(true)},onLoadModify:function(){Utils.logger.info("FormController["+this.identifier+"]::onLoadModify");var b=this;var a=b.entityStore.findEntity(b.currentRecord);if(a!=null){b.currentRecord=a;b.modifyRecord(b.currentRecord,true)}else{if(b.checkVersion(b.currentRecord)!=true){Utils.logger.info("FormController["+this.identifier+"]::onLoadModify - reloading record");var c=null;if(Utils.userSecurityManager!=null){c=Utils.userSecurityManager.getUserName()}Ext.ClassManager.get(b.getModelSelector()).load(b.currentRecord.getEntityId(),{params:{entityId:b.currentRecord.getEntityId(),username:c},callback:function(d,e,f){if(!e.success){b.doLoadException(d.getProxy().getResponse())}else{if(e.getRecords().length==0){b.setCurrentRecord(null);b.onStoreFirstLoaded()}else{b.setCurrentRecord(d);b.modifyRecord(b.currentRecord,true)}}}})}else{b.modifyRecord(b.currentRecord,true)}}},onLoadSelectFirst:function(){Utils.logger.info("FormController["+this.identifier+"]::onLoadSelectFirst");this.selectFirstRecord(true)},refreshWithNoStore:function(a){Utils.logger.info("FormController["+this.identifier+"]::refreshWithNoStore");var b=this;if(b.checkDataIntegrity()==false){b.showWaitMask(false);return}if(a!=null){b.modifyRecord(a,true)}else{b.addRecord(true)}},selectFirstRecord:function(c){Utils.logger.info("FormController["+this.identifier+"]::selectFirstRecord");var b=this;if(b.entityStore.getTotalCount()==0){b.addRecord(c)}else{var a=b.entityStore.getAt(0);if(a!=null&&b.getViewExistingRecord()){b.modifyRecord(a,c)}else{b.addRecord(c)}}},dirtyChange:function(c,a){Utils.logger.info("FormController["+this.identifier+"]::dirtyChange, dirty = "+a);var b=this;if(a&&!b.getReadOnly()){b.enableWidget(b.removeButton,false);b.enableWidget(b.revertButton,true);b.enableWidget(b.saveButton,true)}},revertRecord:function(){Utils.logger.info("FormController["+this.identifier+"]::revertRecord, state = "+this.state);var a=this;if(a.currentRecord!=null){a.modifyRecord(a.currentRecord)}else{a.addRecord()}},modifyRecord:function(b,d){Utils.logger.info("FormController["+this.identifier+"]::modifyRecord");var c=this;c.recordAction=c.entityModel.ACTION.UPDATE;c.setCurrentRecord(b);c.loadRecord(b,c.recordAction);c.formPanel.makeReadOnlyForAll(c.isReadOnly||!(c.getUpdateEnabled()));c.enableWidget(c.removeButton,(c.getDeleteEnabled()&&!c.isReadOnly));c.enableWidget(c.addButton,(c.getCreateEnabled()&&!c.isReadOnly));c.enableWidget(c.revertButton,false);c.enableWidget(c.saveButton,false);var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(d==true,a,b,c.recordAction);c.formPanel.setCleanRecord();c.showWaitMask(false);c.checkVersionOnView(b)},addRecord:function(d){Utils.logger.info("FormController["+this.identifier+"]::addRecord");var c=this;c.recordAction=c.entityModel.ACTION.CREATE;c.setCurrentRecord(null);var b=Ext.create(c.entityModel.getName());c.setNewRecordDefaults(b);c.loadRecord(b,c.recordAction);c.formPanel.makeReadOnlyForAll(c.isReadOnly||!(c.getCreateEnabled()));c.enableWidget(c.removeButton,false);c.enableWidget(c.addButton,false);c.enableWidget(c.revertButton,false);c.enableWidget(c.saveButton,false);var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(d==true,a,b,c.recordAction);c.formPanel.setCleanRecord();c.showWaitMask(false)},setNewRecordDefaults:function(a){var b=this;a.setMasterEntityId(b.masterEntityId);if(b.getSetupNewRecordFromContext()&&b.filterContext.getCount()>0){a.set(b.filterContext.map)}},loadRecord:function(a,c){var b=this;b.formPanel.setRecord(a)},setFieldsReadOnly:function(b){var a=this;if(b!=false){b=true}a.formPanel.makeReadOnlyForAll(b);if(b){a.enableWidget(a.removeButton,false)}},saveRecord:function(){Utils.logger.info("FormController["+this.identifier+"]::saveRecord");var a=this;var d=a.formPanel.getRecord();var b=d.copy();a.formPanel.updateRecord(b);var c=a.doValidation(b,d);if(!c){a.formPanel.markInvalid(b.getErrors())}else{a.prepareRecord(a.OPERATION.SAVE,b);a.saveExec(b)}},removeRecord:function(){Utils.logger.info("FormController["+this.identifier+"]::removeRecord");var a=this;a.recordAction=a.entityModel.ACTION.DELETE;var d=a.formPanel.getRecord();var b=d.copy();var c=a.doValidation(b,d);if(!c){a.formPanel.markInvalid(b.getErrors())}else{if(a.getConfirmRemove()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmDelete,function(e){if(e==="yes"){a.prepareRecord(a.OPERATION.REMOVE,b);a.removeExec(b)}})}else{a.prepareRecord(a.OPERATION.REMOVE,b);a.removeExec(b)}}},doValidation:function(a,e){Utils.logger.info("FormController["+this.identifier+"]::doValidation");var b=this;var d=a.isValid(b.recordAction,e);var c=b.doFeasibilityValidation(a,e);if(d&&c){return true}return false},doFeasibilityValidation:function(a,b){return true},saveExec:function(a){Utils.logger.info("FormController["+this.identifier+"]::saveExec");var b=this;if(b.getSubmitFormUrl()!=null){var c={};c.data=Ext.encode(a.getData());b.formPanel.submit({url:b.getSubmitFormUrl(),success:b.saveFormSuccess,failure:b.saveFormFail,scope:b,clientValidation:false,params:c})}else{b.callParent(arguments)}},saveFormSuccess:function(c,d){Utils.logger.info("FormController["+this.identifier+"]::saveFormSuccess");var b=this;var a=Ext.create(b.getModelSelector());if(d.result.data!=null){a.set(d.result.data)}b.saveSuccess(a,d.result)},saveFormFail:function(d,e){Utils.logger.info("FormController["+this.identifier+"]::saveFormFail");var c=this;var a=Ext.create(c.getModelSelector());var b=null;if(e.result.data!=null){a.set(e.result.data)}c.saveFail(a,e.result)},processValidationError:function(c,a,b){Utils.logger.info("FormController["+this.identifier+"]::processValidationError");var d=this;if(c.message!==null){d.showAlertMessage(d.dtValidationErrorTitle,c.message)}else{d.formPanel.markInvalid(c.errors)}},isDeactivationPromptRequired:function(){Utils.logger.info("FormController["+this.identifier+"]::isDeactivationPromptRequired");var a=this;return(a.getPromptOnDeactivate()&&a.formPanel.isDirty())},doIfClean:function(c,a,b){var d=this;if(b==null){b=d}if(d.formPanel.isDirty()){Ext.Msg.confirm(d.dtConfirmTitle,d.dtConfirmRevert,function(e){if(e==="yes"){Ext.callback(c,b,a)}})}else{Ext.callback(c,b,a)}}});Ext.define("Baff.app.controller.ListFormController",{extend:"Baff.app.controller.FormController",requires:["Baff.utility.Utilities"],alias:"controller.listform",listPanel:null,toggleButton:null,dtTogList:"List",dtTogForm:"View",config:{manageSingleRecord:false,listPanelSelector:"",toggleButtonSelector:"",filterButtonSelector:""},onLaunch:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onLaunch");var b=this,a;a=b.getListPanelSelector();if(a===""){a=b.activityView.getListPanel()}if(a!==""){b.listPanel=b.lookupReference(a);b.listPanel.on("selectionchange",b.onSelectList,b);b.listPanel.on("refreshList",b.onRefreshList,b)}a=b.getToggleButtonSelector();if(a===""){a=b.activityView.getToggleButton()}if(a!==""){b.toggleButton=b.lookupReference(a);b.toggleButton.on("tap",b.onToggleButton,b)}a=b.getFilterButtonSelector();if(a===""){a=b.activityView.getFilterButton()}if(a!==""){b.filterButton=b.lookupReference(a);if(b.filterButton!=null){if(b.listPanel.getFilterPanel()!=""){b.filterButton.on("tap",b.onFilterButton,b)}else{b.filterButton.destroy();b.filterButton=null}}}b.callParent(arguments);b.showWidget(b.formPanel,false);b.showWidget(b.revertButton,false);b.showWidget(b.saveButton,false);b.toggleListFormPanels(b.listPanel.isHidden())},onToggleButton:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onToggleButton");var a=this;a.toggleListFormPanels(a.formPanel.isHidden())},toggleListFormPanels:function(a){Utils.logger.info("ListFormController["+this.identifier+"]::toggleListFormPanels");var b=this;if(a){b.showWidget(b.listPanel,false);b.showWidget(b.filterButton,false);b.showWidget(b.formPanel,true);if(b.getUpdateEnabled()||b.getCreateEnabled()){b.showWidget(b.revertButton,true);b.showWidget(b.saveButton,true)}if(b.toggleButton!=null){b.toggleButton.setIconCls("toglist");b.toggleButton.setText(b.dtTogList)}}else{b.showWidget(b.formPanel,false);b.showWidget(b.listPanel,true);b.showWidget(b.revertButton,false);b.showWidget(b.saveButton,false);b.showWidget(b.filterButton,true);if(b.toggleButton!=null){b.toggleButton.setIconCls("togform");b.toggleButton.setText(b.dtTogForm)}}},onFilterButton:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onFilterButton");var a=this;a.listPanel.onShowSearch()},onRefreshList:function(){this.onRefreshButton()},onSelectList:function(c,a){Utils.logger.info("ListFormController["+this.identifier+"]::onSelectList");var b=this;if(!b.getViewExistingRecord()){return}if(b.currentRecord!=null&&a[0].getEntityId()==b.currentRecord.getEntityId()){return}if(!b.entityStore.hasLoaded){return}if(b.formPanel.isDirty()){Ext.Msg.confirm(b.dtConfirmTitle,b.dtConfirmRevert,function(d){if(d==="yes"){b.modifyRecord(a[0])}else{b.selectCurrentRecord()}})}else{b.modifyRecord(a[0])}},setupStore:function(){Utils.logger.info("ListFormController["+this.identifier+"]::setupStore");var a=this;a.callParent(arguments);if(a.listPanel!=null&&a.entityStore!=null){a.listPanel.setEntityStore(a.entityStore);a.listPanel.updateSearchCount()}},onStoreFirstLoaded:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onStoreFirstLoaded");var a=this;a.callParent(arguments);a.selectCurrentRecord();a.listPanel.updateSearchCount()},onStoreFetchMore:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onStoreFetchMore");var a=this;if(a.listPanel!=null){a.listPanel.updateSearchCount();a.selectCurrentRecord()}},selectCurrentRecord:function(){Utils.logger.info("ListFormController["+this.identifier+"]::selectCurrentRecord");var a=this;a.selectRecord(a.currentRecord)},selectRecord:function(a){Utils.logger.info("ListFormController["+this.identifier+"]::selectRecord");var d=this;if(d.listPanel!=null){if(d.entityStore!=null&&a!=null){var c=d.entityStore.findRecord("entityId",a.getEntityId());if(c!=null){d.listPanel.select(c,false,true);d.checkVersionOnView(c)}else{var b=d.listPanel.getSelection();if(b.length!=1||b[0].getEntityId()!=d.currentRecord.getEntityId()){d.listPanel.deselectAll(true)}}}else{d.listPanel.deselectAll(true)}}},addRecord:function(){Utils.logger.info("ListFormController["+this.identifier+"]::addRecord");var a=this;a.selectRecord(null);a.callParent(arguments)},modifyRecord:function(a){Utils.logger.info("ListFormController["+this.identifier+"]::modifyRecord");var b=this;b.selectRecord(a);b.callParent(arguments)}});Ext.define("Baff.app.controller.SelectorController",{extend:"Baff.app.controller.ActivityController",requires:["Baff.utility.Utilities"],alias:"controller.selector",listPanel:null,addButton:null,selectButton:null,config:{selectFirstRecord:true,listPanelSelector:"",addButtonSelector:"",selectButtonSelector:"",refreshButtonSelector:"",filterButtonSelector:""},onLaunch:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onLaunch");var b=this,a;b.showWaitMask(true);a=b.getListPanelSelector();if(a===""){a=b.activityView.getListPanel()}if(a!==""){b.listPanel=b.lookupReference(a);b.listPanel.on("selectionchange",b.onSelectList,b);b.listPanel.on("refreshList",b.onRefreshList,b)}a=b.getAddButtonSelector();if(a===""){a=b.activityView.getAddButton()}if(a!==""){b.addButton=b.lookupReference(a);b.addButton.on("tap",b.onAddButton,b)}a=b.getSelectButtonSelector();if(a===""){a=b.activityView.getSelectButton()}if(a!==""){b.selectButton=b.lookupReference(a);b.selectButton.on("tap",b.onSelectButton,b)}a=b.getRefreshButtonSelector();if(a===""){a=b.activityView.getRefreshButton()}if(a!==""){b.refreshButton=b.lookupReference(a);b.refreshButton.on("tap",b.onRefreshButton,b)}a=b.getFilterButtonSelector();if(a===""){a=b.activityView.getFilterButton()}if(a!==""){b.filterButton=b.lookupReference(a);if(b.listPanel.getFilterPanel()!=""){b.filterButton.on("tap",b.onFilterButton,b)}else{b.filterButton.destroy()}}b.callParent(arguments)},makeReadOnly:function(){Utils.logger.info("SelectorController["+this.identifier+"]:makeReadOnly");var a=this;a.showWidget(a.addButton,false)},onAddButton:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onAddButton");var a=this;a.setCurrentRecord(null);a.listPanel.deselectAll(true)},onSelectButton:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onSelectButton");var a=this;if(a.activityView.getPopup()){a.closePopup()}},onRefreshList:function(){this.onRefreshButton()},onFilterButton:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onFilterButton");var a=this;a.listPanel.onShowSearch()},onSelectList:function(c,a){Utils.logger.info("SelectorController["+this.identifier+"]::onSelectList");var b=this;var d=a;b.setCurrentRecord(a[0])},setupStore:function(){Utils.logger.info("SelectorController["+this.identifier+"]::setupStore");var a=this;a.callParent(arguments);if(a.listPanel!=null&&a.entityStore!=null){a.listPanel.setEntityStore(a.entityStore);a.listPanel.updateSearchCount()}},onStoreFirstLoaded:function(b){Utils.logger.info("SelectorController["+this.identifier+"]::onStoreFirstLoaded");var c=this;if(c.checkDataIntegrity()==true){if(c.getSelectFirstRecord()){c.selectFirstRecord()}else{c.setCurrentRecord(null);c.selectCurrentRecord()}var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(true,a,null,null);if(c.listPanel!=null){c.listPanel.updateSearchCount()}}c.showWaitMask(false)},onStoreFetchMore:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onStoreFetchMore");var a=this;if(a.listPanel!=null){a.listPanel.updateSearchCount();a.selectCurrentRecord()}},selectFirstRecord:function(){Utils.logger.info("SelectorController["+this.identifier+"]::selectFirstRecord");var b=this,a=null;if(b.entityStore!=null&&b.entityStore.getTotalCount()!=0){a=b.entityStore.getAt(0)}b.setCurrentRecord(a);b.selectRecord(a)},selectCurrentRecord:function(){Utils.logger.info("SelectorController["+this.identifier+"]::selectCurrentRecord");var a=this;a.selectRecord(a.currentRecord)},selectRecord:function(a){Utils.logger.info("SelectorController["+this.identifier+"]::selectRecord");var d=this;if(d.listPanel!=null){if(d.entityStore!=null&&a!=null){var c=d.entityStore.findRecord("entityId",a.getEntityId());if(c!=null){d.listPanel.select(c,false,true);d.enableWidget(d.selectButton,true);d.checkVersionOnView(c)}else{var b=d.listPanel.getSelection();if(b.length!=1||b[0].getEntityId()!=d.currentRecord.getEntityId()){d.listPanel.deselectAll(true)}d.enableWidget(d.selectButton,false)}}else{d.listPanel.deselectAll(true);d.enableWidget(d.selectButton,false)}}}});Ext.define("Baff.app.view.ActivityView",{extend:"Ext.Panel",xtype:"activityview",dtRefresh:"Refresh",dtClose:"Close",config:{topTitle:"",buttonCls:"baff-button",controller:null,refreshButton:"refreshBtn",closeButton:null,layout:{type:"vbox",align:"stretch"},defaults:{flex:1},popup:false,myItems:[]},initialize:function(){var c=this;if(c.getCloseButton()==null){if(c.getPopup()){c.setCloseButton("closeBtn")}else{c.setCloseButton("")}}var b=c.setupDockedItems();var a=c.setupItems();if(c.getTopTitle()!=""){a.push({xtype:"toolbar",docked:"top",itemId:"titlebar",title:c.getTopTitle()})}a.push({xtype:"toolbar",layout:{pack:"center"},docked:"top",items:b});c.add(a);c.callParent(arguments)},setupDockedItems:function(){var b=this;var a=[];if(typeof b.getRefreshButton()=="object"){a.push(b.getRefreshButton());b.setRefreshButton(b.getRefreshButton().itemId)}else{if(b.getRefreshButton()!=""){a.push({xtype:"button",itemId:b.getRefreshButton(),iconCls:"refresh",iconAlign:"top",text:b.dtRefresh,cls:b.getButtonCls()})}}if(typeof b.getCloseButton()=="object"){a.push(b.getCloseButton());b.setCloseButton(b.getCloseButton().itemId)}else{if(b.getCloseButton()!=""){a.push({xtype:"button",itemId:b.getCloseButton(),iconCls:"close",iconAlign:"top",text:b.dtClose,cls:b.getButtonCls()})}}return a},setupItems:function(){var b=this;var a=b.getMyItems();return a},display:function(a){var b=this;b.domainController=a;b.enable();Ext.Viewport.animateActiveItem(b,{type:"slide",direction:"left"});b.getController().onActivateView()}});Ext.define("Baff.app.view.DomainView",{extend:"Ext.tab.Panel",xtype:"domainview",config:{topTitle:"",tabBarPosition:"bottom",controller:null},initialize:function(){var b=this;var a=[];if(b.getTopTitle()!=""){a.push({xtype:"toolbar",docked:"top",itemId:"titlebar",title:b.getTopTitle(),items:b.setupDockedItems()})}b.add(a);b.callParent(arguments)},setupDockedItems:function(){var a=[];return a},doTabChange:function(c,b,j,f,d,g){var e=this;Utils.logger.info("DomainView::doTabChange");if(!e.forcedChange&&!g){var h=e.getActiveItem();var a=e.getController().getDeactivationPrompt(h);if(a!=""){Ext.Msg.confirm("Confirm",a,function(k){if(k=="yes"){e.doTabChange(c,b,j,f,d,true)}});return false}}return e.callParent(arguments)}});Ext.define("Baff.app.view.FilterField",{extend:"Ext.field.Search",xtype:"filterfield",entityStore:null,activeFilter:null,filterFieldName:"filterFieldName not defined",dtLoading:"Please wait....",initialize:function(){var a=this;a.callParent(arguments);a.on("action",a.onSearchClick,a);a.on("clearicontap",a.onClearClick,a)},setEntityStore:function(a){var b=this;b.onClearClick();b.entityStore=a},onClearClick:function(){var c=this,b=c.activeFilter;if(b){c.setValue("");if(c.entityStore){var a=c.getParent().listPanel;if(a!=null){a.incrementFilterCount(-1)}c.entityStore.removeFilter(c.activeFilter);c.showWaitMask(true);c.entityStore.load({callback:function(){c.showWaitMask(false)}})}c.activeFilter=null}},onSearchClick:function(){var b=this,c=b.getValue(),d=b.activeFilter;if(c.length>0){b.activeFilter=new Ext.util.Filter({property:b.filterFieldName,value:"%"+c+"%"});if(b.entityStore){if(d!=null){b.entityStore.removeFilter(d)}else{var a=b.getParent().listPanel;if(a!=null){a.incrementFilterCount(1)}}b.entityStore.addFilter(b.activeFilter);b.showWaitMask(true);b.entityStore.load({callback:function(){b.showWaitMask(false)}})}}else{b.onClearClick()}b.getParent().hide()},showWaitMask:function(a){var b=this;if(a){b.getParent().setMasked({xtype:"loadmask",message:b.dtLoading});b.getParent().setHideOnMaskTap(false)}else{b.getParent().setMasked(false);b.getParent().setHideOnMaskTap(true)}}});Ext.define("Baff.utility.refdata.RefDataComboBox",{extend:"Ext.field.Select",requires:["Baff.utility.refdata.RefDataManager"],xtype:"refdatacombobox",initialKey:null,REF_DATA_NULL:"REF.DATA.NULL",REF_DATA_NOCLASS:"REF.DATA.NOCLASS",config:{refdataClass:"REF.DATA.NOCLASS",defaultKey:"REF.DATA.NULL",valueField:"code",displayField:"decode"},initialize:function(){var a=this;a.callParent(arguments);a.setRefDataClass(a.getRefdataClass(),a.getDefaultKey())},getKey:function(){var d=this;var b=d.REF_DATA_NULL;if(d.getStore()){var c=d.getSubmitValue();var a=d.getStore().findRecord("code",c);if(a){b=a.get("key")}}return b},getCode:function(){var b=this;var a=null;if(b.getStore()!=null){a=b.getSubmitValue()}return a},getSubmitValue:function(){var a=this;return this.getValue()},setRefDataClass:function(a,b){var c=this;c.initialKey=b;c.refdataClass=a;c.setStore(Utils.refDataManager.getRefDataStore(c.refdataClass));if(c.getStore().isLoaded()){c.setValueOnData()}},setValueOnData:function(){var c=this;var a=c.initialKey;if(c.refdataClass===c.REF_DATA_NOCLASS){a=c.REF_DATA_NULL}else{if(!a){a=c.getKey()}}var b=c.isDirty();c.setValue(a);if(!b){c.resetOriginalValue();c.reset()}},setValue:function(d,a){var c=this;if(Ext.isString(d)){if(d==c.REF_DATA_NULL){d=null}else{if(d.split(".").length==3){var b=c.getStore().findRecord("key",d);if(b){d=b.get("code")}else{d=null}}}}c.callParent(arguments)},reset:function(){var a=this;a.setValue(a.originalValue)},applyValue:function(d){var c=this,b=d;c.getOptions();if(b==null){b=0}else{if(b.isModel){return b}}var a=c.getStore().findRecord("code",b);return a}});Ext.define("Baff.utility.refdata.RefDataFilterField",{extend:"Baff.utility.refdata.RefDataComboBox",xtype:"refdatafilter",entityStore:null,activeFilter:null,filterFieldName:"filterFieldName not defined",dtLoading:"Please wait....",config:{ui:"search",clearIcon:true},initialize:function(){var a=this;a.callParent(arguments);a.on("select",a.onSearchClick,a);a.on("clearicontap",a.onClearClick,a)},setEntityStore:function(a){var b=this;b.onClearClick();b.entityStore=a},onClearClick:function(){var d=this,c=d.activeFilter;d.setValue(null);var e=d.getUsePicker();var a=e?d.picker:d.listPanel;if(a){a=a.child(e?"pickerslot":"dataview");a.deselectAll()}if(c){if(d.entityStore){var b=d.getParent().listPanel;if(b!=null){b.incrementFilterCount(-1)}d.entityStore.removeFilter(d.activeFilter);d.showWaitMask(true);d.entityStore.load({callback:function(){d.showWaitMask(false)}})}d.activeFilter=null}},setValue:function(d){var c=this,a=c.getValue(),e=c.activeFilter;c.callParent(arguments);d=c.getValue();if(d!=null&&d!=a){c.activeFilter=new Ext.util.Filter({property:c.filterFieldName,value:d});if(c.entityStore){if(e!=null){c.entityStore.removeFilter(e)}else{var b=c.getParent().listPanel;if(b!=null){b.incrementFilterCount(1)}}c.entityStore.addFilter(c.activeFilter);c.showWaitMask(true);c.entityStore.load({callback:function(){c.showWaitMask(false)}})}}},showWaitMask:function(a){var b=this;if(a){b.getParent().setMasked({xtype:"loadmask",message:b.dtLoading});b.getParent().setHideOnMaskTap(false)}else{b.getParent().setMasked(false);b.getParent().setHideOnMaskTap(true)}}});Ext.define("Baff.app.view.FilterPanel",{extend:"Ext.form.Panel",xtype:"filterpanel",requires:["Baff.app.view.FilterField","Baff.utility.refdata.RefDataFilterField"],listPanel:null,config:{modal:true,hideOnMaskTap:true,centered:true,scrollable:"vertical",width:300,height:150,layout:"vbox",showAnimation:{type:"popIn",duration:250,easing:"ease-out"},hideAnimation:{type:"popOut",duration:250,easing:"ease-out"}}});Ext.define("Baff.app.view.FormView",{extend:"Baff.app.view.ActivityView",xtype:"formview",requires:["Ext.Toolbar","Baff.app.view.FormPanel"],dtAdd:"Add",dtRemove:"Delete",dtSave:"Save",dtRevert:"Undo",config:{formPanel:"",addButton:"addBtn",removeButton:"removeBtn",saveButton:"saveBtn",revertButton:"revertBtn"},setupDockedItems:function(){var b=this;var a=[];if(typeof b.getRefreshButton()=="object"){a.push(b.getRefreshButton());b.setRefreshButton(b.getRefreshButton().itemId)}else{if(b.getRefreshButton()!=""){a.push({xtype:"button",itemId:b.getRefreshButton(),iconCls:"refresh",iconAlign:"top",text:b.dtRefresh,cls:b.getButtonCls()})}}if(typeof b.getAddButton()=="object"){a.push(b.getAddButton());b.setAddButton(b.getAddButton().itemId)}else{if(b.getAddButton()!=""){a.push({xtype:"button",itemId:b.getAddButton(),iconCls:"add",iconAlign:"top",text:b.dtAdd,cls:b.getButtonCls()})}}if(typeof b.getRemoveButton()=="object"){a.push(b.getRemoveButton());b.setRemoveButton(b.getRemoveButton().itemId)}else{if(b.getRemoveButton()!=""){a.push({xtype:"button",itemId:b.getRemoveButton(),iconCls:"remove",iconAlign:"top",text:b.dtRemove,cls:b.getButtonCls()})}}if(typeof b.getRevertButton()=="object"){a.push(b.getRevertButton());b.getRevertButton(b.getRevertButton().itemId)}else{if(b.getRevertButton()!=""){a.push({xtype:"button",itemId:b.getRevertButton(),iconCls:"undo",iconAlign:"top",text:b.dtRevert,cls:b.getButtonCls()})}}if(typeof b.getSaveButton()=="object"){a.push(b.getSaveButton());b.setSaveButton(b.getSaveButton().itemId)}else{if(b.getSaveButton()!=""){a.push({xtype:"button",itemId:b.getSaveButton(),iconCls:"save",iconAlign:"top",text:b.dtSave,cls:b.getButtonCls()})}}if(typeof b.getCloseButton()=="object"){a.push(b.getCloseButton());b.setCloseButton(b.getCloseButton().itemId)}else{if(b.getCloseButton()!=""){a.push({xtype:"button",itemId:b.getCloseButton(),iconCls:"close",iconAlign:"top",text:b.dtClose,cls:b.getButtonCls()})}}return a},setupItems:function(){var b=this;var a=b.getMyItems();if(b.getFormPanel()!=""){a.push({xtype:b.getFormPanel(),itemId:b.getFormPanel(),flex:5})}return a}});Ext.define("Baff.app.view.LabelSliderField",{extend:"Ext.field.Slider",xtype:"labelsliderfield",initialize:function(){var a=this;a.callParent(arguments);a.on("painted",a.setLabelOnChange,a);a.on("change",a.setLabelOnChange,a);a.on("drag",a.setLabelOnChange,a)},setLabelOnChange:function(){this.setLabel(this.config.label+": ("+this.getValue()+"%)")},reset:function(){var a=this;if(this.originalValue!=null){a.setValue(this.originalValue)}a.setLabelOnChange()}});Ext.define("Baff.app.view.ListPanel",{extend:"Ext.dataview.List",xtype:"listpanel",requires:["Ext.plugin.ListPaging"],filterCount:0,dtRecordsFound:"Records found",dtFiltered:"(filtered)",filterPanel:null,config:{loadingText:"",filterPanel:"",listCount:true,striped:true,plugins:[{type:"listpaging",autoPaging:true,noMoreRecordsText:"",loadMoreText:"More..."}]},initialize:function(){var b=this;var a=[];if(b.getListCount()){a.push({docked:"bottom",height:20,xtype:"toolbar",itemId:"listCount",cls:"baff-toolbar"})}b.add(a);if(b.getFilterPanel()!=""){b.filterPanel=Ext.widget(b.getFilterPanel())}b.callParent(arguments)},onHideSearch:function(){var a=this},onShowSearch:function(){var a=this;if(a.filterPanel.listPanel==null){a.filterPanel.listPanel=a;Ext.Viewport.add(a.filterPanel)}a.filterPanel.show()},beforeDestroy:function(){var c=this;if(c.filterPanel!=null){var b=Ext.ComponentQuery.query("filterfield",c.filterPanel);for(i=0;i<b.length;i++){b[i].onClearClick()}var a=Ext.ComponentQuery.query("refdatafilter",c.filterPanel);for(i=0;i<a.length;i++){a[i].onClearClick()}}return true},setEntityStore:function(a){var e=this,c;if(e.filterPanel!=null){var d=Ext.ComponentQuery.query("filterfield",e.filterPanel);for(c=0;c<d.length;c++){d[c].setEntityStore(a)}var b=Ext.ComponentQuery.query("refdatafilter",e.filterPanel);for(c=0;c<b.length;c++){b[c].setEntityStore(a)}}e.setStore(a)},updateSearchCount:function(){var c=this;var a=c.down("#listCount");var d=c.dtRecordsFound;if(c.filterCount>0){d+=" "+c.dtFiltered}if(a!=null){var b=c.getStore().getTotalCount();if(b==null){b=0}d+=": "+b;a.setTitle(d)}},incrementFilterCount:function(a){var b=this;b.filterCount+=a}});Ext.define("Baff.app.view.ListFormView",{extend:"Baff.app.view.FormView",xtype:"listformview",requires:["Baff.app.view.ListPanel"],dtTogForm:"View",dtFilter:"Filter",config:{listPanel:"",toggleButton:"selectBtn",filterButton:"filterBtn"},setupDockedItems:function(){var b=this;var a=b.callParent(arguments);if(typeof b.getToggleButton()=="object"){a.push(b.getToggleButton());b.setToggleButton(b.getToggleButton().itemId)}else{if(b.getToggleButton()!=""){a.push({xtype:"button",itemId:b.getToggleButton(),iconCls:"togform",iconAlign:"top",text:b.dtTogForm,cls:b.getButtonCls()})}}if(typeof b.getFilterButton()=="object"){a.push(b.getFilterButton());b.setFilterButton(b.getFilterButton().itemId)}else{if(b.config.filterButton!=""){a.unshift({xtype:"button",itemId:b.getFilterButton(),iconCls:"search",iconAlign:"top",text:b.dtFilter,cls:b.getButtonCls()})}}return a},setupItems:function(){var b=this;var a=b.getMyItems();if(b.getListPanel()!=""){a.push({xtype:b.getListPanel(),itemId:b.getListPanel()})}b.callParent(arguments);return a}});Ext.define("Baff.app.view.SelectorView",{extend:"Baff.app.view.ActivityView",xtype:"selectorview",requires:["Ext.Toolbar","Baff.app.view.ListPanel"],dtNone:"None",dtSelect:"Select",dtFilter:"Filter",config:{listPanel:"",addButton:"addBtn",selectButton:null,filterButton:"filterBtn",closeButton:""},initialize:function(){var a=this;if(a.getSelectButton()==null){if(a.getPopup()){a.setSelectButton("selectBtn")}else{a.setSelectButton("")}}a.callParent(arguments)},setupDockedItems:function(){var b=this;var a=[];if(typeof b.getFilterButton()=="object"){a.push(b.getFilterButton());b.setFilterButton(b.getFilterButton().itemId)}else{if(b.config.filterButton!=""){a.push({xtype:"button",itemId:b.getFilterButton(),iconCls:"search",iconAlign:"top",text:b.dtFilter,cls:b.getButtonCls()})}}if(typeof b.getRefreshButton()=="object"){a.push(b.getRefreshButton());b.setRefreshButton(b.getRefreshButton().itemId)}else{if(b.getRefreshButton()!=""){a.push({xtype:"button",itemId:b.getRefreshButton(),iconCls:"refresh",iconAlign:"top",text:b.dtRefresh,cls:b.getButtonCls()})}}if(typeof b.getAddButton()=="object"){a.push(b.getAddButton());b.setAddButton(b.getAddButton().itemId)}else{if(b.getAddButton()!=""){a.push({xtype:"button",itemId:b.getAddButton(),iconCls:"none",iconAlign:"top",text:b.dtNone,cls:b.getButtonCls()})}}if(typeof b.getSelectButton()=="object"){a.push(b.getSelectButton());b.setSelectButton(b.getSelectButton().itemId)}else{if(b.getSelectButton()!=""){a.push({xtype:"button",itemId:b.getSelectButton(),iconCls:"select",iconAlign:"top",text:b.dtSelect,cls:b.getButtonCls()})}}if(typeof b.getCloseButton()=="object"){a.push(b.getCloseButton());b.setCloseButton(b.getCloseButton().itemId)}else{if(b.getCloseButton()!=""){a.push({xtype:"button",itemId:b.getCloseButton(),iconCls:"close",iconAlign:"top",text:b.dtClose,cls:b.getButtonCls()})}}return a},setupItems:function(){var b=this;var a=b.getMyItems();if(b.getListPanel()!=""){a.push({xtype:b.getListPanel(),itemId:b.getListPanel()})}return a}});Ext.define("Baff.utility.application.LogonWindow",{extend:"Ext.Panel",alias:"widget.logonwindow",requires:["Baff.utility.Utilities"],closable:false,bodyPadding:"10 10 0 10",dtLogonTitle:"Logon",dtLogonBtn:"Logon",dtUserName:"User Name",dtPassword:"Password",dtVersion:"Version",buttonAlign:"center",config:{layout:{type:"vbox",align:"stretch"},defaults:{flex:1},centered:true,width:350,height:200},initialize:function(){var a=this;a.add([{xtype:"toolbar",docked:"top",itemId:"titlebar",title:Utils.globals.applicationName+" "+a.dtLogonTitle},{xtype:"textfield",label:a.dtUserName,name:"username",value:Utils.globals.defaultUsername,allowBlank:false,itemId:"username"},{xtype:"textfield",name:"password",label:a.dtPassword,inputType:"password",value:Utils.globals.defaultPassword,allowBlank:false,itemId:"password"},{xtype:"toolbar",layout:{pack:"center"},docked:"bottom",items:[{text:a.dtLogonBtn,itemId:"logonBtn"}]}]);a.callParent(arguments)}});Ext.define("Baff.utility.application.MainApplicationController",{extend:"Ext.app.Controller",alias:"controller.mainapplication",requires:["Ext.MessageBox","Baff.utility.usersecurity.UserSecurityManager"],config:{views:["Baff.utility.application.LogonWindow"],refs:{usernameField:"logonwindow #username",passwordField:"logonwindow #password"},control:{"logonwindow #logonBtn":{tap:"onLogonButton"}}},dtInvalidLogonTitle:"Invalid Logon",dtInvalidLogonMsg:"Please enter a valid username and password",dtConfirmRestartTitle:"Confirm",dtConfirmRestartMsg:"Are you sure you want to restart?",dtFailTitle:"Unrecoverable System Failure",dtRestartMsg:"The application will be now be restarted.<br>Sorry for any inconvenience caused.",dtLoading:"Please wait....",HTTP_REQUEST_OK:200,splashcreen:null,init:function(){Utils.logger.info("MainApplicationController::init");var a=this},onSystemFailure:function(){var a=this;Ext.Msg.alert(a.dtFailTitle,a.dtRestartMsg,function(){Utils.userSecurityManager.logoff();window.location.reload()})},onSystemRestart:function(){var a=this;Ext.Msg.confirm(a.dtConfirmRestartTitle,a.dtConfirmRestartMsg,function(b){if(b==="yes"){Utils.userSecurityManager.logoff();window.location.reload()}})},onLaunch:function(){Utils.logger.info("MainApplicationController::onLaunch");var a=this;Utils.globals.application.on("systemfailure",a.onSystemFailure,a);Utils.globals.application.on("systemrestart",a.onSystemRestart,a);a.logonWindow=Ext.widget("logonwindow");a.logonWindow.enable();Ext.Viewport.add(a.logonWindow);a.logonWindow.show()},onLogonButton:function(){Utils.logger.info("MainApplicationController::onLogonButton");var b=this;b.logonWindow.setMasked({xtype:"loadmask",message:b.dtLoading});var c=b.getUsernameField().getValue();var a=b.getPasswordField().getValue();Utils.userSecurityManager.logon(c,a,b.postLogon,b)},postLogon:function(a,c,b){Utils.logger.info("MainApplicationController::postLogon");b.logonWindow.setMasked(false);if(c){if(Utils.globals.manageUsers){Utils.userSecurityManager.loadUserAttributes(b.getUsernameField().getValue(),b.postGetUserAttributes,b)}b.logonWindow.destroy();Ext.Viewport.add({xtype:Utils.globals.mainView})}else{if(a.getResponse()!=null&&a.getResponse().status==b.HTTP_REQUEST_OK){Ext.Msg.alert(b.dtInvalidLogonTitle,b.dtInvalidLogonMsg)}else{b.onSystemFailure()}}},postGetUserAttributes:function(a,b,d,c){Utils.logger.info("MainApplicationController::postGetUserAttributes");if(!b.success&&(b.getResponse()==null||b.getResponse().status!=c.HTTP_REQUEST_OK)){c.onSystemFailure()}}});