Ext.define("Baff.app.model.EntityModel",{extend:"Ext.data.Model",requires:["Ext.data.validator.Length"],idProperty:"clientId",errorMessages:[],errorFields:[],syncGeneration:0,valid:true,originalRecord:null,dtCannotBeModified:"Cannot be modified",inheritableStatics:{isMasterEntity:function(){return(this.masterEntityType==null||this.masterEntityType==this.getName())},getMasterEntityType:function(){if(this.masterEntityType!=null){return this.masterEntityType}else{return this.getName()}},getEntityIdProperty:function(){return this.entityIdProperty},getMasterEntityIdProperty:function(){return this.masterEntityIdProperty},getPrimaryStoreType:function(){return this.primaryStoreType},getEntityType:function(){return this.getName()},masterEntityType:null,masterEntityIdProperty:null,entityIdProperty:"id",primaryStoreType:null,ACTION:{CREATE:"CREATE",UPDATE:"UPDATE",DELETE:"DELETE"}},fields:[{name:"entityId",type:"string"},{name:"masterEntityId",type:"string",allowNull:true},{name:"currencyControl",type:"string",allowNull:true},{name:"versionControl",type:"string",allowNull:true}],doIntegrityValidation:function(a,b){},getMasterEntityType:function(){return this.self.getMasterEntityType()},isMasterEntity:function(){return this.self.isMasterEntity()},getEntityIdProperty:function(){return this.self.entityIdProperty},getMasterEntityIdProperty:function(){return this.self.masterEntityIdProperty},getPrimaryStoreType:function(){return this.self.primaryStoreType},getEntityType:function(){return this.self.getName()},setEntityId:function(a){this.set("entityId",a);if(this.getEntityIdProperty()!=null){this.set(this.getEntityIdProperty(),a)}},setMasterEntityId:function(a){this.set("masterEntityId",a);if(this.getMasterEntityIdProperty()!=null){this.set(this.getMasterEntityIdProperty(),a)}},getEntityId:function(){var a=this.get("entityId");if((a==null||a=="")&&this.getEntityIdProperty()!=null){a=this.get(this.getEntityIdProperty())}if(a==""){a=null}return a},getMasterEntityId:function(){var a=this.get("masterEntityId");if(a==null&&this.isMasterEntity()){a=this.getEntityId()}if((a==null||a=="")&&this.getMasterEntityIdProperty()!=null){a=this.get(this.getMasterEntityIdProperty())}if(a==""){a=null}return a},setVersion:function(a){this.set("versionControl",a)},getVersion:function(){return this.get("versionControl")},isValid:function(b,c){var a=this;if(a.syncGeneration!==a.generation){a.valid=true;a.syncGeneration=a.generation;a.errorMessages=[];a.errorFields=[];a.originalRecord=c;if(b!=a.self.ACTION.DELETE){var d=a.getValidation();if(d.dirty){Ext.iterate(d.getData(),function(f,e){if(true!==e){this.addError(f,e)}},a)}}a.doIntegrityValidation(b,c)}return a.valid},validateNoChange:function(c,b){var a=this;if(a.originalRecord){if(a.get(c)!=a.originalRecord.get(c)){if(!b){b=a.dtCannotBeModified}a.addSingleError(c,b)}}},addError:function(d,c){var b=this;if(typeof d==="object"){for(var a=0;a<d.length;a++){b.addSingleError(d[a],c)}}else{b.addSingleError(d,c)}},addSingleError:function(c,b){var a=this;if(a.errorFields.indexOf(c)===-1){a.errorFields.push(c);a.errorMessages.push({id:c,msg:b});a.valid=false}},getErrors:function(){var a=this;a.isValid();return a.errorMessages},setActionCode:function(a){this.setParam("actionCode",a)},setParam:function(b,a){this.getProxy().setExtraParam(b,a)}});Ext.define("override.data.Validation",{override:"Ext.data.Validation",getErrors:function(){var a=[];Ext.iterate(this.getData(),function(c,b){if(true!==b){this.push({id:c,msg:b})}},a);return a}});Ext.define("validator.Present",{extend:"Ext.data.validator.Validator",alias:"data.validator.present",validate:function(a){return !Ext.isEmpty(a)||"Must be present"}});Ext.define("validator.RDPresent",{extend:"Ext.data.validator.Validator",alias:"data.validator.rdpresent",validate:function(a){if(Ext.isEmpty(a)||a===0){return"Must be present"}else{return true}}});Ext.define("Baff.utility.logger.Logger",{extend:"Ext.Base",config:{enableInfo:true,enableDebug:true,enableError:true},info:null,debug:null,error:null,constructor:function(a){this.initConfig(a);this.setInfoLogger(this.getEnableInfo());this.setDebugLogger(this.getEnableDebug());this.setErrorLogger(this.getEnableError())},setInfoLogger:function(a){if(typeof console!="undefined"&&a){this.info=Function.prototype.bind.call(console.log,console)}else{this.info=function(){return}}},setDebugLogger:function(a){if(typeof console!="undefined"&&a){this.debug=Function.prototype.bind.call(console.debug,console)}else{this.debug=function(){return}}},setErrorLogger:function(a){if(typeof console!="undefined"&&a){this.error=Function.prototype.bind.call(console.error,console)}else{this.error=function(){return}}}});Ext.define("Baff.app.model.ServiceProxy",{extend:"Ext.data.proxy.Ajax",alias:"proxy.serviceproxy",idParam:"entityId",typeProperty:" ",reader:{type:"json",rootProperty:"data",totalProperty:"total",useSimpleAccessors:true,typeProperty:this.typeProperty},writer:{type:"json",allowSingle:true,encode:true,writeAllFields:true,writeRecordId:false,rootProperty:"data"},getResponse:function(){return this.getReader().rawData}});Ext.define("Baff.app.model.EntityStore",{extend:"Ext.data.BufferedStore",requires:"Baff.app.model.ServiceProxy",model:"Baff.app.model.EntityModel",storeKey:null,masterKey:null,storeType:null,hasLoaded:false,remoteSort:true,remoteFilter:true,isBuffered:true,pageSize:250,masterFilter:null,fieldFilters:null,contextFilters:null,leadingBufferZone:250,trailingBufferZone:1000,purgePageCount:5,config:{masterEntityId:null,ownerId:null},constructor:function(){var a=this;a.callParent(arguments);if(!a.isBuffered){a.setPageSize(999999999);a.setLeadingBufferZone(999999999);a.setTrailingBufferZone(999999999);a.setPurgePageCount(0)}a.fieldFilters=new Ext.util.Collection();a.contextFilters=new Ext.util.Collection();a.storeType=a.self.getName();a.setKeys(a.ownerId,a.getMasterEntityId());if(Utils.userSecurityManager!=null&&Utils.userSecurityManager.getUserName()!=null){a.setParam("username",Utils.userSecurityManager.getUserName())}},setParam:function(c,a){var b=this.getProxy().getExtraParams();if(b.param!=a){this.removeAll();this.getProxy().setExtraParam(c,a)}},load:function(){this.hasLoaded=false;this.callParent(arguments)},onProxyPrefetch:function(a){var b=this;b.callParent(arguments);if(!b.isLoading()&&a.wasSuccessful()){if(!b.isBuffered){b.data.items=b.getRange(0,999999999)}var c=false;if(!b.hasLoaded){b.hasLoaded=true;c=true}b.fireEvent("postfetch",b,b.getProxy().getResponse(),c)}},removeAll:function(){this.hasLoaded=false;this.callParent(arguments)},flush:function(a){this.removeAll();this.fireEvent("flush",this,a)},hasLoadedData:function(){return this.hasLoaded},setKeys:function(a,d){var e=this;e.storeKey=Ext.getClassName(this);var b=null;var c=e.getModel();if(c!=null){b=c.getMasterEntityType()}if(b!=null&&b!=""){e.masterKey="#"+b+"#";if(d!=null){e.storeKey+="|"+d;e.masterKey+="|"+d;e.masterFilter=new Ext.util.Filter({property:"masterEntityId",value:d});e.setAutoFilter(false);e.getFilters().add(e.masterFilter);e.setAutoFilter(true)}}if(a!=null){e.storeKey+="|"+a}},findEntity:function(a){if(a.getEntityId()!=null){return this.findRecord("entityId",a.getEntityId(),0,false,true,true)}else{return null}},addFieldFilter:function(a,c){var b=this;c=(c==null?true:false);b.setAutoFilter(c);b.fieldFilters.add(a);b.getFilters().add(a);b.setAutoFilter(true)},removeFieldFilter:function(a,c){var b=this;c=(c==null?true:false);b.setAutoFilter(c);b.fieldFilters.remove(a);b.getFilters().remove(a);b.setAutoFilter(true)},clearFieldFilters:function(b){var a=this;if(a.fieldFilters.length>0){b=(b==null?false:true);a.setAutoFilter(b);a.removeAll();a.getFilters().remove(a.fieldFilters.items);a.fieldFilters.removeAll();a.setAutoFilter(true)}},getFieldFilterCount:function(){return this.fieldFilters.length},setContextFilters:function(e){var d=this;var c,f=null;var a=true;var g=e!=null?e.length:0;if(d.contextFilters.length!=g){a=false}else{if(e!=null){for(var b=0;b<e.length;b++){c=e[b];f=d.contextFilters.getByKey(c.getId());if(f==null||f.getValue()!=c.getValue()){a=false;break}}}}if(a){return true}else{d.setAutoFilter(false);d.removeAll();if(d.contextFilters.length>0){d.getFilters().remove(d.contextFilters.items)}if(e!=null&&e.length>0){d.getFilters().add(e)}d.contextFilters.removeAll();d.contextFilters.add(e);d.setAutoFilter(true)}return false},onRangeAvailable:function(a){var b=this;if(b.getTotalCount()>0){b.callParent(arguments)}},contains:function(a,b){return false}});Ext.define("Baff.utility.storemanager.EntityStoreManager",{extend:"Ext.Base",requires:["Baff.app.model.EntityModel","Baff.app.model.EntityStore"],stores:null,config:{cacheSize:25},constructor:function(a){this.initConfig(a);this.stores=new Ext.util.MixedCollection()},getStoreKey:function(c,a,b){var e=this;var d=c;if(b!=null){d+="|"+b}if(a!=null){d+="|"+a}return d},detachStore:function(a,b){var c=this;var d=c.stores.get(a.storeKey);if(d!=null){Ext.Array.remove(d.users,b)}c.manageStoreCache()},manageStoreCache:function(){var a=this;if(a.stores.getCount()>a.getCacheSize()){var b=a.stores.findBy(function(d,c){if(d.users.length==0){Utils.logger.debug("Destroying store with key: "+c);a.stores.removeAtKey(c);d.store.destroy();return true}})}},destroyStore:function(c,a,b){var e=this;var d=e.getStoreKey(c,a,b);var f=e.stores.get(d);if(f!=null){e.stores.removeAtKey(d);f.store.destroy()}},getStore:function(e,a,d,c){var g=this;var f=g.getStoreKey(e,a,d);var h=g.stores.get(f);if(h==null){var b=Ext.create(e,{masterEntityId:d,ownerId:a});if(b==null){Utils.logger.error("EntityStoreManager::getStore, failed to create new store");return null}h={};h.store=b;h.users=[c];g.stores.add(f,h)}else{if(!Ext.Array.contains(h.users,c)){h.users.push(c)}}g.manageStoreCache();return h.store},findMaster:function(c,f){var h=this;var b=h.getMasteringStores(c);var d=Ext.create(c);var a=d.getPrimaryStoreType();if(a!==null){var e=new Ext.util.Filter({filterFn:function(j){if(j.store.storeType==a){return true}}});b=b.filter(e)}var g=null;b.each(function(){if(this.store.getCount()>0){g=this.store.findRecord("entityId",f,0,false,true,true);if(g!=null){return false}}});return g},getMasteringStores:function(a,c){var d=this;var e=a.split("#");var b=new Ext.util.Filter({filterFn:function(h){for(var g=0;g<e.length;g++){var f="#"+e[g]+"#";if(c!=null){f+="|"+c;if(h.store.masterKey.indexOf(f)>=0){return true}}else{if(h.store.masterKey.indexOf("|")<0&&h.store.masterKey.indexOf(f)>=0){return true}}}return false}});return d.stores.filter(b)},flushMasteredStores:function(a,c,e){var d=this;if(e==null){e=false}if(c==null){c=""}var b=d.getMasteringStores(a,c);b.each(function(){Utils.logger.info("flushing mastered store = "+this.store.storeKey+" ,masterKey= "+this.store.masterKey);this.store.flush(e)})},flushMasterStores:function(a){var c=this;var b=c.getMasteringStores(a);b.each(function(){Utils.logger.info("flushing master store = "+this.store.storeKey+" ,masterKey= "+this.store.masterKey);this.store.flush()})},flushMasteringStores:function(a,b){var c=this;c.flushMasterStores(a);c.flushMasteredStores(a,b)}});Ext.define("Baff.utility.versionmanager.MasterModel",{extend:"Ext.data.Model",fields:[{name:"entityType",type:"string"},{name:"entityId",type:"string"},{name:"versionControl",type:"string"},{name:"data",type:"string"}],idParam:"entityId",getVersion:function(){return this.get("versionControl")},getData:function(){return this.get("data")}});Ext.define("Baff.utility.versionmanager.MasterStore",{extend:"Ext.data.Store",requires:["Baff.utility.versionmanager.MasterModel"],model:"Baff.utility.versionmanager.MasterModel",getMaster:function(b,e){var d=this;var a=d.findBy(function(g,f){if(g.get("entityId")==e&&g.get("entityType")==b){return true}else{return false}});if(a>-1){var c=Ext.create(b);c.set(Ext.decode(d.getAt(a).getData()));return c}else{return null}},removeMaster:function(b,d){var c=this;var a=c.findBy(function(f,e){if(f.get("entityId")==d&&f.get("entityType")==b){return true}else{return false}});if(a>-1){Utils.logger.info("MasterStore::removeMaster, removing type: "+b+" ,id: "+d);c.removeAt(a)}},storeMaster:function(d){var c=this;var b=d.getMasterEntityType();var g=d.getEntityId();c.removeMaster(b,g);var a=Ext.create("Baff.utility.versionmanager.MasterModel");a.set("entityId",g);a.set("entityType",b);a.set("versionControl",d.getVersion());var e=d.getData({serialize:true});var f=Ext.encode(e);a.set("data",f);c.add(a);return a},flushMaster:function(c){var d=this;Utils.logger.info("MasterStore::flushMaster, removing type: "+c);var a=[];var b=0;d.each(function(e){if(e.get("entityType")==c){a[b]=e;b++}});d.remove(a)}});Ext.define("Baff.utility.versionmanager.VersionManager",{extend:"Ext.Base",mixins:["Ext.mixin.Observable"],requires:["Baff.utility.storemanager.EntityStoreManager","Baff.utility.versionmanager.MasterStore"],masterStore:null,constructor:function(){this.masterStore=Ext.create("Baff.utility.versionmanager.MasterStore")},getVersion:function(a,d){Utils.logger.info("VersionManager::getVersion");var c=this;if(d==null||a===""||d===""){return}var b=this.getMaster(a,d);if(b!=null){return b.getVersion()}else{return null}},refreshData:function(b,e,d){Utils.logger.info("VersionManager::refreshData");var c=this;if(b!=null&&b!=""){if(d==null){if(e!=null){c.loadMaster(b,e);Utils.entityStoreManager.flushMasterStores(b)}else{c.flushMaster(b);Utils.entityStoreManager.flushMasteringStores(b)}}else{var a=Ext.create(b,d);c.storeMaster(a);Utils.entityStoreManager.flushMasteringStores(b,e)}}},getMaster:function(a,d){Utils.logger.info("VersionManager::getMaster");var c=this;if(a==null||d==null){return null}var b=c.masterStore.getMaster(a,d);if(b==null){b=c.setMaster(a,d)}return b},setMaster:function(b,d){Utils.logger.info("VersionManager::setMaster");var c=this;var a=c.getMasterEntityFromPrimaryStore(b,d);if(a==null){c.loadMaster(b,d)}else{c.storeMaster(a)}return a},loadMaster:function(b,e){Utils.logger.info("VersionManager::loadMaster, type= "+b+" ,id= "+e);var c=this;if(Utils.globals.viewport!=null){Utils.globals.viewport.showWaitMask(true,"VM")}c.masterStore.removeMaster(b,e);var a=Ext.create(b,{clientId:e});a.setEntityId(e);var d=(Utils.userSecurityManager!=null?Utils.userSecurityManager.getUserName():"");a.load({scope:c,params:{entityId:e,username:d,actionCode:""},callback:function(f,g){if(!g.success||g.getRecords().length==0){Utils.logger.info("VersionManager::loadMaster, failed to load master of type= "+b+" ,id= "+e);Utils.entityStoreManager.flushMasteredStores(b,e,true);c.fireEvent("masterload",b,e,true)}else{c.storeMaster(f);Utils.entityStoreManager.flushMasteredStores(b,e);c.fireEvent("masterload",b,e,false)}if(Utils.globals.viewport!=null){Utils.globals.viewport.showWaitMask(false,"VM")}}})},storeMaster:function(b){Utils.logger.info("VersionManager::storeMaster");var a=this;a.masterStore.storeMaster(b)},flushMaster:function(a){Utils.logger.info("VersionManager::flushMaster");var b=this;b.masterStore.flushMaster(a)},getMasterEntityFromPrimaryStore:function(a,c){Utils.logger.info("VersionManager::getMasterEntityFromPrimaryStore");var b=this;return Utils.entityStoreManager.findMaster(a,c)}});Ext.define("Baff.utility.usersecurity.UserPermissionsStore",{extend:"Ext.data.Store",requires:"Baff.app.model.ServiceProxy",fields:[{name:"permission",type:"string"}],proxy:{type:"serviceproxy",actionMethods:{read:"POST"}},findUserRole:function(a){return this.find("permission",a)}});Ext.define("Baff.utility.usersecurity.UserAttributes",{extend:"Ext.data.Model",fields:[{name:"username",type:"string"},{name:"displayname",type:"string"},{name:"email",type:"string"}],proxy:{type:"serviceproxy"}});Ext.define("Baff.utility.usersecurity.UserSecurityManager",{extend:"Ext.Base",requires:["Baff.utility.usersecurity.UserPermissionsStore","Baff.utility.usersecurity.UserAttributes"],permissionStore:null,username:null,userAttributes:null,config:{serviceRootUrl:"/user",defaultPermissions:null},constructor:function(a){this.initConfig(a);this.permissionStore=Ext.create("Baff.utility.usersecurity.UserPermissionsStore")},getUserName:function(){return this.username},logon:function(e,b,a,d){Utils.logger.info("UserSecurityManager::logon");var c=this;c.username=e;c.permissionStore.getProxy().setUrl(this.getServiceRootUrl()+"/permission/findAll.json");c.permissionStore.load({params:{username:e,password:b},callback:function(g,f,h){a(f,h,d)}})},isUserInRole:function(a){Utils.logger.info("UserSecurityManager::isUserInRole");var b=this;var c=false;Ext.Array.each(a,function(e,d){if(b.permissionStore.findUserRole(e)!==-1){c=true;return false}});return c},logoff:function(){Utils.logger.info("UserSecurityManager::isUserInRole");var a=this;Ext.Ajax.request({url:a.getServiceRootUrl()+"/logout.json"});a.permissionStore.removeAll();a.username=null},registerUser:function(b,c,d,a,f){Utils.logger.info("UserSecurityManager::registerUser");var e=this;if(d==null){d=this.getDefaultPermissions()}Ext.Ajax.request({url:e.getServiceRootUrl()+"/register.json",params:{email:b,displayname:c,permissions:d},callback:function(h,j,g){a(j,g,f)}})},resetUser:function(b,a,d){Utils.logger.info("UserSecurityManager::resetUser");var c=this;Ext.Ajax.request({url:c.getServiceRootUrl()+"/reset.json",params:{email:b},callback:function(f,g,e){a(g,e,d)}})},updateUser:function(b,c,g,h,d,a,f){Utils.logger.info("UserSecurityManager::register");var e=this;Ext.Ajax.request({url:e.getServiceRootUrl()+"/update.json",params:{email:b,displayname:c,oldPassword:g,newPassword:h,permissions:d},callback:function(k,l,j){a(l,j,f)}})},loadUserAttributes:function(b,a,d){Utils.logger.info("UserSecurityManager::getUserAttributes");var c=this;c.userAttributes=Ext.create("Baff.utility.usersecurity.UserAttributes",{id:b});c.userAttributes.getProxy().setApi({read:c.getServiceRootUrl()+"/find.json"});c.userAttributes.getProxy().setExtraParam("email",b);c.userAttributes.load({scope:c,callback:function(e,f,g){a(e,f,g,d)}})}});Ext.define("Baff.utility.refdata.LocalRefDataProvider",{extend:"Ext.Base",loadRefDataStore:function(a){if(a.getStoreId()==="REF.DATA.NOCLASS"){a.add([{key:"REF.DATA.NULL",code:0,decode:"Not Applicable"}])}}});Ext.define("Baff.utility.refdata.RefDataModel",{extend:"Ext.data.Model",fields:[{name:"key",type:"string"},{name:"code",type:"int"},{name:"decode",type:"string"}]});Ext.define("Baff.utility.refdata.RefDataManager",{extend:"Ext.Base",requires:["Baff.utility.refdata.RefDataModel"],config:{serviceRootUrl:null},constructor:function(a){this.initConfig(a)},getRefDataStore:function(a){var c=this;var b=Ext.getStore(a);if(b==null){b=c.createRefDataStore(a)}return b},createRefDataStore:function(a){var e=this;var b=Ext.create("Ext.data.Store",{storeId:a,model:Baff.utility.refdata.RefDataModel});if(e.getServiceRootUrl()!=null){var c=e.getServiceRootUrl()+"/find.json";var d=Ext.create("Baff.app.model.ServiceProxy",{url:c});d.setExtraParam("refdataclass",a);b.setProxy(d);b.load()}else{Utils.localRefDataProvider.loadRefDataStore(b)}return b},getCode:function(e,a){var f=this;if(a==null){var d=e.split(".");if(d.length==3){a=d[0]+"."+d[1]}else{Utils.logger.error("Invalid reference data class specified");return null}}else{e=a+"."+e}var c=f.getRefDataStore(a);var b=c.findRecord("key",e);if(b){return b.get("code")}else{Utils.logger.error("Reference data not found - ensure reference data has been loaded, class= "+a+", key= "+e);return null}},getCodeDecodeArray:function(a){var f=this;var g=[],b;var c=f.getRefDataStore(a);var e=c.count();if(e<1){Utils.logger.error("Reference data not found - ensure reference data has been loaded");return null}for(var d=0;d<e;d++){b=c.getAt(d);g[d]=b.data}return g},getDecode:function(e,a){var d=this;var c=d.getRefDataStore(a);var b=c.findRecord("code",e);if(b){return b.get("decode")}else{Utils.logger.error("Reference data not found - ensure reference data has been loaded");return null}}});Ext.define("Baff.utility.workflow.WorkflowManager",{extend:"Ext.app.ViewController",alias:"controller.workflow",singleton:true,wfStore:null,wfSelector:null,wfNextButton:null,wfPrevButton:null,wfContext:null,wfChain:null,activeController:null,dtConfirmTitle:"Confirm",dtConfirmStopWorkflow:"Stop the current workflow?",dtNextStep:"Next Step",dtPreviousStep:"Prev Step",dtInfoTitle:"Info",dtFailedMsg:"The current workflow state cannot be resumed.",dtRepeatMsg:"Repeat",dtOrFinish:"or finish ?",dtOrContinue:"or continue workflow ?",dtBtnRepeat:"Repeat",dtBtnFinish:"Finish",dtBtnContinue:"Continue",dtFinishedMsg:"Workflow has been completed.",dtRootName:"Workflows",dtStartInstruction:"Select a workflow to begin.",dtNoWorkflow:"No workflow selected",dtPauseInstruction:"Workflow is paused.",dtResume:"Resume",dtActivityNotAvailableMsg:"The next activity is not yet available.",dtCompleteCurrentMsg:"Please complete the current activity.",init:function(){Utils.logger.info("WorkflowManager::init");var a=this;a.wfStore=Ext.create("Ext.data.TreeStore");a.wfSelector=a.lookupReference("wfSelector");a.wfNextButton=a.lookupReference("wfNextButton");a.wfPrevButton=a.lookupReference("wfPrevButton");a.wfInstruction=a.lookupReference("wfInstruction");a.wfName=a.lookupReference("wfName");a.wfSelector.on("selectionchange",a.onWorkflowSelection,a);a.wfNextButton.on("click",a.onClickNextButton,a);a.wfPrevButton.on("click",a.onClickPrevButton,a);a.setStartState()},onWorkflowSelection:function(a,b){var c=this;if(b!=null&&b.getData().children==null){c.wfSelector.items.each(function(d){if(d.getText()==b.getData().text){d.on("click",c.onClickWorkflowSelector,c)}})}},onClickWorkflowSelector:function(a){var b=this;if(b.wfContext!=null){Ext.Msg.confirm(b.dtConfirmTitle,b.dtConfirmStopWorkflow,function(c){if(c=="yes"){b.startWorkflow()}})}else{b.startWorkflow()}},onClickNextButton:function(){var a=this;a.wfContext.statePrev=false;a.onClickButton()},onClickPrevButton:function(){var a=this;a.wfContext.statePrev=true;a.onClickButton()},onClickButton:function(){var b=this;var a=b.activeController.getDeactivationPrompt(true);if(a!=""){Ext.Msg.confirm(b.dtConfirmTItle,a,function(c){if(c=="yes"){b.nextStep()}})}else{b.nextStep()}},onActiveViewChange:function(c){Utils.logger.info("WorkflowManager::onActiveViewChange");var e=this;var b;if(c.isXType("domainview")){b=c.getController()}else{b=c.findParentByType("domainview").getController()}if(e.wfContext!=null&&!e.processingNextStep&&c!=e.wfContext.activeView){if(e.wfContext.resume!=true){e.setStartState()}else{e.wfContext.context=e.wfContext.controller.getWorkflowContext();e.setPausedState()}}if(b!=e.activeController){e.activeController=b;e.setAvailableWorkflows(b);if(e.wfContext!=null&&!e.wfContext.statePaused){var a=e.wfStore.getRoot();var d=a.findChild("text",e.wfContext.owningView,true);if(d!=null){d=d.findChild("text",e.wfContext.owningWorkflow)}if(d!=null){e.wfSelector.setSelection(d)}}}},startWorkflow:function(){Utils.logger.info("WorkflowManager::startWorkflow");var d=this;d.wfContext={};var c=d.wfSelector.getSelection().getData();d.wfChain=new Array();var b=d.addWfLink(c.text,c.controller);var a=d.wfStore.getNodeById(c.parentId);d.wfContext.owningView=a.getData().text;d.wfContext.owningWorkflow=c.text;d.wfContext.workflow=c.text;d.wfContext.controller=c.controller;d.wfContext.step=null;d.nextStep()},nextStep:function(){Utils.logger.info("WorkflowManager::nextStep");var f=this;f.processingNextStep=true;f.wfNextButton.disable();f.wfPrevButton.disable();var e=f.wfContext.workflow;var c=f.wfContext.step;f.wfNextButton.setText(f.dtNextStep);if(f.wfContext.statePaused){f.wfContext.statePaused=false;f.wfContext.stateResuming=true}f.wfContext.controller.onNextStep(f.wfContext);var b=f.wfContext.stateResuming;f.wfContext.stateResuming=false;if(f.wfContext.workflow==null){Utils.logger.debug("Workflow undefined, stopping");Ext.Msg.alert(f.dtInfoTitle,f.dtFailedMsg);f.setStartState()}else{if(e!=f.wfContext.workflow){Utils.logger.debug("Switching to child workflow....");f.addWfLink(f.wfContext.workflow,f.wfContext.controller);f.wfContext.step=null;f.nextStep();f.wfNextButton.enable()}else{if(f.wfContext.step==null){Utils.logger.debug("Finished current workflow....");if(f.wfContext.replay){var a=f.dtRepeatMsg+" "+f.wfContext.workflow+"</br>";var d;if(f.wfChain.length==1){a+=f.dtOrFinish;d={yes:f.dtBtnRepeat,no:f.dtBtnFinish}}else{a+=f.dtOrContinue;d={yes:f.dtBtnRepeat,no:f.dtBtnContinue}}Ext.Msg.show({title:f.dtConfitmTitle,message:a,buttonText:d,fn:function(g){if(g=="yes"){f.wfContext.step=null;f.nextStep()}else{f.nextContinue(false)}}});return}f.nextContinue(true);return}else{Utils.logger.debug("Continuing with current workflow....");if(f.wfContext.step==c&&!b){Utils.logger.debug("Next step not available....");Ext.Msg.alert(f.dtInfoTitle,f.dtActivityNotAvailableMsg+"</br></br>"+f.dtCompleteCurrentMsg)}f.wfInstruction.update(f.wfContext.instruction);f.wfName.update(f.wfContext.workflow);f.wfNextButton.enable();if(f.wfContext.previous&&f.wfContext.allowPrev){f.wfPrevButton.enable()}else{f.wfPrevButton.disable()}}}}f.processingNextStep=false},nextContinue:function(a){Utils.logger.info("WorkflowManager::nextContinue");var d=this;if(d.wfChain.length>1){var b=d.wfChain.pop();var c=d.wfChain[d.wfChain.length-1];Utils.logger.debug("Finished child workflow "+b.workflow+"  ,returning to parent workflow...."+c.workflow);d.wfContext.workflow=c.workflow;d.wfContext.controller=c.controller;d.wfContext.step=b.workflow;d.nextStep()}else{Utils.logger.debug("Finished worklfow, stopping");if(a){Ext.Msg.alert(d.dtInfoTitle,d.dtFinishedMsg)}d.setStartState()}d.processingNextStep=false},addWfLink:function(d,a){var c=this;var b={};b.workflow=d;b.controller=a;c.wfChain.push(b);return b},setAvailableWorkflows:function(e){Utils.logger.info("WorkflowManager::setAvailableWorkflows");var k=this;var g,o,f,d,h=0,b=null;var l=e.getView();var c=null;while(l!=null&&l.isXType("domainview")){g=l.getController();o=g.getAvailableWorkflows();if(o!=null){var p=false;for(f=0;f<o.length;f++){if(o[f].visible!=false){if(!p){if(b!=null){var n={};n.children=[];n.children[0]=b;b=n;d=1}else{b={};b.children=[];d=0}b.text=g.originalTitle;b.iconCls="workflow";b.controller=g;p=true}b.children[d]={};b.children[d].leaf=true;b.children[d].text=o[f].workflow;b.children[d].iconCls="activity";b.children[d].controller=g;d++}}h++}c=l;l=l.findParentByType("domainview")}var a;if(b!=null){if(b.text==c.getController().originalTitle){a=b}else{a={};a.children=[];a.children[0]=b;h++}}else{a={};a.children=[];h++}if(Utils.globals.dtRootName!=null){a.text=Utils.globals.dtRootName}else{if(Utils.globals.applicationName!=null){a.text=Utils.globals.applicationName}else{a.text=k.dtRootName}}a.iconCls="root";k.wfStore.setRoot(a);k.wfSelector.setStore(k.wfStore);var m=k.wfStore.getRoot();for(f=0;f<h-1;f++){m=m.childNodes[0]}k.wfSelector.setSelection(m)},setStartState:function(){var a=this;a.wfContext=null;a.wfInstruction.update(a.dtStartInstruction);a.wfName.update(a.dtNoWorkflow);a.wfNextButton.setText(a.dtNextStep);a.wfPrevButton.setText(a.dtPreviousStep);a.wfNextButton.disable();a.wfPrevButton.disable()},setPausedState:function(){var a=this;a.wfNextButton.setText(a.dtResume);a.wfInstruction.update(a.dtPauseInstruction);a.wfPrevButton.disable();a.wfContext.statePaused=true},isDeactivationPromptRequired:function(){var a=this;if(a.wfContext!=null&&a.wfContext.resume!=true){return true}else{return false}}});Ext.define("Baff.utility.Globals",{extend:"Ext.Base",application:null,viewport:null,applicationName:"MyApp",storeCacheSize:25,securityServiceRootUrl:"myapp/user",refdataServiceRootUrl:"myapp/refdata",useVersionManager:true,checkVersionOnView:true,setVersionFromMaster:true,autoRefreshOnLock:true,splashScreenDelay:2000,mainView:"mainnavigationview",manageUsers:false,defaultPermissions:"myapp.read, myapp.update",defaultUsername:"",defaultPassword:"",logInfo:true,logDebug:true,logError:true,version:"[Development]",constructor:function(a){var b=this;b.version=a.getBuildProperty("$BUILD_VERSION$",b.version)}});Ext.define("Baff.utility.Utilities",{extend:"Ext.Base",alternateClassName:"Utils",singleton:true,requires:["Baff.utility.logger.Logger","Baff.utility.storemanager.EntityStoreManager","Baff.utility.versionmanager.VersionManager","Baff.utility.usersecurity.UserSecurityManager","Baff.utility.refdata.LocalRefDataProvider","Baff.utility.refdata.RefDataManager","Baff.utility.workflow.WorkflowManager","Baff.utility.Globals"],entityStoreManager:null,versionManager:null,userSecurityManager:null,refDataManager:null,localRefDataProvider:null,workflowManager:null,logger:null,globals:null,constructor:function(){var a=this;a.globals=Ext.create("Baff.utility.Globals",a);a.entityStoreManager=Ext.create("Baff.utility.storemanager.EntityStoreManager",{cacheSize:a.globals.storeCacheSize});a.versionManager=Ext.create("Baff.utility.versionmanager.VersionManager");a.userSecurityManager=Ext.create("Baff.utility.usersecurity.UserSecurityManager",{serviceRootUrl:a.globals.securityServiceRootUrl,defaultPermissions:a.globals.defaultPermissions});a.refDataManager=Ext.create("Baff.utility.refdata.RefDataManager",{serviceRootUrl:a.globals.refdataServiceRootUrl});a.localRefDataProvider=Ext.create("Baff.utility.refdata.LocalRefDataProvider");a.workflowManager=Baff.utility.workflow.WorkflowManager;a.logger=Ext.create("Baff.utility.logger.Logger",{enableInfo:a.getBuildProperty("$LOGGER_INFO$",a.globals.logInfo),enableDebug:a.getBuildProperty("$LOGGER_DEBUG$",a.globals.logDebug),enableError:a.getBuildProperty("$LOGGER_ERROR$",a.globals.logError)})},getBuildProperty:function(b,a){if(b[0]=="$"){return a}else{if(b=="true"){return true}else{if(b=="false"){return false}else{return b}}}}});Ext.define("Baff.app.controller.ActivityController",{extend:"Ext.app.ViewController",requires:["Baff.utility.Utilities"],alias:"controller.activity",allowRead:true,allowUpdate:true,ID:null,identifier:null,currentRecord:null,entityStore:null,entityModel:null,masterEntityId:null,activityView:null,extMasterEntityId:null,extMasterEntity:null,extEntity:null,extContext:null,entityFilter:false,filterContext:null,activeContextFilters:null,dataRefresh:true,refreshButton:null,isActive:false,OPERATION:{SAVE:"OPERATION_SAVE",REMOVE:"OPERATION_REMOVE",LOAD:"OPERATION_LOAD"},RESULT:{OK:"RESULT_OK",FAIL_SYSTEM_ERROR:"RESULT_FAIL_SYSTEM_ERROR",FAIL_VALIDATION_ERROR:"RESULT_FAIL_VALIDATION_ERROR",FAIL_WARNING:"RESULT_FAIL_WARNING",FAIL_STALE_DATA:"RESULT_FAIL_STALE_DATA"},HTTP_RESPONSE_OK:200,dtLoading:"Please wait....",dtAckTitle:"Acknowledge",dtResponseFailMsg:"Server responded with code: ",dtWarningTitle:"Warning",dtValidationErrorTitle:"Validation Error",dtContinue:" ....Continue ?",dtSystemErrorTitle:"System Error",dtSystemError:"A system error has occurred",config:{activityId:null,shareStoreId:null,storeOwner:true,storeSelector:"",modelSelector:"",refreshButtonSelector:"",manageSingleRecord:false,readOnly:false,setupOnActivate:true,setupOnLaunch:false,readRoles:null,updateRoles:null,autoRefreshOnLock:null,checkVersionOnView:null,useVersionManager:null,setVersionFromMaster:null,msgAckOptLock:"This data has been updated, please refresh",msgAckOptLockRefresh:"This data has been updated, refreshing...",fireOnMasterChange:true,dependentOnMaster:null,fireOnEntityChange:false,listenForEntityChange:false,contextHandlerMap:null,contextListener:false,contextSetterMap:null,resetOnContextChange:true,dependentOnContext:false,ackSave:false,ackRemove:false,ackSaveMessage:"Save successful",ackRemoveMessage:"Delete successful",defaultSaveActionCode:"SAVE",defaultRemoveActionCode:"REMOVE"},init:function(){var a=this;a.callParent(arguments);a.ID=Ext.id(a,"AC");a.identifier=a.self.getName()+"-"+a.ID;Utils.logger.info("ActivityController["+this.identifier+"]::init");a.activityView=a.getView();a.entityModel=Ext.ClassManager.get(a.getModelSelector());a.extContext=new Ext.util.HashMap();a.filterContext=new Ext.util.HashMap();if(a.getDependentOnMaster()==null){if(a.entityModel.isMasterEntity()){a.setDependentOnMaster(false)}else{a.setDependentOnMaster(true)}}if(a.getUseVersionManager()==null){a.setUseVersionManager(Utils.globals.useVersionManager!=null?Utils.globals.useVersionManager:true)}if(a.getCheckVersionOnView()==null){if(a.entityModel.isMasterEntity()){a.setCheckVersionOnView(true)}else{a.setCheckVersionOnView(Utils.globals.checkVersionOnView!=null?Utils.globals.checkVersionOnView:false)}}if(a.getSetVersionFromMaster()==null){if(a.entityModel.isMasterEntity()){a.setSetVersionFromMaster(false)}else{a.setSetVersionFromMaster(Utils.globals.setVersionFromMaster!=null?Utils.globals.setVersionFromMaster:true)}}if(a.getAutoRefreshOnLock()==null){a.setAutoRefreshOnLock(Utils.globals.autoRefreshOnLock!=null?Utils.globals.autoRefreshOnLock:true)}a.addApplicationListeners();a.setupAccessRights();this.onLaunch()},onLaunch:function(){Utils.logger.info("ActivityController["+this.identifier+"]::onLaunch");var b=this;var a=b.getRefreshButtonSelector();if(a===""){a=b.activityView.getRefreshButton()}if(a!==""){b.refreshButton=b.lookupReference(a);b.refreshButton.on("click",b.onRefreshButton,b)}if(b.getStoreSelector()==""){b.showWidget(b.refreshButton,false)}if(b.activityView.getDashlet()){b.setReadOnly(true)}b.activityView.on("beforedestroy",b.beforeDestroy,b);b.manageViewState();if(b.getSetupOnLaunch()){b.setup()}},setupAccessRights:function(){Utils.logger.info("ActivityController["+this.identifier+"]::setupAccessRights");var b=this;var a=b.getReadRoles();var c=b.getUpdateRoles();if(a!=null){b.allowRead=Utils.userSecurityManager.isUserInRole(a);b.allowUpdate=false}if(c!=null){b.allowUpdate=Utils.userSecurityManager.isUserInRole(c)}if(b.allowUpdate==true){b.allowRead=true}},manageViewState:function(){Utils.logger.info("ActivityController["+this.identifier+"]::manageViewState");var a=this;if((!a.getDependentOnMaster()||a.isMasterSet())&&(!a.getDependentOnContext()||a.isContextSet())){a.activityView.enable()}else{a.activityView.disable()}},setupAccessControl:function(){Utils.logger.info("ActivityController["+this.identifier+"]:setupAccessControl");var a=this;if(!a.allowUpdate||a.getReadOnly()){if(!a.allowUpdate&&!a.allowRead){Utils.logger.info("ActivityController["+this.identifier+"]:setupAccessControl - access not allowed");a.activityView.disable();a.activityView.hide()}else{Utils.logger.info("ActivityController["+this.identifier+"]:setupAccessControl - read only access");a.makeReadOnly()}}else{a.makeReadOnly(false)}},makeReadOnly:function(a){},addApplicationListeners:function(){Utils.logger.info("ActivityController["+this.identifier+"]:addApplicationListeners");var b=this;var a=b.findParentView();if(a!=null){var c=a.getController();if(b.getDependentOnMaster()){a.on("masterentitychange",b.onMasterEntityChange,b)}if(b.entityModel.isMasterEntity()&&b.getFireOnMasterChange()){if(c!=null){b.activityView.on("masterentitychange",c.onMasterEntityChange,c)}}if(b.getListenForEntityChange()){a.on("entitychange",b.onEntityChange,b)}if(b.getFireOnEntityChange()){if(c!=null){b.activityView.on("entitychange",c.onEntityChange,c)}}if(b.getContextHandlerMap()!=null||b.getContextListener()){a.on("contextchange",b.onContextChange,b)}if(b.getContextSetterMap()!=null){if(c!=null){b.activityView.on("contextchange",c.onContextChange,c)}}}},beforeDestroy:function(){Utils.logger.info("ActivityController["+this.identifier+"]::beforeDestroy");var a=this;a.detachStore()},onActivateView:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::onActivateView");var c=this;c.isActive=true;if(a!==undefined&&arguments.length>0){c.updateEntityFilter(a,true)}if(c.getSetupOnActivate()&&!c.activityView.isDisabled()){var b=(a==null?c.extMasterEntityId:null);c.setup(b,a)}},onDeactivateView:function(){Utils.logger.info("ActivityController["+this.identifier+"]::onDeactivateView");var a=this;a.isActive=false},reset:function(){this.currentRecord=null;this.dataRefresh=true;this.setup(this.extMasterEntityId)},setup:function(b,a){Utils.logger.info("ActivityController["+this.identifier+"]::setup");var c=this;if(!c.getDependentOnMaster()){b=c.masterEntityId=null}else{if(b==null){if(a!=null){b=a.getMasterEntityId()}if(b==null){b=c.masterEntityId}if(b==null){if(!c.checkDataIntegrity()){}return}}}if(b!=c.masterEntityId||c.entityStore==null){c.dataRefresh=true;if(b!=c.masterEntityId){c.masterEntityId=b;c.setCurrentRecord(null)}c.setupStore()}if(a!=null&&a!=c.currentRecord){c.dataRefresh=true}if(c.dataRefresh){c.setupAccessControl();if(!c.isAccessAllowed()){return}c.prepareActivity(a);c.refresh(a)}else{if(c.entityStore==null||!c.entityStore.isLoading()){if(c.entityStore!=null&&!c.entityStore.hasLoadedData()){c.refresh(a)}else{if(c.checkDataIntegrity()){if(c.checkVersionOnView(c.currentRecord)){}}c.setCurrentRecord(c.currentRecord)}}}},setupStore:function(){Utils.logger.info("ActivityController["+this.identifier+"]::setupStore");var a=this,b;a.detachStore();if(a.getStoreSelector()==""){return}if(a.getDependentOnMaster()&&a.masterEntityId==null){return}if(a.getStoreOwner()){b=a.ID}else{b=a.getSharedStoreId()}a.entityStore=Utils.entityStoreManager.getStore(a.getStoreSelector(),b,a.masterEntityId,a.ID);if(a.entityStore==null){Utils.logger.error("ActivityController["+this.identifier+"]::setup failed to get store, "+a.getStoreSelector()+" ,owner= "+a.ID+" ,masterid= "+a.masterEntityId);return}a.entityStore.clearFieldFilters();a.entityStore.on("postfetch",a.onPostFetch,a);a.entityStore.on("flush",a.onStoreFlush,a);a.entityStore.getProxy().on("exception",a.onLoadException,a)},detachStore:function(){Utils.logger.info("ActivityController["+this.identifier+"]::detachStore");var a=this;if(a.entityStore!=null){a.entityStore.un("postfetch",a.onPostFetch,a);a.entityStore.un("flush",a.onStoreFlush,a);a.entityStore.getProxy().un("exception",a.onLoadException,a);Utils.entityStoreManager.detachStore(a.entityStore,a.ID)}a.entityStore=null},prepareActivity:function(a){},refreshContextFilters:function(){Utils.logger.info("ActivityController["+this.identifier+"]::refreshContextFilters");var b=this;if(b.entityStore==null){return}b.activeContextFilters=new Array();if(b.getManageSingleRecord()){var c=false;if(b.currentRecord!=null){c=b.currentRecord.getEntityId();b.updateEntityFilter(b.currentRecord,false)}if(b.entityFilter!=false){c=b.entityFilter}if(c==null){b.detachStore();return}else{if(c!=false){var a=new Ext.util.Filter({property:b.entityModel.getEntityIdProperty(),value:c});b.activeContextFilters.push(a)}}}if(b.filterContext!=null){b.filterContext.each(function(d,f){var e=new Ext.util.Filter({property:d,value:f});b.activeContextFilters.push(e)})}b.entityStore.setContextFilters(b.activeContextFilters)},refresh:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::refresh");var b=this;if(a==null){a=b.currentRecord}b.setCurrentRecord(a);if(b.getUseVersionManager()&&b.getDependentOnMaster()&&b.masterEntityId!=null){if(b.entityStore==null){Utils.versionManager.on("masterload",b.onMasterLoad,b)}if(Utils.versionManager.getMaster(b.entityModel.getMasterEntityType(),b.masterEntityId)==null){return}Utils.versionManager.un("masterload",b.onMasterLoad,b)}b.refreshContextFilters();b.dataRefresh=false;if(b.entityStore!=null){if(b.entityStore.hasLoadedData()){b.onStoreFirstLoaded()}else{b.showWaitMask(true);b.entityStore.load()}}else{b.refreshWithNoStore(a)}},onMasterLoad:function(a,d,c){Utils.logger.info("ActivityController["+this.identifier+"]::onMasterLoad");var b=this;if(b.entityStore==null&&a==b.entityModel.getMasterEntityType()&&d==b.masterEntityId){Utils.versionManager.un("masterload",b.onMasterLoad,b);b.onCacheUpdate(c)}},onStoreFlush:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::onStoreFlush");var b=this;b.onCacheUpdate(c)},onCacheUpdate:function(b){Utils.logger.info("ActivityController["+this.identifier+"]::onCacheUpdate");var a=this;if(a.isActive&&!a.activityView.isDisabled()){if(b==true){a.detachStore();a.refreshWithNoStore()}else{a.refresh()}}else{a.showWaitMask(false)}},refreshWithNoStore:function(b){Utils.logger.info("ActivityController["+this.identifier+"]::refreshWithNoStore");var c=this;c.setCurrentRecord(b);c.showWaitMask(false);if(c.checkDataIntegrity()==false){return}var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(true,a,null,null)},onPostFetch:function(b,a,d){Utils.logger.info("ActivityController["+this.identifier+"]::onPostFetch, load state= "+d);var c=this;if(a.message!=null){c.showAlertMessage(c.dtAckTitle,a.message)}if(d){c.onStoreFirstLoaded()}else{c.onStoreFetchMore()}},onStoreFirstLoaded:function(){var b=this;if(b.checkDataIntegrity()){var a=(b.allowUpdate&&!b.isReadOnly);b.prepareView(true,a,null,null)}this.showWaitMask(false)},prepareView:function(c,b,a,d){},onStoreFetchMore:function(){},onLoadException:function(c,b,a){Utils.logger.info("ActivityController["+this.identifier+"]::onLoadException");var d=this;d.doLoadException(b)},doLoadException:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::doLoadException");var d=this;if(d.activityView.isHidden()){return}d.showWaitMask(false);var c;if(a.status!=d.HTTP_RESPONSE_OK){c=d.dtResponseFailMsg+a.status+" ("+a.statusText+")"}else{var b=Ext.decode(a.responseText);c=b.message}d.processSystemFailure(c)},setCurrentRecord:function(b){Utils.logger.info("ActivityController["+this.identifier+"]::setCurrentRecord");var d=this;var c=(d.isActive&&!d.dataRefresh);var a=false;if(d.currentRecord!=b){d.currentRecord=b;c=true;a=true}if(c){d.fireContextEvent(b)}if(a){if(d.entityModel.isMasterEntity()&&d.getFireOnMasterChange()){d.fireViewEvent("masterentitychange",d,b,d.entityModel.getName())}if(d.getFireOnEntityChange()){d.fireViewEvent("entitychange",d,b,d.entityModel.getName())}}},getCurrentRecord:function(){return this.currentRecord},fireContextEvent:function(a,d){Utils.logger.info("ActivityController["+this.identifier+"]::fireContextEvent");var c=this;if(d==null){d=c.getContextSetterMap()}if(d!=null){var b=new Ext.util.HashMap();Ext.Array.each(d,function(e){var f=null;if(a!=null){f=a.get(e.fieldName)}b.add(e.contextMap,f)});c.fireViewEvent("contextchange",c,b)}},onRefreshButton:function(){Utils.logger.info("ActivityController["+this.identifier+"]::onRefreshButton");var a=this;a.setCurrentRecord(null);a.refreshCache()},refreshCache:function(b,e){Utils.logger.info("ActivityController["+this.identifier+"]::refreshCache");var d=this;var a=false;if(d.entityStore!=null){d.showWaitMask(true)}if(d.getUseVersionManager()){var c=d.getMasterType(b);if(c!=null){var f=d.getMasterId(b);Utils.versionManager.refreshData(c,f,e)}else{if(d.entityStore!=null){d.entityStore.flush()}}}else{if(d.entityStore!=null){d.entityStore.flush()}}if(d.entityStore==null){d.setup()}},checkVersionOnView:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::checkVersionOnView");var b=this;if(b.checkVersion(a)==false){b.processOpLock(a,b.OPERATION.LOAD);return false}return true},checkVersion:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::checkVersion");var d=this;if(a!=null&&d.getUseVersionManager()&&d.getCheckVersionOnView()){var c=a.getVersion();if(c!=null&&c!=""){var f=d.getMasterId(a);var b=d.getMasterType(a);var e=Utils.versionManager.getVersion(b,f);if(e==null){return null}if(c!==e){return false}else{return true}}}return null},checkDataIntegrity:function(){Utils.logger.info("ActivityController["+this.identifier+"]::checkDataIntegrity");var b=this;if(b.getUseVersionManager()&&b.getDependentOnMaster()&&!b.entityModel.isMasterEntity()){if(Utils.versionManager.getMaster(b.entityModel.getMasterEntityType(),b.masterEntityId)==null){Utils.logger.error("ActivityController["+this.identifier+"]::checkDataIntegrity - failed for type= "+b.entityModel.getMasterEntityType()+" , id= "+b.masterEntityId);var a=b.findParentView();a.fireEvent("dataintegrityissue",b);return false}}return true},onMasterEntityChange:function(a,d,b){Utils.logger.info("ActivityController["+this.identifier+"]::onMasterEntityChange");var c=this;if(a==c||!c.getDependentOnMaster()||c.entityModel.getMasterEntityType()!=b){return}if(c.entityModel.getEntityType()==b){c.updateEntityFilter(d,true)}c.extMasterEntity=d;if(d==null){c.extMasterEntityId=null}else{c.extMasterEntityId=d.getEntityId()}c.manageViewState();if(c.masterEntityId!=c.extMasterEntityId){c.dataRefresh=true;c.setCurrentRecord(null);if(c.isActive&&!c.activityView.isDisabled()){c.setup(c.extMasterEntityId)}}},isMasterSet:function(){Utils.logger.info("ActivityController["+this.identifier+"]::isMasterSet");var a=this;return(a.extMasterEntityId!=null)},onEntityChange:function(a,b,c){Utils.logger.info("ActivityController["+this.identifier+"]::onEntityChange");var d=this;d.extEntity=b;if(a!=d&&c==d.entityModel.getEntityType()){d.updateEntityFilter(b,true);if(d.dataRefresh&&d.isActive&&!d.activityView.isDisabled()){d.setup(d.extMasterEntityId,b)}}},updateEntityFilter:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::updateEntityFilter");var d=this;if(d.getManageSingleRecord()&&(c||d.entityFilter!=false)){var b=(a!=null?a.getEntityId():null);var e=(d.currentRecord!=null?d.currentRecord.getEntityId():null);if(d.getDependentOnMaster()){d.extMasterEntityId=(a!=null?a.getMasterEntityId():d.extMasterEntityId)}d.entityFilter=b;if(b!=e||d.masterEntityId!=d.extMasterEntityId){d.dataRefresh=true;d.setCurrentRecord(null);d.manageViewState()}}},onContextChange:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::onContextChange");var d=this;if(d==a){return}var e=d.getContextHandlerMap();var b=false;c.each(function(f,g){d.extContext.add(f,g);Ext.Array.each(e,function(h){if(f==h.contextMap){if(d.changeContext(h.fieldName,g)){b=true}}})});d.manageViewState();if(b&&d.getResetOnContextChange()){d.dataRefresh=true;d.setCurrentRecord(null);if(d.isActive&&!d.activityView.isDisabled()){d.setup(d.extMasterEntityId)}}},isContextSet:function(){return this.filterContext.getCount()>0},getExternalContext:function(c,b){Utils.logger.info("ActivityController["+this.identifier+"]::getExternalContext");var d=this;if(b){if(d.extContext.containsKey(c)){var a={};a.key=c;a.value=d.extContext.get(c);return a}else{return null}}else{return d.extContext.get(c)}},changeContext:function(e,d){Utils.logger.info("ActivityController["+this.identifier+"]::changeContext");var c=this;var a=false;var b=c.filterContext.get(e);if(d!==null&&d!=""){if(d!=b){c.filterContext.add(e,d);a=true}}else{if(b!=null){c.filterContext.removeAtKey(e);a=true}}return a},prepareRecord:function(c,b){Utils.logger.info("ActivityController["+this.identifier+"]::prepareRecord");var e=this;if(c==e.OPERATION.SAVE){b.setActionCode(e.getDefaultSaveActionCode())}else{if(c==e.OPERATION.REMOVE){b.setActionCode(e.getDefaultRemoveActionCode())}}if(e.getUseVersionManager()&&e.getSetVersionFromMaster()){var f=e.getMasterId(b);var d=e.getMasterType(b);var a=Utils.versionManager.getVersion(d,f);if(a!=null&&b.getVersion()==null){b.setVersion(a)}}if(Utils.userSecurityManager!=null&&Utils.userSecurityManager.getUserName()!=null){b.setParam("username",Utils.userSecurityManager.getUserName())}b.setParam("entityId",b.getEntityId())},saveExec:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::saveExec");var b=this;b.showWaitMask(true);a.save({scope:b,success:b.saveRecordSuccess,failure:b.saveRecordFail})},saveRecordSuccess:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::saveRecordSuccess");var d=this;var b=a.getProxy().getResponse();d.saveSuccess(a,b)},saveRecordFail:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::saveRecordFail");var d=this;var b=a.getProxy().getResponse();d.saveFail(a,b,c)},saveSuccess:function(a,b){Utils.logger.info("ActivityController["+this.identifier+"]::saveSuccess");var d=this;d.showWaitMask(false);if(d.getAckSave()||b.message!=null){var c=d.getAckSaveMessage();if(b.message!=null){c=b.message}d.showAlertMessage(d.dtAckTitle,c)}d.setCurrentRecord(a);d.updateEntityFilter(a,false);d.refreshCache(a,b.master)},saveFail:function(a,c,b){Utils.logger.info("ActivityController["+this.identifier+"]::saveFail");var d=this;d.operationFail(this.OPERATION.SAVE,a,c,b)},removeExec:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::removeExec");var b=this;b.showWaitMask(true);a.erase({scope:b,success:b.removeRecordSuccess,failure:b.removeRecordFail})},removeRecordSuccess:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::removeRecordSuccess");var d=this;var b=a.getProxy().getResponse();d.removeSuccess(a,b)},removeRecordFail:function(a,c){Utils.logger.info("ActivityController["+this.identifier+"]::saveRecordFail");var d=this;var b=a.getProxy().getResponse();d.removeFail(a,b,c)},removeSuccess:function(a,b){Utils.logger.info("ActivityController["+this.identifier+"]::removeSuccess");var d=this;d.showWaitMask(false);if(d.getAckRemove()||b.message!=null){var c=d.getAckRemoveMessage();if(b.message!=null){c=b.message}d.showAlertMessage(d.dtAckTitle,c)}d.setCurrentRecord(null);d.updateEntityFilter(null,false);d.refreshCache(a)},removeFail:function(a,c,b){Utils.logger.info("ActivityController["+this.identifier+"]::removeFail");this.operationFail(this.OPERATION.REMOVE,a,c,b)},onRecordUpdate:function(b,a,e){Utils.logger.info("ActivityController["+this.identifier+"]::onRecordUpdate");var d=this;if(d.getUseVersionManager()){var f=d.getMasterId(a);var c=d.getMasterType(a);Utils.versionManager.refreshData(c,f,e)}},operationFail:function(d,a,c,b){Utils.logger.info("ActivityController["+this.identifier+"]::operationFail");var f=this;f.showWaitMask(false);if(c==null||c.resultType==null){var e=f.dtResponseFailMsg+"BEX888";if(b!=null){var g=b.getResponse();if(g!=null&&g.status!=f.HTTP_RESPONSE_OK){e=f.dtResponseFailMsg+g.status+" ("+g.statusText+")"}}f.processSystemFailure(e);return}switch(c.resultType){case f.RESULT.FAIL_VALIDATION_ERROR:f.processValidationError(c,a,d);break;case f.RESULT.FAIL_WARNING:f.processWarning(c,a,d);break;case f.RESULT.FAIL_STALE_DATA:f.processOpLock(a,d);break;default:f.processSystemFailure(c.message)}},processValidationError:function(c,a,b){Utils.logger.info("ActivityController["+this.identifier+"]::processValidationError");var d=this;if(c.message!==null){d.showAlertMessage(d.dtValidationErrorTitle,c.message)}},processWarning:function(c,a,b){Utils.logger.info("ActivityController["+this.identifier+"]::processWarning");var d=this;Ext.Msg.confirm(d.dtWarningTitle,c.message+"</br></br>"+d.dtContinue,function(e){if(e==="yes"){a.setActionCode(c.resultCode);if(b===d.OPERATION.SAVE){d.saveExec(a)}else{if(b===d.OPERATION.REMOVE){d.removeExec(a)}}}})},processOpLock:function(a,b){Utils.logger.info("ActivityController["+this.identifier+"]::processOpLock");var c=this,d;if(!c.procOpLock){c.procOpLock=true;if(c.getAutoRefreshOnLock()){d=c.getMsgAckOptLockRefresh()}else{d=c.getMsgAckOptLock()}c.showAlertMessage(c.dtWarningTitle,d);if(c.getAutoRefreshOnLock()){c.setCurrentRecord(null);c.refreshCache()}c.procOpLock=false}else{if(Utils.globals.application!=null){Utils.globals.application.fireEvent("systemfailure")}}},processSystemFailure:function(b){Utils.logger.info("ActivityController["+this.identifier+"]::processSystemFailure");var a=this;if(b==null||b==""){b=a.dtSystemError}a.showAlertMessage(a.dtSystemErrorTitle,b,function(){if(Utils.globals.application!=null){Utils.globals.application.fireEvent("systemfailure")}})},enableWidget:function(b,a){if(b==null){return}if(a==null||a==true){b.enable()}else{b.disable()}},showWidget:function(b,a){if(b==null){return}if(a==null||a==true){b.show()}else{b.hide()}},showPopup:function(e,b,a){var d=this;var b=null;var f=d.activityView.domainController;if(f==null){var c=d.findParentView();if(c!=null){f=c.getController()}}if(f!=null){b=f.showPopup(e,b,a)}if(b!=null){d.isActive=false}return b},isAccessAllowed:function(){return(this.allowRead||this.allowUpdate)},setAccessRights:function(b,a){this.allowRead=false;this.allowUpdate=false;if(b==true){this.allowRead=true;if(a==true){this.allowUpdate=true}}},isDeactivationPromptRequired:function(){return false},showWaitMask:function(a){var b=this;if(Utils.globals.viewport!=null){Utils.globals.viewport.showWaitMask(a,b.ID)}else{if(a){b.getView().setLoading(b.dtLoading)}else{b.getView().setLoading(false)}}},showAlertMessage:function(b,a,c){if(Utils.globals.viewport!=null){Utils.globals.viewport.showAlertMessage(b,a,c)}else{Ext.Message.alert(b,a,c)}},getMasterType:function(a){var c=this;var b=null;if(a!=null){b=a.getMasterEntityType()}if(b==null||b==""){if(c.entityModel!=null){b=c.entityModel.getMasterEntityType()}}if(b==""){b=null}return b},getMasterId:function(a){var b=this;var c=null;if(a!=null){c=a.getMasterEntityId()}if(c==null||c==""){c=b.masterEntityId}if(c==""){c=null}return c},findParentView:function(){var a=this;return a.activityView.findParentView()}});Ext.define("Baff.app.controller.BaseDomainController",{extend:"Ext.app.ViewController",requires:["Baff.utility.Utilities"],alias:"controller.basedomain",allowAccess:true,ID:null,identifier:null,domainView:null,parentView:null,originalTitle:null,currentMasterEntity:null,currentMasterEntityType:null,currentContext:null,dtLoading:"Please wait....",dtAckTitle:"Acknowledge",dtDataIntegrityIssue:"Data integrity issue detected...",dtContinueWithoutSavingMsg:"Continue without saving changes ?",dtConfirmTitle:"Confirm",config:{accessRoles:null,titleSelector:null,titleEntity:null,titleLength:10,includeOriginalTitle:true,newTitle:"",useVersionManager:true,cascadeMasterEntity:false,cascadeContext:false,cascadeContextFields:null,cascadeEntity:false},init:function(a){var c=this;c.ID=Ext.id(this,"DC");c.identifier=c.self.getName()+"-"+c.ID;Utils.logger.info("BaseDomainController["+this.identifier+"]:init");c.domainView=c.getView();c.originalTitle=c.domainView.getTitle();c.currentContext=new Ext.util.HashMap();c.domainView.on("dataintegrityissue",c.onDataIntegrityIssue,c);c.setupAccessRights();c.setupAccessControl();var b=c.findParentView();if(b!=null){if(c.getCascadeMasterEntity()){b.on("masterentitychange",c.onMasterEntityChange,c)}if(c.getCascadeContext()){b.on("contextchange",c.onContextChange,c)}if(c.getCascadeEntity()){b.on("entitychange",c.onEntityChange,c)}}},manageViewState:function(){},setupAccessRights:function(){Utils.logger.info("BaseDomainController["+this.identifier+"]::setupAccessControl");var b=this;var a=b.getAccessRoles();if(a!=null){b.allowAccess=Utils.userSecurityManager.isUserInRole(a)}},setupAccessControl:function(){Utils.logger.info("BaseDomainController["+this.identifier+"]:setupAccessControl");var a=this;if(!a.allowAccess){a.domainView.disable();a.domainView.hide();Utils.logger.info("BaseDomainController["+this.identifier+"]:setupAccessControl - access not allowed")}a.removeDisallowedChildren("activityview");a.removeDisallowedChildren("domainview")},removeDisallowedChildren:function(a){Utils.logger.info("BaseDomainController["+this.identifier+"]:removeChildren");var c=this;var b=Ext.ComponentQuery.query(a,c.domainView);Ext.Array.each(b,function(e,d){if(!e.getController().isAccessAllowed()||!c.allowAccess){e.hide()}})},onDataIntegrityIssue:function(a){Utils.logger.info("BaseDomainController["+this.identifier+"]:onDataIntegrityIssue");var b=this;Ext.Msg.alert(b.dtAckTitle,b.dtDataIntegrityIssue,function(){if(Utils.globals.application!=null){Utils.globals.application.fireEvent("systemfailure")}})},onMasterEntityChange:function(c,b,d,a){Utils.logger.info("BaseDomainController["+this.identifier+"]:onMasterEntityChange");var e=this;e.currentMasterEntity=b;e.currentMasterEntityType=d;e.setTitleFromRecord(b,d);e.fireViewEvent("masterentitychange",c,b,d,e);e.manageViewState()},onEntityChange:function(c,b,d,a){Utils.logger.info("BaseDomainController["+this.identifier+"]:onEntityChange");var e=this;e.setTitleFromRecord(b,d);e.fireViewEvent("entitychange",c,b,d,e);e.manageViewState()},onContextChange:function(b,d,a){Utils.logger.info("BaseDomainController["+this.identifier+"]:onContextChange");var e=this;var f=null;var c=d;if(a!=null&&e.getCascadeContextFields()!=null){f=e.getCascadeContextFields();c=new Ext.util.HashMap()}d.each(function(g,h){var j=true;if(f!=null){if(Ext.Array.contains(f,g)){c.add(g,h)}else{j=false}}if(j){if(h!==null&&h!=""){e.currentContext.add(g,h)}else{e.currentContext.removeAtKey(g)}}});if(c.getCount()>0){e.fireViewEvent("contextchange",b,c,e)}e.manageViewState()},getCurrentContext:function(b){Utils.logger.info("BaseDomainController["+this.identifier+"]::getCurrentContext");var a=this;return a.currentContext.get(b)},setTitleFromRecord:function(e,h){Utils.logger.info("BaseDomainController["+this.identifier+"]:setTitleFromRecord");var g=this;var c=g.getTitleSelector();var d=g.getTitleEntity();if(c==null||d==null||d!=h){return}var j="";var k="";if(g.getIncludeOriginalTitle()){j=g.originalTitle}if(e==null){var a=g.getNewTitle();if(a!=""){j+=": "+a}}else{var f=e.get(c);var b=g.getTitleLength();if(f.length>b){k=f;f=f.substring(0,b-3)+"..."}else{f=f.substring(0,b)}j+=":"+f}g.domainView.setTitle(j);if(g.domainView.tab!=null){g.domainView.tab.setTooltip(k)}},isAccessAllowed:function(){return this.allowAccess},showWaitMask:function(a){var b=this;if(Utils.globals.viewport!=null){Utils.globals.viewport.showWaitMask(a,b.ID)}else{if(a){b.getView().setLoading(b.dtLoading)}else{b.getView().setLoading(false)}}},findParentView:function(){var a=this;return a.domainView.findParentByType("domainview")},isDeactivationPromptRequired:function(){return false}});Ext.define("Baff.app.controller.CardController",{extend:"Baff.app.controller.BaseDomainController",requires:["Baff.utility.Utilities"],alias:"controller.card",selectorView:null,cardView:null,currentCard:0,init:function(){var a=this;a.callParent(arguments);a.selectorView=a.lookupReference(a.domainView.selectorViewRef);a.cardView=a.lookupReference(a.domainView.cardViewRef);Ext.Array.each(a.cardView.getLayout().getLayoutItems(),function(b){if(b.isXType("activityview")){b.on("entitychange",a.onEntityChange,a);b.getController().setFireOnEntityChange(true);b.getController().setResetOnContextChange(false)}})},onActivateView:function(){Utils.logger.info("CardController["+this.identifier+"]::onActivateView");var b=this;var a=b.cardView.getLayout().getActiveItem();if(a.isXType("activityview")){a.getController().onActivateView()}if(b.selectorView!=null){b.selectorView.getController().onActivateView()}},onDeactivateView:function(){Utils.logger.info("CardController["+this.identifier+"]::onDeactivateView");var b=this;if(b.selectorView!=null){b.selectorView.getController().onDeactivateView()}var a=b.cardView.getLayout().getActiveItem();if(a.isXType("activityview")){a.getController().onDeactivateView()}},onMasterEntityChange:function(){},onEntityChange:function(c,b,d){Utils.logger.info("CardController["+this.identifier+"]:onEntityChange");var f=this;var a=f.cardView.getLayout().getActiveItem();if(a.isXType("activityview")&&a.getController()==c){if(b!=null){f.setCurrentRecord(b,d);if(f.selectorView!=null){f.selectorView.getController().syncWithExternal(b)}}}else{if(f.selectorView!=null&&f.selectorView.getController()==c){var e=null;if(b!=null){e=b.isNodeEntity?b:b.node}if(!f.matchCurrentRecord(b,d)&&f.isDeactivationPromptRequired()){Ext.Msg.confirm(f.dtConfirmTitle,f.dtContinueWithoutSavingMsg,function(g){if(g=="yes"){f.setCurrentRecord(b,d);f.currentNode=e;f.selectCard(d,b)}else{if(f.selectorView!=null){f.selectorView.getController().syncWithExternal(f.currentNode)}}})}else{if(f.currentNode!=e){f.currentNode=e;f.setCurrentRecord(b,d);f.selectCard(d,b)}}}}},setCurrentRecord:function(a,c){var d=this;d.currentEntityId=(a==null?null:a.getEntityId());var b=Ext.ClassManager.getNameByAlias(c);d.currentEntityType=(b!=""?b:c)},matchCurrentRecord:function(a,c){var d=this;var b=(a==null?null:a.getEntityId());return(b==d.currentEntityId&&c==d.currentEntityType)},selectCard:function(e,b){Utils.logger.info("CardController["+this.identifier+"]:selectCard");var f=this;var a=f.cardView.getLayout().getActiveItem();var d=f.cardView.getLayout().getLayoutItems();var c=f.getCardForEntity(d,e);if(a.isXType("activityview")){a.getController().onDeactivateView()}if(c==null){c=d[0]}if(c.isXType("activityview")){if(b.isNodeEntity){c.getController().updateEntityFilter(b,true);c.getController().onActivateView()}else{c.getController().onActivateView(b)}}f.cardView.getLayout().setActiveItem(c)},getCardForEntity:function(c,b){Utils.logger.info("CardController["+this.identifier+"]:getCardForEntity");var d=this;if(b==null||b==""){return null}var a=null;Ext.Array.each(c,function(e){if(e.isXType("activityview")&&e.getController().getModelSelector()==b){a=e;return false}});return a},isDeactivationPromptRequired:function(){var b=this;var a=b.cardView.getLayout().getActiveItem();if(a.isXType("activityview")){return a.getController().isDeactivationPromptRequired()}else{return false}}});Ext.define("Baff.app.controller.DashboardController",{extend:"Baff.app.controller.BaseDomainController",requires:["Baff.utility.Utilities"],alias:"controller.dashboard",onActivateView:function(){Utils.logger.info("DashboardController["+this.identifier+"]::onActivateView");var b=this;var a=Ext.ComponentQuery.query("activityview",b.domainView);Ext.Array.each(a,function(c){c.getController().onActivateView()})},onDeactivateView:function(){Utils.logger.info("DashboardController["+this.identifier+"]::onDeactivateView");var b=this;var a=Ext.ComponentQuery.query("activityview",b.domainView);Ext.Array.each(a,function(c){c.getController().onDeactivateView()})}});Ext.define("Baff.app.controller.DomainController",{extend:"Baff.app.controller.BaseDomainController",requires:"Baff.utility.Utilities",alias:"controller.domain",popupView:null,currentMasterEntity:null,currentMasterEntityType:null,currentContext:null,dtWorkflowStoppedMsg:"Current workflow will be stopped",dtWorkflowStoppedContinueMsg:"Current workflow will be stopped, continue?",dtHideDashlet:"Hide summary view",dtShowDashlet:"Show summary view",config:{newTitle:"",popupSelector:"",workflows:null},init:function(b){var e=this;e.callParent(arguments);e.domainView.on("beforetabchange",e.beforeTabChange,e);e.domainView.on("newtab",e.onNewTab,e);e.domainView.on("beforeclose",e.beforeClose,e);var a=e.getPopupSelector();if(a===""){e.setPopupSelector(e.domainView.getPopupSelector())}a=e.domainView.getDashletSelector();if(a!=""){if(e.domainView.getDashletDock()=="popup"){e.dashlet=e.showPopup(a,e.dashlet,null,false);if(e.domainView.getHideDashlet()){e.dashlet.hide()}}else{e.dashlet=e.lookupReference(a)}if(e.domainView.getToggleDashlet()){var c="dash-open";var f=e.dtShowDashlet;if(e.dashlet.isVisible()){c="dash-close";f=e.dtHideDashlet}e.domainView.tabBar.add({xtype:"tbfill"});e.toggleDashButton=e.domainView.tabBar.add({iconCls:c,closable:false,tooltip:f,handler:function(){e.showDashlet()},scope:e})}}e.manageViewState();var d=e.findParentView();if(d==null&&!e.domainView.getFromNew()){e.activateView(e.domainView)}},manageViewState:function(){Utils.logger.info("DomainController["+this.identifier+"]::manageViewState");var a=this;if((a.getPopupSelector()!=""&&a.popupView==null)||!a.domainView.items.getAt(0).isDisabled()||!a.domainView.getActiveTab().isDisabled()){if(a.domainView.isDisabled()){a.domainView.enable();a.domainView.tabBar.setActiveTab(a.domainView.getActiveTab().tab)}}else{a.domainView.disable()}},setupAccessControl:function(){Utils.logger.info("DomainController["+this.identifier+"]:setupAccessControl");var b=this;b.callParent(arguments);var a=b.getWorkflows();if(a!=null){for(i=0;i<a.length;i++){if(a[i].roles!=null&&!Utils.userSecurityManager.isUserInRole(a[i].roles)){a[i].isAllowed=false}else{a[i].isAllowed=true}}}},getAvailableWorkflows:function(){Utils.logger.info("DomainController["+this.identifier+"]:setupWorkflow");var b=this;var a=b.getWorkflows();if(a!=null){for(i=0;i<a.length;i++){if(!a[i].isAllowed){a[i].visible=false}else{a[i].visible=b.isWorkflowVisible(a[i])}}}return a},isWorkflowVisible:function(a){return a.visible!=false},onDataIntegrityIssue:function(){Utils.logger.info("DomainController["+this.identifier+"]:onDataIntegrityIssue");var a=this;Ext.Msg.alert(a.dtAckTitle,a.dtDataIntegrityIssue,function(){var b=a.domainView.items.getAt(0);if(b.isXType("activityview")){b.getController().reset()}a.changeTab(b)})},onActivateView:function(){Utils.logger.info("DomainController["+this.identifier+"]:onActivateView");var a=this;if(a.domainView.getActiveTab()!=null&&a.isLowLevelView(a.domainView.getActiveTab())){a.setTitleFromRecord(a.currentMasterEntity)}if(a.getPopupSelector()!=""&&a.popupView==null){a.popupView=a.showPopup(a.getPopupSelector(),a.popupView)}else{a.activateView(a.domainView.getActiveTab())}},showDashlet:function(a){Utils.logger.info("DomainController["+this.identifier+"]:showDashlet");var b=this;if(b.dashlet==null){return}a=(a==null?!b.dashlet.isVisible():a);if(!a){b.dashlet.hide();b.dashlet.getController().onDeactivateView();b.toggleDashButton.setIconCls("dash-open");b.toggleDashButton.setTooltip(b.dtShowDashlet)}else{if(a){b.dashlet.getController().onActivateView();b.dashlet.show();b.toggleDashButton.setIconCls("dash-close");b.toggleDashButton.setTooltip(b.dtHideDashlet)}}},showPopup:function(e,b,a,c){Utils.logger.info("DomainController["+this.identifier+"]:showPopup");var d=this;if(b==null){if(e==d.domainView.getDashletSelector()){b=Ext.widget(e,{modal:false})}else{b=Ext.widget(e)}if(b==null){Utils.logger.error("Failed to instansiate popup");return null}b.on("masterentitychange",d.onMasterEntityChange,d);b.on("contextchange",d.onContextChange,d);b.on("beforeclose",d.closePopup,d);b.on("close",function(){if(b!=d.dashlet){b.getController().onDeactivateView()}if(c!==false){d.onPopupClose()}},d)}b.getController().onMasterEntityChange(d,d.currentMasterEntity,d.currentMasterEntityType);b.getController().onContextChange(d,d.currentContext);b.getController().onEntityChange(d,a,a!=null?a.self.getName():null);b.display(d);b.getController().addApplicationListeners();return b},closePopup:function(a){Utils.logger.info("DomainController["+this.identifier+"]:closePopup");var b=this;if(a==b.dashlet){b.showDashlet(false);return}if(a.getController().isDeactivationPromptRequired()){Ext.Msg.confirm(b.dtConfirmTitle,b.dtContinueWithoutSavingMsg,function(c){if(c=="yes"){a.un("beforeclose",b.closePopup,b);a.close();a.on("beforeclose",b.closePopup,b)}});return false}return true},onPopupClose:function(){Utils.logger.info("DomainController["+this.identifier+"]:onPopupClose");var a=this;if(a.domainView.getActiveTab().isDisabled()){a.domainView.close()}else{a.domainView.tabBar.setActiveTab(a.domainView.getActiveTab().tab);a.activateView(a.domainView.getActiveTab())}},onDeactivateView:function(){Utils.logger.info("DomainController["+this.identifier+"]:onDeactivateView");var a=this;a.deactivateView(a.domainView.getActiveTab());if(a.dashlet!=null){a.dashlet.getController().onDeactivateView()}},beforeClose:function(){Utils.logger.info("DomainController["+this.identifier+"]:beforeClose");var c=this;var b=c.findParentView();var a=c.getDeactivationPrompt();if(a!=""){Ext.Msg.confirm(c.dtConfirmTitle,a,function(d){if(d=="yes"){c.domainView.un("beforeclose",c.beforeClose,c);b.getController().activateRelativeView(c.domainView,-1);c.domainView.close();c.domainView.on("beforeclose",c.beforeClose,c)}});return false}b.getController().activateRelativeView(c.domainView,-1);return true},activateRelativeView:function(b,a){Utils.logger.info("DomainController["+this.identifier+"]:activateRelativeView");var e=this;var c=e.domainView.items.findIndex("id",b.id);var d=c+a;if(d>=0){e.changeTab(e.domainView.items.getAt(d))}},beforeTabChange:function(d,e,b){Utils.logger.info("DomainController["+this.identifier+"]:beforeTabChange");var c=this;var a=c.getDeactivationPrompt();if(a!=""){c.domainView.un("beforetabchange",c.beforeTabChange,c);Ext.Msg.confirm(c.dtConfirmTitle,a,function(f){if(f=="yes"){if(!c.isNewTab(e,b)){c.changeTab(e,b)}}else{c.domainView.setActiveTab(b);c.domainView.on("beforetabchange",c.beforeTabChange,c)}});return false}if(c.isNewTab(e,b)){return false}c.deactivateView(b);c.activateView(e);return true},isNewTab:function(c,a){Utils.logger.info("DomainController["+this.identifier+"]:isNewTab");var b=this;if(c.newType!=null){b.fireViewEvent("newtab",c,a);return true}else{return false}},onNewTab:function(f,d){Utils.logger.info("DomainController["+this.identifier+"]::onNewTab");var e=this;var b=(f.popupSelector!=null?f.popupSelector:"");var c=Ext.widget(f.newType,{title:f.newTitle,fromNew:true,popupSelector:b});var a=f.cloneConfig();e.domainView.remove(f);e.domainView.add(c);e.domainView.add(a);if(e.currentMasterEntity!=null){c.getController().onMasterEntityChange(e,e.currentMasterEntity,e.currentMasterEntityType)}if(e.currentContext.getCount()>0){c.getController().onContextChange(e,e.currentContext)}e.changeTab(c,d);return c},changeTab:function(c,a){Utils.logger.info("DomainController["+this.identifier+"]::changeTab");var b=this;if(a==null){a=b.domainView.getActiveTab()}b.domainView.un("beforetabchange",b.beforeTabChange,b);if(a!=c){b.domainView.setActiveTab(c);b.deactivateView(a)}b.activateView(c);b.domainView.on("beforetabchange",b.beforeTabChange,b)},deactivateView:function(a){Utils.logger.info("DomainController["+this.identifier+"]::deactivateView");var c=this;if(a==null){return}var b=a;while(b!=null&&b.isXType("domainview")){b.getController().onDeactivateView();b=b.getActiveTab()}if(b!=null&&c.isLowLevelView(b)){b.getController().onDeactivateView()}},activateView:function(b){Utils.logger.info("DomainController["+this.identifier+"]::activateView");var f=this;var d=b;if(d!=null&&d.isXType("domainview")){if(d.isDisabled()){var e=d.findParentByType("domainview");e.items.each(function(h){if(h.isXType("domainview")&&!h.isDisabled()){e.getController().changeTab(h,d);return false}});return}d.getController().onActivateView();f.showDashlet(false)}else{if(d!=null&&f.isLowLevelView(d)){if(d.isDisabled()){var e=d.findParentByType("domainview");e.items.each(function(h){if(f.isLowLevelView(h)&&!h.isDisabled()){e.getController().changeTab(h,d);return false}});return}d.getController().onActivateView();Utils.globals.activeView=d;if(f.dashlet!=null){var a=f.domainView.getAutoHideDashletOnView();var c=f.domainView.items.findIndex("id",d.id);var g=d.self.getName();if(a!=null&&(Ext.Array.contains(a,g)||Ext.Array.contains(a,c))){f.showDashlet(false)}else{if(f.domainView.getAutoShowDashlet()){f.showDashlet(true)}}}if(Utils.workflowManager!=null){Utils.workflowManager.onActiveViewChange(d)}}}},getDeactivationPrompt:function(b){Utils.logger.info("DomainController["+this.identifier+"]:getDeactivationPrompt");var d=this;var c="";var a=d.domainView.getActiveTab();while(a!=null&&a.isXType("domainview")){a=a.getActiveTab()}if(a!=null&&d.isLowLevelView(a)&&a.getController().isDeactivationPromptRequired()){c=d.dtContinueWithoutSavingMsg}if(!b&&Utils.workflowManager!=null&&Utils.workflowManager.isDeactivationPromptRequired()){if(c!=""){c+="</br></br>"+d.dtWorkflowStoppedMsg}else{c=d.dtWorkflowStoppedContinueMsg}}return c},showView:function(){Utils.logger.info("DomainController["+this.identifier+"]:showView");var c=this;var a=c.domainView;var b=c.domainView.findParentByType("domainview");while(b!=null){if(a!=b.getActiveTab()){b.getController().changeTab(a,b.getActiveTab())}a=b;b=b.findParentByType("domainview")}},onNextStep:function(d){Utils.logger.info("DomainController["+this.identifier+"]:onNextStep");var g=this;if(g.domainView==null){d.workflow=null;return d}if(d.stateResuming&&d.context!=g.getWorkflowContext()){d.workflow=null;return d}g.showView();g.showWaitMask(true);var h=Ext.clone(d);var a=g.selectNextStep(d);if(a==null){d.step=null;g.showWaitMask(false);return d}var c=null;var e=g.domainView.getActiveTab();if(a.newView){var b=Ext.ComponentQuery.query("selectorpopup");if(b!=null&&b.length>0){c=e}else{if(g.getReferences().newtab!=null){c=g.onNewTab(g.getReferences().newtab,e)}}}else{var f=Ext.ComponentQuery.query(a.view,g.domainView);if(f.length>0){c=f[0]}}if(c==null){Utils.logger.error(a.view," .... not found");d.workflow=null;g.showWaitMask(false);return d}if(c.isDisabled()){Ext.copyTo(d,h,"step, instruction, resume, replay, previous, allowPrev");g.showWaitMask(false);return d}if(!a.newView&&c!=e){g.changeTab(c,e)}if(c.isXType("activityview")){d.step=a.step;d.instruction=a.instruction}else{d.workflow=a.step;d.controller=c.getController();d.step=null}d.activeView=c;g.showWaitMask(false);return d},selectNextStep:function(c){Utils.logger.info("DomainController["+this.identifier+"]:selectNextStep");var d=this;var e=d.getWorkflow(c);if(e==null){return null}c.resume=e.resume;c.replay=e.replay;c.previous=e.previous;c.allowPrev=false;var b=e.steps;if(c.step==null){return b[0]}for(i=0;i<b.length;i++){if(b[i].step==c.step){var a;if(c.stateResuming){a=i}else{if(c.statePrev){a=i-1}else{if(i==b.length-1){a=-1}else{a=i+1}}}if(a>=0){if(a>0){c.allowPrev=true}return b[a]}else{return null}}}return null},getWorkflow:function(a){var d=this;var c=d.getWorkflows();for(var b=0;b<c.length;b++){if(c[b].workflow==a.workflow){return c[b]}}return null},getWorkflowContext:function(){var a=this;if(a.currentMasterEntity!=null){return a.currentMasterEntity.getEntityId()}else{return null}},isLowLevelView:function(a){return(a.isXType("activityview")||a.isXType("dashboardview")||a.isXType("cardview"))}});Ext.override("Ext.tab.Tab",{focusable:false});Ext.define("Baff.app.controller.FormController",{extend:"Baff.app.controller.ActivityController",requires:["Baff.utility.Utilities"],alias:"controller.form",formPanel:null,addButton:null,saveButton:null,removeButton:null,revertButton:null,recordAction:"",isReadOnly:false,dtReviewFields:"Review the highlighted fields",dtConfirmTitle:"Confirm",dtConfirmDelete:"Delete this record?",dtConfirmRevert:"Discard all changes?",config:{createEnabled:true,updateEnabled:true,deleteEnabled:true,viewExistingRecord:true,manageSingleRecord:true,selectFirstRecord:true,formPanelSelector:"",addButtonSelector:"",saveButtonSelector:"",removeButtonSelector:"",revertButtonSelector:"",promptOnDeactivate:true,revertOnDeactivate:true,submitFormUrl:null,setupNewRecordFromContext:false,confirmRemove:false},init:function(){this.callParent(arguments)},onLaunch:function(){Utils.logger.info("FormController["+this.identifier+"]::onLaunch");var b=this,a;a=b.getFormPanelSelector();if(a===""){a=b.activityView.getFormPanel()}if(a!==""){b.formPanel=b.lookupReference(a)}else{b.formPanel=Ext.create("Baff.app.view.FormPanel");b.setUpdateEnabled(false);b.setCreateEnabled(false)}b.formPanel.setCleanRecord();b.formPanel.on("dirtychange",b.onFormDirtyChange,b);a=b.getAddButtonSelector();if(a===""){a=b.activityView.getAddButton()}if(a!==""){b.addButton=b.lookupReference(a);b.addButton.on("click",b.onAddButton,b)}a=b.getRemoveButtonSelector();if(a===""){a=b.activityView.getRemoveButton()}if(a!==""){b.removeButton=b.lookupReference(a);b.removeButton.on("click",b.onRemoveButton,b)}a=b.getSaveButtonSelector();if(a===""){a=b.activityView.getSaveButton()}if(a!==""){b.saveButton=b.lookupReference(a);b.saveButton.on("click",b.onSaveButton,b)}a=b.getRevertButtonSelector();if(a===""){a=b.activityView.getRevertButton()}if(a!==""){b.revertButton=b.lookupReference(a);b.revertButton.on("click",b.onRevertButton,b)}b.callParent(arguments)},setupAccessControl:function(){Utils.logger.info("FormController["+this.identifier+"]:setupAccessControl");var a=this;if(!a.allowUpdate||a.getReadOnly()){if(!a.allowRead){Utils.logger.info("FormController["+this.identifier+"]:setupAccessControl - access not allowedl");a.activityView.disable();a.activityView.hide()}else{Utils.logger.info("FormController["+this.identifier+"]:setupAccessControl - read only access");a.makeReadOnly()}}else{a.makeReadOnly(false);if(!a.getCreateEnabled()||a.getManageSingleRecord()||!a.getViewExistingRecord()){a.showWidget(a.addButton,false)}if(!a.getUpdateEnabled()&&!a.getCreateEnabled()){a.showWidget(a.saveButton,false);a.showWidget(a.revertButton,false);a.formPanel.makeReadOnlyForAll(true)}if(!a.getDeleteEnabled()||!a.getViewExistingRecord()){a.showWidget(a.removeButton,false)}}},makeReadOnly:function(a){Utils.logger.info("FormController["+this.identifier+"]:makeReadOnly");var b=this;if(a!=false){a=true}b.formPanel.makeReadOnlyForAll(a);b.showWidget(b.removeButton,!a);b.showWidget(b.saveButton,!a);b.showWidget(b.revertButton,!a);b.showWidget(b.addButton,!a);b.isReadOnly=a},onDeactivateView:function(){Utils.logger.info("FormController["+this.identifier+"]::onDeactivateView");var a=this;if(a.formPanel.isDirty()){if(a.getRevertOnDeactivate()){a.revertRecord()}}a.callParent(arguments)},onFormDirtyChange:function(c,a){var b=this;b.dirtyChange(c,a)},onAddButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onAddButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.addRecord()}})}else{a.addRecord()}},onSaveButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onSaveButton");this.saveRecord()},onRemoveButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onRemoveButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.removeRecord()}})}else{a.removeRecord()}},onRevertButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onRevertButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.revertRecord()}})}else{a.revertRecord()}},onRefreshButton:function(){Utils.logger.info("FormController["+this.identifier+"]::onRefreshButton");var a=this;if(a.formPanel.isDirty()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmRevert,function(b){if(b==="yes"){a.setCurrentRecord(null);a.refreshCache()}})}else{a.setCurrentRecord(null);a.refreshCache()}},onStoreFirstLoaded:function(){Utils.logger.info("FormController["+this.identifier+"]::onStoreFirstLoaded");var a=this;if(a.checkDataIntegrity()==false){a.showWaitMask(false);return}if(a.currentRecord==null||!a.getViewExistingRecord()){if(!a.getManageSingleRecord()&&!a.getSelectFirstRecord()){a.onLoadAdd()}else{a.onLoadSelectFirst()}}else{if(a.currentRecord.getEntityId()==null){a.onLoadAdd()}else{a.onLoadModify()}}},onLoadAdd:function(){Utils.logger.info("FormController["+this.identifier+"]::onLoadAdd");var a=this;this.addRecord(true)},onLoadModify:function(){Utils.logger.info("FormController["+this.identifier+"]::onLoadModify");var b=this;var a=b.entityStore.findEntity(b.currentRecord);if(a!=null){b.setCurrentRecord(a);b.modifyRecord(b.currentRecord,true)}else{if(b.checkVersion(b.currentRecord)!=true){var c=(Utils.userSecurityManager!=null?Utils.userSecurityManager.getUserName():"");b.showWaitMask(true);b.currentRecord.load({scope:b,params:{entityId:b.currentRecord.getEntityId(),username:c,actionCode:""},callback:function(d,e){if(!e.success){b.doLoadException(d.getProxy().getResponse())}else{if(e.getRecords().length==0){b.setCurrentRecord(null);b.onStoreFirstLoaded()}else{b.modifyRecord(d,true)}}}})}else{b.modifyRecord(b.currentRecord,true)}}},onLoadSelectFirst:function(){Utils.logger.info("FormController["+this.identifier+"]::onLoadSelectFirst");this.selectFirstRecord(true)},refreshWithNoStore:function(a){Utils.logger.info("FormController["+this.identifier+"]::refreshWithNoStore");var b=this;if(b.checkDataIntegrity()==false){b.showWaitMask(false);return}if(a!=null&&a.getEntityId()!=null){b.modifyRecord(a,true)}else{b.addRecord(true)}},selectFirstRecord:function(c){Utils.logger.info("FormController["+this.identifier+"]::selectFirstRecord");var b=this;if(b.entityStore.getTotalCount()==0){b.addRecord(c)}else{var a=b.entityStore.getAt(0);if(a!=null&&a.getEntityId()!=null&&b.getViewExistingRecord()){b.modifyRecord(a,c)}else{b.addRecord(c)}}},dirtyChange:function(c,a){Utils.logger.info("FormController["+this.identifier+"]::dirtyChange, dirty = "+a);var b=this;if(a&&!b.getReadOnly()){b.enableWidget(b.removeButton,false);b.enableWidget(b.revertButton,true);b.enableWidget(b.saveButton,true)}},revertRecord:function(){Utils.logger.info("FormController["+this.identifier+"]::revertRecord, state = "+this.state);var a=this;if(a.currentRecord!=null&&a.currentRecord.getEntityId()!=null){a.modifyRecord(a.currentRecord)}else{a.addRecord()}},modifyRecord:function(b,d){Utils.logger.info("FormController["+this.identifier+"]::modifyRecord");var c=this;c.recordAction=c.entityModel.ACTION.UPDATE;c.setCurrentRecord(b);c.loadRecord(b,c.recordAction);c.formPanel.makeReadOnlyForAll(c.isReadOnly||!(c.getUpdateEnabled()));c.enableWidget(c.removeButton,(c.getDeleteEnabled()&&!c.isReadOnly));c.enableWidget(c.addButton,(c.getCreateEnabled()&&!c.isReadOnly));c.enableWidget(c.revertButton,false);c.enableWidget(c.saveButton,false);var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(d==true,a,b,c.recordAction);c.formPanel.setCleanRecord();c.showWaitMask(false);c.checkVersionOnView(b)},addRecord:function(d){Utils.logger.info("FormController["+this.identifier+"]::addRecord");var c=this;c.recordAction=c.entityModel.ACTION.CREATE;c.setCurrentRecord(null);var b=Ext.create(c.entityModel.getName());c.setNewRecordDefaults(b);c.loadRecord(b,c.recordAction);c.formPanel.makeReadOnlyForAll(c.isReadOnly||!(c.getCreateEnabled()));c.enableWidget(c.removeButton,false);c.enableWidget(c.addButton,false);c.enableWidget(c.revertButton,false);c.enableWidget(c.saveButton,false);var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(d==true,a,b,c.recordAction);c.formPanel.setCleanRecord();c.showWaitMask(false)},setNewRecordDefaults:function(a){var b=this;a.setMasterEntityId(b.masterEntityId);if(b.getSetupNewRecordFromContext()&&b.filterContext.getCount()>0){a.set(b.filterContext.map)}},loadRecord:function(a,c){var b=this;b.formPanel.loadRecord(a)},setFieldsReadOnly:function(b){var a=this;if(b!=false){b=true}a.formPanel.makeReadOnlyForAll(b);if(b){a.enableWidget(a.removeButton,false)}},saveRecord:function(){Utils.logger.info("FormController["+this.identifier+"]::saveRecord");var a=this;var d=a.formPanel.getRecord();var b=d.copy();a.formPanel.updateRecord(b);var c=a.doValidation(b,d);if(!c){a.formPanel.getForm().markInvalid(b.getErrors());Ext.Msg.alert(a.dtValidationErrorTitle,a.dtReviewFields)}else{a.prepareRecord(a.OPERATION.SAVE,b);a.saveExec(b)}},removeRecord:function(){Utils.logger.info("FormController["+this.identifier+"]::removeRecord");var a=this;a.recordAction=a.entityModel.ACTION.DELETE;var d=a.formPanel.getRecord();var b=d.copy();var c=a.doValidation(b,d);if(!c){a.formPanel.getForm().markInvalid(b.getErrors());Ext.Msg.alert(a.dtValidationErrorTitle,a.dtReviewFields)}else{if(a.getConfirmRemove()){Ext.Msg.confirm(a.dtConfirmTitle,a.dtConfirmDelete,function(e){if(e==="yes"){a.prepareRecord(a.OPERATION.REMOVE,b);a.removeExec(b)}})}else{a.prepareRecord(a.OPERATION.REMOVE,b);a.removeExec(b)}}},doValidation:function(a,e){Utils.logger.info("FormController["+this.identifier+"]::doValidation");var b=this;var d=a.isValid(b.recordAction,e);var c=b.doFeasibilityValidation(a,e);if(d&&c){return true}return false},doFeasibilityValidation:function(a,b){return true},saveExec:function(a){Utils.logger.info("FormController["+this.identifier+"]::saveExec");var b=this;if(b.getSubmitFormUrl()!=null){var c={};c.data=Ext.encode(a.getData());b.formPanel.submit({url:b.getSubmitFormUrl(),success:b.saveFormSuccess,failure:b.saveFormFail,scope:b,clientValidation:false,params:c})}else{b.callParent(arguments)}},saveFormSuccess:function(c,d){Utils.logger.info("FormController["+this.identifier+"]::saveFormSuccess");var b=this;var a=Ext.create(b.getModelSelector());if(d.result.data!=null){a.set(d.result.data)}b.saveSuccess(a,d.result)},saveFormFail:function(d,e){Utils.logger.info("FormController["+this.identifier+"]::saveFormFail");var c=this;var a=Ext.create(c.getModelSelector());var b=null;if(e.result.data!=null){a.set(e.result.data)}c.saveFail(a,e.result)},processValidationError:function(c,a,b){Utils.logger.info("FormController["+this.identifier+"]::processValidationError");var d=this;if(c.message!==null){d.showAlertMessage(d.dtValidationErrorTitle,c.message)}else{d.formPanel.getForm().markInvalid(c.errors);d.showAlertMessage(d.dtValidationErrorTitle,d.dtReviewFields)}},isDeactivationPromptRequired:function(){Utils.logger.info("FormController["+this.identifier+"]::isDeactivationPromptRequired");var a=this;return(a.getPromptOnDeactivate()&&a.formPanel.isDirty())},doIfClean:function(c,a,b){var d=this;if(b==null){b=d}if(d.formPanel.isDirty()){Ext.Msg.confirm(d.dtConfirmTitle,d.dtConfirmRevert,function(e){if(e==="yes"){Ext.callback(c,b,a)}})}else{Ext.callback(c,b,a)}}});Ext.define("Baff.app.controller.ListFormController",{extend:"Baff.app.controller.FormController",requires:["Baff.utility.Utilities"],alias:"controller.listform",listPanel:null,config:{manageSingleRecord:false,listPanelSelector:""},init:function(a){this.callParent(arguments)},onLaunch:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onLaunch");var b=this,a;a=b.getListPanelSelector();if(a===""){a=b.activityView.getListPanel()}if(a!==""){b.listPanel=b.lookupReference(a);b.listPanel.on("select",b.onSelectList,b);b.listPanel.on("refreshList",b.onRefreshList,b)}b.callParent(arguments)},onRefreshList:function(){this.onRefreshButton()},onSelectList:function(b,a){Utils.logger.info("ListFormController["+this.identifier+"]::onSelectList");var c=this;if(!c.getViewExistingRecord()){return}if(c.currentRecord!=null&&a.getEntityId()==c.currentRecord.getEntityId()){return}if(!c.entityStore.hasLoaded){return}if(c.formPanel.isDirty()){Ext.Msg.confirm(c.dtConfirmTitle,c.dtConfirmRevert,function(d){if(d==="yes"){c.modifyRecord(a)}else{c.selectCurrentRecord()}})}else{c.modifyRecord(a)}},setupStore:function(){Utils.logger.info("ListFormController["+this.identifier+"]::setupStore");var a=this;a.callParent(arguments);if(a.listPanel!=null&&a.entityStore!=null){a.listPanel.setEntityStore(a.entityStore);a.listPanel.updateSearchCount()}},onStoreFirstLoaded:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onStoreFirstLoaded");var a=this;a.callParent(arguments);a.listPanel.updateSearchCount()},onStoreFetchMore:function(){Utils.logger.info("ListFormController["+this.identifier+"]::onStoreFetchMore");var a=this;if(a.listPanel!=null){a.listPanel.updateSearchCount();a.selectCurrentRecord()}},selectCurrentRecord:function(){Utils.logger.info("ListFormController["+this.identifier+"]::selectCurrentRecord");var a=this;a.selectRecord(a.currentRecord)},selectRecord:function(a){Utils.logger.info("ListFormController["+this.identifier+"]::selectRecord");var d=this;if(d.listPanel!=null){if(d.entityStore!=null&&a!=null){var c=d.entityStore.findEntity(a);if(c!=null){d.listPanel.getSelectionModel().select(c,false,true)}else{var b=d.listPanel.getSelectionModel().getSelection();if(b.length!=1||b[0].getEntityId()!=d.currentRecord.getEntityId()){d.listPanel.getSelectionModel().deselectAll(true)}}}else{d.listPanel.getSelectionModel().deselectAll(true)}}},addRecord:function(){Utils.logger.info("ListFormController["+this.identifier+"]::addRecord");var a=this;a.selectRecord(null);a.callParent(arguments)},modifyRecord:function(a){Utils.logger.info("ListFormController["+this.identifier+"]::modifyRecord");var b=this;b.selectRecord(a);b.callParent(arguments)}});Ext.define("Baff.app.controller.SelectorController",{extend:"Baff.app.controller.ActivityController",requires:["Baff.utility.Utilities"],alias:"controller.selector",listPanel:null,addButton:null,selectButton:null,config:{selectFirstRecord:true,listPanelSelector:"",addButtonSelector:"",selectButtonSelector:""},init:function(a){this.callParent(arguments)},onLaunch:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onLaunch");var b=this,a;a=b.getListPanelSelector();if(a===""){a=b.activityView.getListPanel()}if(a!==""){b.listPanel=b.lookupReference(a);b.listPanel.on("select",b.onSelectList,b);b.listPanel.on("refreshList",b.onRefreshList,b)}a=b.getAddButtonSelector();if(a===""){a=b.activityView.getAddButton()}if(a!==""){b.addButton=b.lookupReference(a);b.addButton.on("click",b.onAddButton,b)}a=b.getSelectButtonSelector();if(a===""){a=b.activityView.getSelectButton()}if(a!==""){b.selectButton=b.lookupReference(a);b.selectButton.on("click",b.onSelectButton,b)}b.callParent(arguments)},onAddButton:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onAddButton");var a=this;a.setCurrentRecord(null);a.listPanel.getSelectionModel().deselectAll(true);a.enableWidget(a.selectButton,false);if(a.getView().isXType("selectorpopup")){a.getView().close()}},onSelectButton:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onSelectButton");var a=this;if(a.getView().isXType("selectorpopup")){a.getView().close()}},onRefreshList:function(){this.onRefreshButton()},onSelectList:function(b,a){Utils.logger.info("SelectorController["+this.identifier+"]::onSelectList");var c=this;var d=a;c.setCurrentRecord(a);c.enableWidget(c.selectButton,true)},setupStore:function(){Utils.logger.info("SelectorController["+this.identifier+"]::setupStore");var a=this;a.callParent(arguments);if(a.listPanel!=null&&a.entityStore!=null){a.listPanel.setEntityStore(a.entityStore);a.listPanel.updateSearchCount()}},onStoreFirstLoaded:function(b){Utils.logger.info("SelectorController["+this.identifier+"]::onStoreFirstLoaded");var c=this;if(c.checkDataIntegrity()==true){if(c.getSelectFirstRecord()){c.selectFirstRecord()}else{c.setCurrentRecord(null);c.selectCurrentRecord()}var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(true,a,null,null);if(c.listPanel!=null){c.listPanel.updateSearchCount()}}this.showWaitMask(false)},onStoreFetchMore:function(){Utils.logger.info("SelectorController["+this.identifier+"]::onStoreFetchMore");var a=this;if(a.listPanel!=null){a.listPanel.updateSearchCount();a.selectCurrentRecord()}},selectFirstRecord:function(){Utils.logger.info("SelectorController["+this.identifier+"]::selectFirstRecord");var b=this,a=null;if(b.entityStore!=null&&b.entityStore.getTotalCount()!=0){a=b.entityStore.getAt(0)}b.setCurrentRecord(a);b.selectCurrentRecord()},selectCurrentRecord:function(){Utils.logger.info("SelectorController["+this.identifier+"]::selectCurrentRecord");var a=this;a.selectRecord(a.currentRecord)},selectRecord:function(a){Utils.logger.info("SelectorController["+this.identifier+"]::selectRecord");var c=this,d=false;if(c.entityStore!=null&&a!=null){var b=c.entityStore.findEntity(a);if(b!=null){c.listPanel.getSelectionModel().select(b,false,true);c.enableWidget(c.selectButton,true);c.checkVersionOnView(b);d=true}}if(!d){c.listPanel.getSelectionModel().deselectAll(true);c.enableWidget(c.selectButton,false);if(a!=null){c.setCurrentRecord(null)}}}});Ext.define("Baff.app.model.TreeModel",{extend:"Ext.data.TreeModel",idProperty:"nodeId",isNodeEntity:true,inheritableStatics:{isMasterEntity:function(){return false},getMasterEntityType:function(){return this.masterEntityType},masterEntityType:null},fields:[{name:"nodeId",type:"string"},{name:"nodeType",type:"string"},{name:"entityId",type:"string"},{name:"entityType",type:"string"},{name:"masterEntityId",type:"string"},{name:"isNewEntity",type:"boolean"}],getMasterEntityType:function(){return this.self.getMasterEntityType()},isMasterEntity:function(){return false},onLoad:function(){var b=this;var a=b.setIconCls();if(a!=null){b.set("iconCls",a)}},setIconCls:function(){if(this.get("newEntity")==true){return"newnode"}return null},getEntity:function(){var b=this;var a=null;var c=b.get("entityData");if(c!=null){a=Ext.create(b.get("entityType"),{clientId:b.getEntityId()});if(a!=null){a.set(c)}}if(a!=null){a.node=b}return a},getEntityType:function(){var c=this;var b=c.get("entityType");var a=Ext.ClassManager.getNameByAlias(b);if(a!=""){return a}else{return b}},getEntityId:function(){var a=this.get("entityId");if(a==""){a=null}return a},getMasterEntityId:function(){var a=this.get("masterEntityId");if(a==""){a=null}return a},isEntity:function(f,c){var e=this;if(c!=e.get("entityId")){return false}var b=e.get("entityType");if(b==f){return true}var a=Ext.ClassManager.getNameByAlias(b);if(a==f){return true}var d=Ext.ClassManager.getNameByAlias(f);if(d==b||d==a){return true}return false}});Ext.define("Baff.app.model.TreeStore",{extend:"Ext.data.TreeStore",requires:["Baff.app.model.TreeModel"],model:"Baff.app.model.TreeModel",root:{expanded:true,text:"",data:[]},storeKey:null,masterKey:null,storeType:null,hasLoaded:false,config:{ownerId:null},constructor:function(){var a=this;a.callParent(arguments);a.storeType=a.self.getName();a.setKeys(a.ownerId);if(Utils.userSecurityManager!=null&&Utils.userSecurityManager.getUserName()!=null){a.setParam("username",Utils.userSecurityManager.getUserName())}a.on("load",a.onLoad,a)},onLoad:function(c,b,f,a,e){var d=this;if(!d.isLoading()&&a.wasSuccessful()){d.hasLoaded=true;d.fireEvent("postfetch",d,a.getResponse(),true)}},setParam:function(b,a){this.getProxy().setExtraParam(b,a)},removeAll:function(){this.hasLoaded=false;this.callParent(arguments)},flush:function(a){this.removeAll();this.fireEvent("flush",this,a)},hasLoadedData:function(){return this.hasLoaded},setKeys:function(a,c){var b=this;b.storeKey=Ext.getClassName(this);b.masterKey="#"+b.getModel().getMasterEntityType()+"#";if(a!=null){b.storeKey+="|"+a}},findNodeForEntity:function(d,b){var c=this;var a=c.findBy(function(e){if(e.isEntity(d,b)){return true}});if(a==-1){return null}else{return c.getAt(a)}},clearFieldFilters:function(a){},setContextFilters:function(a){}});Ext.define("Baff.app.controller.TreeController",{extend:"Baff.app.controller.SelectorController",alias:"controller.tree",requires:["Baff.app.model.TreeStore","Baff.app.model.TreeModel"],nodePath:null,currentEntity:null,syncEntity:null,config:{modelSelector:"Baff.app.model.TreeModel",dependentOnMaster:false,selectFirstRecord:false,fireOnEntityChange:true},onRefreshButton:function(){Utils.logger.info("TreeController["+this.identifier+"]::onRefreshButton");var a=this;a.nodePath=null;a.syncEntity=null;a.callParent(arguments)},onStoreFirstLoaded:function(b){Utils.logger.info("TreeController["+this.identifier+"]::onStoreFirstLoaded");var c=this;if(c.checkDataIntegrity()==true){if(c.currentRecord!=null||c.syncEntity!=null){c.selectCurrentRecord()}else{if(c.getSelectFirstRecord()){c.selectFirstRecord()}else{c.selectRecord(null)}}var a=(c.allowUpdate&&!c.isReadOnly);c.prepareView(true,a,null,null);if(c.listPanel!=null){c.listPanel.updateSearchCount()}}this.showWaitMask(false)},onSelectList:function(b,a){Utils.logger.info("TreeController["+this.identifier+"]::onSelectList");var c=this;var d=a;c.nodePath=a.getPath();c.setCurrentRecord(a);c.enableWidget(c.selectButton,true)},selectCurrentRecord:function(){Utils.logger.info("TreeController["+this.identifier+"]::selectCurrentRecord");var c=this;var b=c.currentRecord;if(c.extEntityType!=null){var a=c.getEntityNode(c.extEntityType,c.extEntityId);if(a!=null){b=a}}c.selectRecord(b)},selectRecord:function(a){Utils.logger.info("TreeController["+this.identifier+"]::selectRecord");var b=this,c=false;if(a!=null){b.nodePath=a.getPath()}if(b.nodePath!=null){Ext.Array.each(b.nodePath.split("/"),function(g,d,e){var f=b.entityStore.getNodeById(g);if(f!=null){if(d!=(e.length-1)&&!f.isExpanded()&&f.isExpandable()){b.listPanel.expandNode(f)}else{b.listPanel.getSelectionModel().select(f,false,true);b.nodePath=f.getPath();b.enableWidget(b.selectButton,true);b.setCurrentRecord(f)}c=true;return false}},b,true)}if(!c){b.listPanel.getSelectionModel().deselectAll(true);b.enableWidget(b.selectButton,false);b.setCurrentRecord(null);b.nodePath=null}},syncWithExternal:function(a){Utils.logger.info("ActivityController["+this.identifier+"]::syncWithExternal");var c=this;var b=null;if(a!=null){if(a.isNodeEntity){b=a}else{if(c.currentRecord.getEntityId()!=a.getEntityId()||c.currentRecord.getEntityType()!=a.getEntityType()){b=c.getEntityNode(a.getEntityType(),a.getEntityId());if(b==null){c.extEntityId=a.getEntityId();c.extEntityType=a.getEntityType()}}}if(b!=null){c.selectRecord(b)}}else{c.selectRecord(null)}},setCurrentRecord:function(b){Utils.logger.info("TreeController["+this.identifier+"]::setCurrentRecord");var d=this;var c=(d.isActive&&!d.dataRefresh);var a=false;if(b==false){b=null}if(d.currentRecord!=b||b==null){d.currentRecord=b;d.extEntityType=null;d.extEntityId=null;d.currentEntity=d.getEntity(d.currentRecord);a=true;c=true}if(c){d.fireContextEvent(b)}if(a){if(d.currentEntity!=null){d.fireViewEvent("entitychange",d,d.currentEntity,d.currentEntity.getEntityType())}else{d.fireViewEvent("entitychange",d,d.currentRecord,d.currentRecord==null?null:d.currentRecord.getEntityType())}}},fireContextEvent:function(a,c){Utils.logger.info("TreeController["+this.identifier+"]::fireContextEvent");var b=this;if(c!=null){b.callParent(arguments);return}if(b.nodePath!=null){Ext.Array.each(b.nodePath.split("/"),function(h,e,f){var g=b.entityStore.getNodeById(h);if(g!=null){var d=b.getEntity(g);if(b.getContextSetterMap()!=null&&d!=null){Ext.Array.each(b.getContextSetterMap(),function(j){if((j.nodeType==null||g.get("nodeType")==j.nodeType)&&(j.entityType==null||g.get("entityType")==j.entityType)){b.fireContextEvent(d,j.contextMapping);return false}})}}}),b,true}},checkVersionOnView:function(a){Utils.logger.info("TreeController["+this.identifier+"]::checkVersionOnView");var b=this;b.callParent(b.getEntity(a))},getEntity:function(b){Utils.logger.info("TreeController["+this.identifier+"]::getEntity");var a=this;if(b==null){return null}else{return b.getEntity()}},getEntityNode:function(c,a){Utils.logger.info("TreeController["+this.identifier+"]::getEntityNode");var b=this;if(c==null){return null}return b.entityStore.findNodeForEntity(c,a)}});Ext.define("Baff.app.view.ActivityView",{extend:"Ext.panel.Panel",xtype:"activityview",dtRefresh:"Refresh",config:{controller:"activity",refreshButton:"refreshBtn",myItems:[],title:"",dashlet:false},border:false,cls:"x-tab x-tab-active x-tab-default",bodyPadding:5,bodyStyle:{background:"transparent"},layout:{type:"hbox",align:"stretch"},initComponent:function(){var c=this;var b=c.setupDockedItems();var a=c.setupItems();if(b!=null&&!c.getDashlet()){Ext.apply(c,{dockedItems:[{xtype:"toolbar",cls:"x-tab x-tab-active x-tab-default",dock:"top",items:b}]})}if(a!=null){Ext.apply(c,{items:a})}c.callParent(arguments)},setupDockedItems:function(){var b=this,a;if(b.getDashlet()){b.refreshButton="";return null}if(typeof b.refreshButton=="object"){a=b.refreshButton;b.refreshButton=a.reference}else{if(b.refreshButton!=""){a={xtype:"button",reference:b.refreshButton,iconCls:"refresh",text:b.dtRefresh}}}return["    ",a]},setupItems:function(){var b=this;var a=b.getMyItems();return a},display:function(a){var b=this;b.domainController=a;if(b.config.title!=""){b.setTitle(a.domainView.getTitle()+" - "+b.config.title)}this.show();this.getController().onActivateView()},findParentView:function(){var a=this;if(a.domainController!=null){return a.domainController.domainView}return a.findParentBy(function(b){if(b.isXType("domainview")||b.isXType("dashboardview")||b.isXType("cardview")){return true}})}});Ext.define("Baff.app.view.ActivityPopup",{extend:"Baff.app.view.ActivityView",xtype:"activitypopup",config:{width:800,height:600,modal:true,draggable:true,resizable:true,closable:true,border:true,frame:false,floating:true,closeAction:"hide"}});Ext.define("Baff.app.view.CardView",{extend:"Ext.panel.Panel",xtype:"cardview",cardViewRef:"cardview",selectorViewRef:"selectorview",config:{controller:"carddomain",selectorView:"",selectorFlex:10,cards:[],disableCardRefresh:true,emptyCard:true,emptyCardText:"Please select an item to view..."},border:false,cls:"x-tab x-tab-active x-tab-default",bodyPadding:5,layout:{type:"hbox",align:"stretch"},bodyStyle:{background:"transparent"},initComponent:function(){var c=this;var a=[];var f=c.getSelectorView;if(f!=null&&f!=""){if(typeof f=="object"){c.selectorViewRef=f.reference}else{c.selectorViewRef=c.getSelectorView();f={xtype:c.selectorViewRef,reference:c.selectorViewRef,margin:"0 5 0 0",flex:c.getSelectorFlex()}}a.push(f)}var e=c.getCards();var b=c.getEmptyCard();if(c.getDisableCardRefresh()){Ext.Array.each(e,function(g){g.refreshButton=""})}if(typeof b=="object"){e.unshift(b)}else{if(b==true){b={xtype:"container",reference:"emptyCard",layout:{type:"hbox",align:"center"},items:[{xtype:"container",flex:1,layout:{type:"vbox",align:"center"},items:[{xtype:"container",flex:1,html:c.getEmptyCardText()}]}]};e.unshift(b)}}var d={xtype:"container",reference:c.cardViewRef,flex:10,layout:"card",items:e};a.push(d);Ext.apply(c,{items:a});c.callParent(arguments)}});Ext.define("Baff.app.view.DashboardView",{extend:"Ext.panel.Panel",xtype:"dashboardview",config:{controller:"dashboard"},bodyStyle:{background:"transparent"},border:false,cls:"x-tab x-tab-active x-tab-default",bodyPadding:5,layout:{type:"vbox",align:"stretch",pack:"start"}});Ext.define("Baff.app.view.DomainView",{extend:"Ext.tab.Panel",xtype:"domainview",config:{controller:"domain",fromNew:false,popupSelector:"",dashletSelector:"",dashletDock:"right",autoHideDashletOnView:[0],autoShowDashlet:false,hideDashlet:false,toggleDashlet:true},border:false,bodyStyle:{background:"transparent"},defaults:{bodyStyle:{background:"transparent"}},initComponent:function(){var a=this;if(a.getDashletSelector()!==""&&a.getDashletDock()!="popup"){Ext.apply(a,{dockedItems:[{xtype:a.getDashletSelector(),dock:a.getDashletDock(),reference:a.getDashletSelector(),dashlet:true,hidden:a.getHideDashlet()}]})}a.callParent(arguments)}});Ext.define("Baff.app.view.FilterField",{extend:"Ext.form.field.Text",xtype:"filterfield",entityStore:null,activeFilter:null,triggers:{clear:{weight:0,cls:Ext.baseCSSPrefix+"form-clear-trigger",hidden:true,handler:"onClearClick",scope:"this"},search:{weight:1,cls:Ext.baseCSSPrefix+"form-search-trigger",handler:"onSearchClick",scope:"this"}},filterFieldName:"filterFieldName not defined",initComponent:function(){var a=this;a.callParent(arguments);a.on("specialkey",function(b,c){if(c.getKey()==c.ENTER){a.onSearchClick()}})},setEntityStore:function(a){var b=this;b.onClearClick();b.entityStore=a},onClearClick:function(){var b=this,a=b.activeFilter;if(a){b.setValue("");if(b.entityStore){b.entityStore.removeFieldFilter(a)}b.activeFilter=null;b.getTrigger("clear").hide();b.updateLayout()}},onSearchClick:function(){var a=this,b=a.getValue(),c=a.activeFilter;if(b.length>0){a.activeFilter=new Ext.util.Filter({property:a.filterFieldName,value:"%"+b+"%"});if(a.entityStore){a.entityStore.addFieldFilter(a.activeFilter)}a.getTrigger("clear").show();a.updateLayout()}}});Ext.define("Baff.app.view.FilterPanel",{extend:"Ext.form.Panel",xtype:"filterpanel",padding:"5 5 0 5",border:false,bodyStyle:{background:"transparent"},fieldDefaults:{labelAlign:"left",labelWidth:150}});Ext.define("Baff.utility.refdata.RefDataComboBox",{extend:"Ext.form.ComboBox",requires:["Baff.utility.refdata.RefDataManager"],xtype:"refdatacombobox",valueField:"code",displayField:"decode",queryMode:"local",forceSelection:true,initialKey:null,REF_DATA_NULL:"REF.DATA.NULL",REF_DATA_NOCLASS:"REF.DATA.NOCLASS",config:{refdataClass:"REF.DATA.NOCLASS",defaultKey:"REF.DATA.NULL",typeAhead:true},initComponent:function(){var a=this;a.callParent(arguments);a.setRefDataClass(a.refdataClass,a.defaultKey)},getKey:function(){var d=this;var b=d.REF_DATA_NULL;if(d.store){var c=d.getSubmitValue();var a=d.store.findRecord("code",c);if(a){b=a.get("key")}}return b},getCode:function(){var b=this;var a=null;if(b.store){a=b.getSubmitValue()}return a},setRefDataClass:function(a,b){var c=this;c.initialKey=b;c.refdataClass=a;c.setStore(Utils.refDataManager.getRefDataStore(c.refdataClass));if(c.getStore().isLoaded()){c.setValueOnData()}},setValueOnData:function(){var c=this;var a=c.initialKey;if(c.refdataClass===c.REF_DATA_NOCLASS){a=c.REF_DATA_NULL}else{if(!a){a=c.getKey()}}var b=c.isDirty();c.setValue(a);if(!b){c.resetOriginalValue();c.reset()}},setValue:function(d,a){var c=this;if(Ext.isString(d)){if(d==c.REF_DATA_NULL){d=null}else{if(d.split(".").length==3){var b=c.getStore().findRecord("key",d);if(b){d=b.get("code")}}}}c.callParent(arguments)}});Ext.define("Baff.app.view.FormPanel",{extend:"Ext.form.Panel",xtype:"formpanel",requires:["Ext.form.FieldSet","Ext.form.field.Radio","Ext.form.RadioGroup","Ext.toolbar.Toolbar","Ext.form.ComboBox","Baff.utility.refdata.RefDataManager","Baff.utility.refdata.RefDataComboBox"],bodyPadding:10,frame:true,autoscroll:true,fieldDefaults:{labelAlign:"right"},setCleanRecord:function(){this.getForm().getFields().each(function(a){a.resetOriginalValue();a.reset()})},makeReadOnlyForAll:function(a){Ext.suspendLayouts();this.getForm().getFields().each(function(b){b.setReadOnly(a)});Ext.resumeLayouts()}});Ext.define("Baff.app.view.FormView",{extend:"Baff.app.view.ActivityView",xtype:"formview",requires:["Ext.toolbar.Toolbar","Baff.app.view.FormPanel"],dtAdd:"Add",dtRemove:"Delete",dtSave:"Save",dtRevert:"Undo",config:{controller:"form",formPanel:"",addButton:"addBtn",removeButton:"removeBtn",saveButton:"saveBtn",revertButton:"revertBtn"},setupDockedItems:function(){var d=this,f,c,b,e,a;if(d.getDashlet()){d.addButton="";d.refreshButton="";d.removeButton="";d.revertButton="";d.saveButton="";return null}if(typeof d.addButton=="object"){f=d.addButton;d.addButton=f.reference}else{if(d.addButton!=""){f={xtype:"button",reference:d.addButton,iconCls:"addnew",text:d.dtAdd}}}if(typeof d.removeButton=="object"){c=d.removeButton;d.removeButton=c.reference}else{if(d.removeButton!=""){c={xtype:"button",reference:d.removeButton,iconCls:"delete",text:d.dtRemove}}}if(typeof d.revertButton=="object"){b=d.revertButton;d.revertButton=b.reference}else{if(d.revertButton!=""){b={xtype:"button",reference:d.revertButton,iconCls:"undo",text:d.dtRevert}}}if(typeof d.saveButton=="object"){e=d.saveButton;d.saveButton=e.reference}else{if(d.saveButton!=""){e={xtype:"button",reference:d.saveButton,iconCls:"save",text:d.dtSave}}}if(typeof d.refreshButton=="object"){a=d.refreshButton;d.refreshButton=a.reference}else{if(d.refreshButton!=""){a={xtype:"button",reference:d.refreshButton,iconCls:"refresh",text:d.dtRefresh}}}return["    ",a,f,c,"->",b,e,"    "]},setupItems:function(){var b=this;var a=b.getMyItems();if(b.getFormPanel()!=""){a.push({xtype:b.getFormPanel(),reference:b.getFormPanel(),flex:10})}return a}});Ext.define("Baff.app.view.FormPopup",{extend:"Baff.app.view.FormView",xtype:"formpopup",config:{width:800,height:600,modal:true,draggable:true,resizable:true,closable:true,border:true,frame:false,floating:true,dock:"bottom",closeAction:"hide"}});Ext.define("Baff.app.view.ImageField",{extend:"Ext.form.FieldContainer",xtype:"imagefield",requires:["Ext.Img","Ext.form.field.File"],mixins:["Ext.form.field.Field"],imageContainer:null,imageSelector:null,imageValue:null,config:{encoding:"data:image/jpeg;base64",uploadParameter:"imagefile",imageHeight:100,imageWidth:100,backgroundColor:"white"},initComponent:function(){var b=this;var a=[];a.push({xtype:"image",itemId:"imagecontainer",height:b.getImageHeight(),width:b.getImageWidth(),cls:"x-form-text-wrap-default",style:"background-color: "+b.getBackgroundColor()});if(b.getUploadParameter()!=null){a.push({xtype:"filefield",name:b.getUploadParameter(),buttonText:"Select Image...",hideLabel:true,buttonOnly:true,itemId:"imageselector",padding:5,listeners:{change:b.onSelectFile,scope:b}})}Ext.apply(b,{items:a});b.callParent(arguments);b.initField();b.imageContainer=b.getComponent("imagecontainer");b.imageSelector=b.getComponent("imageselector")},onSelectFile:function(){var d=this;var b=d.imageSelector.getValue();if(b!=null&&b!=""){var a=b.replace(/^.*[\\\/]/,"");var c=d.imageContainer.imgEl;c.dom.src="";c.dom.alt=a}},setValue:function(c){var b=this;var a=b.imageContainer;if(a!=null&&c!=null){if(c==""){a.setSrc(null)}else{a.setSrc(b.encoding+","+c)}}},setReadOnly:Ext.emptyFn,reset:function(){var b=this;var a=b.imageSelector;if(a!=null){a.reset()}},resetOriginalValue:function(){var b=this;var a=b.imageSelector;if(a!=null){a.resetOriginalValue()}}});Ext.define("Baff.utility.refdata.RefDataColumn",{extend:"Ext.grid.column.Column",xtype:"refdatacolumn",requires:["Baff.utility.Utilities"],config:{refdataClass:null,sortable:false,filter:true},initComponent:function(){var a=this;a.callParent(arguments);Ext.apply(a,{renderer:function(c){return Utils.refDataManager.getDecode(c,a.refdataClass)}});if(!a.filter){return}var b=Utils.refDataManager.getCodeDecodeArray(a.refdataClass);Ext.apply(a,{filter:{type:"list",options:b,single:true,idField:"code",labelField:"decode"}})},beforeRender:function(){var a=this;a.callParent(arguments);if(a.filter!=null&&a.filter!=false){a.menuDisabled=false}}});Ext.define("Baff.utility.refdata.RefDataFilterField",{extend:"Baff.utility.refdata.RefDataComboBox",xtype:"refdatafilter",entityStore:null,activeFilter:null,triggers:{clear:{weight:0,cls:Ext.baseCSSPrefix+"form-clear-trigger",hidden:true,handler:"onClearClick",scope:"this"},picker:{weight:1,handler:"onTriggerClick",scope:"this"}},filterFieldName:"filterFieldName not defined",initComponent:function(){var a=this;a.callParent(arguments);a.on("select",a.onSearchClick,a)},setEntityStore:function(a){var b=this;b.onClearClick();b.entityStore=a},onClearClick:function(){var b=this,a=b.activeFilter;if(a){b.setValue(0);if(b.entityStore){b.entityStore.removeFieldFilter(a)}b.activeFilter=null;b.getTrigger("clear").hide();b.updateLayout()}},onSearchClick:function(){var a=this,b=a.getCode(),c=a.activeFilter;if(b>0){a.activeFilter=new Ext.util.Filter({property:a.filterFieldName,value:b});if(a.entityStore){a.entityStore.addFieldFilter(a.activeFilter)}a.getTrigger("clear").show();a.updateLayout()}}});Ext.define("Baff.app.view.ListPanel",{extend:"Ext.grid.Panel",xtype:"listpanel",requires:["Ext.grid.filters.Filters","Baff.app.view.FilterField","Baff.utility.refdata.RefDataColumn","Baff.utility.refdata.RefDataFilterField"],dtRecordsFound:"Records found",dtFiltered:"(filtered)",dtShowSearch:"Show search panel",dtHideSearch:"Hide search panel",dtRefreshList:"Refresh view",frame:true,config:{filterPanel:"",listCount:true,allowRefresh:false,hideSearchPanel:false},height:1000,selModel:{pruneRemoved:false},viewConfig:{markDirty:false,stripeRows:true,trackOver:false},initComponent:function(){var b=this;Ext.apply(b,{plugins:["gridfilters"]});var c=[];var a=[];if(b.filterPanel!=""){a.push({xtype:"toolbar",dock:"top",itemId:"filterPanel",layout:"anchor",padding:5,hidden:b.hideSearchPanel,items:[{xtype:b.filterPanel}]});c.push({type:"up",tooltip:b.dtHideSearch,itemId:"hideSearch",callback:b.onHideSearch,hidden:b.hideSearchPanel});c.push({type:"search",tooltip:b.dtShowSearch,itemId:"showSearch",callback:b.onShowSearch,hidden:!b.hideSearchPanel})}if(b.allowRefresh){c.push({type:"refresh",itemId:"refreshList",callback:b.onRefreshList,tooltip:b.dtRefreshList})}if(b.listCount){a.push({dock:"bottom",minHeight:20,xtype:"toolbar",cls:"x-tab x-tab-active x-tab-default",items:["->",{xtype:"component",itemId:"listCount",style:"margin-right:5px"}]})}if(c.length>0){Ext.apply(b,{tools:c})}if(a.length>0){Ext.apply(b,{dockedItems:a})}b.on("beforedestroy",b.beforeDestroy,b);b.callParent(arguments)},onRefreshList:function(a,b){a.fireEvent("refreshList",a)},onHideSearch:function(a,b){var c=a;b.hide();c.down("#filterPanel").hide();c.down("#showSearch").show()},onShowSearch:function(a,b){var c=a;b.hide();c.down("#filterPanel").show();c.down("#hideSearch").show()},setEntityStore:function(a){var e=this,c;var d=Ext.ComponentQuery.query("filterfield",e);for(c=0;c<d.length;c++){d[c].setEntityStore(a)}var b=Ext.ComponentQuery.query("refdatafilter",e);for(c=0;c<b.length;c++){b[c].setEntityStore(a)}e.setStore(a)},updateSearchCount:function(){var b=this;var a=b.down("#listCount");var c=b.dtRecordsFound;if(b.getStore().getFieldFilterCount()>0){c+=" "+b.dtFiltered}if(a!=null){c+=": "+b.store.getTotalCount();a.update(c)}},bindStore:function(b,c){var d=this,a=d.getView(),e=d.bufferedRenderer;if(b){d.store=b;if(a.store!==b){a.bindStore(b,false)}if(e&&e.isBufferedRenderer&&e.store){e.bindStore(b)}d.mon(b,{load:d.onStoreLoad,scope:d});d.storeRelayers=d.relayEvents(b,["filterchange","groupchange"])}else{d.unbindStore()}}});Ext.define("Baff.app.view.ListFormView",{extend:"Baff.app.view.FormView",xtype:"listformview",requires:["Baff.app.view.ListPanel"],config:{controller:"listform",listPanel:"",listFlex:10},setupItems:function(){var c=this;var a=c.getMyItems();var b={xtype:c.getListPanel(),reference:c.getListPanel(),margin:"0 5 0 0",flex:c.getListFlex()};if(c.getDashlet()){b.allowRefresh=true}a.push(b);c.callParent(arguments);return a}});Ext.define("Baff.app.view.ListFormPopup",{extend:"Baff.app.view.ListFormView",xtype:"listformpopup",config:{width:800,height:600,modal:true,draggable:true,resizable:true,closable:true,border:true,frame:false,floating:true,closeAction:"hide"}});Ext.define("Baff.app.view.SelectorView",{extend:"Baff.app.view.ActivityView",xtype:"selectorview",requires:["Ext.toolbar.Toolbar","Baff.app.view.ListPanel"],dtAdd:"None",dtSelect:"Select",config:{controller:"selector",listPanel:"",addButton:"addBtn",selectButton:""},setupDockedItems:function(){var c=this,d,a,b;if(c.getDashlet()){c.addButton="";c.refreshButton="";c.selectButton="";return null}if(typeof c.addButton=="object"){d=c.addButton;c.addButton=d.reference}else{if(c.addButton!=""){d={xtype:"button",reference:c.addButton,iconCls:"addnew",text:c.dtAdd}}}if(typeof c.refreshButton=="object"){a=c.refreshButton;c.refreshButton=a.reference}else{if(c.refreshButton!=""){a={xtype:"button",reference:c.refreshButton,iconCls:"refresh",text:c.dtRefresh}}}if(typeof c.selectButton=="object"){b=c.selectButton;c.selectButton=b.reference}else{if(c.selectButton!=""){b={xtype:"button",reference:c.selectButton,iconCls:"go",text:c.dtSelect}}}return["    ",a,d,"->",b,"    "]},setupItems:function(){var c=this;var a=c.getMyItems();var b={xtype:c.getListPanel(),reference:c.getListPanel(),flex:1};if(c.getDashlet()){b.allowRefresh=true}a.push(b);return a}});Ext.define("Baff.app.view.SelectorPopup",{extend:"Baff.app.view.SelectorView",xtype:"selectorpopup",config:{width:800,height:600,modal:true,selectButton:"selectBtn",draggable:true,resizable:true,closable:true,border:true,frame:false,floating:true,closeAction:"hide"}});Ext.define("Baff.app.view.TreePanel",{extend:"Ext.tree.Panel",alias:"widget.bafftreepanel",config:{allowRefresh:false,allowExpand:false,allowCollapse:true},dtRefreshList:"Refresh view",dtExpand:"Expand all",dtCollapse:"Collapse all",rootVisible:false,frame:true,reserveScrollbar:true,lines:true,initComponent:function(){var a=this;var b=[];if(a.allowExpand){b.push({type:"expand",tooltip:a.dtExpand,itemId:"expandAll",callback:function(c){c.expandAll()}})}if(a.allowCollapse){b.push({type:"collapse",tooltip:a.dtCollapse,itemId:"collapseAll",callback:function(c){c.collapseAll()}})}if(a.allowRefresh){b.push({type:"refresh",itemId:"refreshList",callback:a.onRefreshList,tooltip:a.dtRefreshList})}if(b.length>0){Ext.apply(a,{tools:b})}a.callParent(arguments)},onRefreshList:function(a,b){a.fireEvent("refreshList",a)},setEntityStore:function(a){this.setStore(a)},updateSearchCount:function(){}});Ext.define("Baff.utility.application.LogonWindow",{extend:"Ext.window.Window",alias:"widget.logonwindow",requires:["Ext.form.field.Text","Baff.utility.Utilities"],closable:false,bodyPadding:"10 10 0 10",dtLogonTitle:"Logon",dtLogonBtn:"Logon",dtOptions:"Options",dtRegister:"Register",dtUpdate:"Update",dtReset:"Reset",dtUserName:"User Name",dtPassword:"Password",dtVersion:"Version",buttonAlign:"center",initComponent:function(){var b=this;var a=[];if(Utils.globals.manageUsers){a.push({text:b.dtOptions,itemId:"optionBtn",menu:[{text:b.dtRegister,itemId:"register"},{text:b.dtReset,itemId:"reset"},{text:b.dtUpdate,itemId:"update"}]});a.push(" ")}a.push({text:b.dtLogonBtn,itemId:"logonBtn"});Ext.apply(b,{title:Utils.globals.applicationName+" "+b.dtLogonTitle,items:[{xtype:"fieldset",border:false,fieldDefaults:{anchor:"100%",labelAlign:"right"},layout:"anchor",items:[{xtype:"textfield",fieldLabel:b.dtUserName,name:"username",value:Utils.globals.defaultUsername,allowBlank:false,validateOnBlur:true},{xtype:"textfield",name:"password",fieldLabel:b.dtPassword,inputType:"password",value:Utils.globals.defaultPassword,allowBlank:false,validateOnBlur:true}]},{xtype:"fieldset",border:false,autoEl:{tag:"center"},items:[{xtype:"displayfield",value:b.dtVersion+": "+Utils.globals.version}]}],buttons:a});b.callParent(arguments)}});Ext.define("Baff.utility.application.UpdateUserWindow",{extend:"Ext.window.Window",alias:"widget.updateuserwindow",requires:["Ext.form.field.Text","Baff.utility.Utilities"],closable:false,bodyPadding:"10 10 0 10",dtUpdateTitle:"Update User",dtUpdateBtn:"Update",tPassword:"Current Password",dtPassword:"New Password",dtConfirmPassword:"Confirm Password",dtDisplayName:"Display Name",dtCancelBtn:"Cancel",buttonAlign:"center",initComponent:function(){var a=this;Ext.apply(a,{title:Utils.globals.applicationName+" "+a.dtUpdateTitle,items:[{xtype:"fieldset",border:false,fieldDefaults:{anchor:"100%",labelAlign:"right"},layout:"anchor",items:[{xtype:"textfield",name:"password",fieldLabel:a.dtPassword,inputType:"password",allowBlank:false,validateOnBlur:true,labelWidth:125},{xtype:"textfield",name:"confirmPassword",fieldLabel:a.dtConfirmPassword,inputType:"password",allowBlank:false,validateOnBlur:true,labelWidth:125}]}],buttons:[{text:a.dtCancelBtn,itemId:"cancelBtn"}," ",{text:a.dtUpdateBtn,itemId:"updateBtn"}]});a.callParent(arguments)}});Ext.define("Baff.utility.application.RegisterUserWindow",{extend:"Ext.window.Window",alias:"widget.registeruserwindow",requires:["Ext.form.field.Text","Baff.utility.Utilities"],closable:false,bodyPadding:"10 10 0 10",dtRegisterTitle:"Register User",dtRegisterBtn:"Register",dtEmail:"Email",dtDisplayName:"Display Name",dtCancelBtn:"Cancel",buttonAlign:"center",initComponent:function(){var a=this;Ext.apply(a,{title:Utils.globals.applicationName+" "+a.dtRegisterTitle,items:[{xtype:"fieldset",border:false,fieldDefaults:{anchor:"100%",labelAlign:"right"},layout:"anchor",items:[{xtype:"textfield",fieldLabel:a.dtEmail,name:"email",vtype:"email",allowBlank:false,validateOnBlur:true},{xtype:"textfield",name:"displayName",fieldLabel:a.dtDisplayName,vtype:"alpha",allowBlank:false,validateOnBlur:true}]}],buttons:[{text:a.dtCancelBtn,itemId:"cancelBtn"}," ",{text:a.dtRegisterBtn,itemId:"registerBtn"}]});a.callParent(arguments)}});Ext.define("Baff.utility.workflow.WorkflowToolbar",{extend:"Ext.container.Container",alias:"widget.workflowtoolbar",controller:"workflow",border:false,requires:["Ext.toolbar.Breadcrumb","Baff.utility.Utilities"],initComponent:function(){var a=this;Ext.apply(a,{items:[{xtype:"breadcrumb",reference:"wfSelector"},{xtype:"toolbar",cls:"x-tab x-tab-active x-tab-default",border:false,items:[{xtype:"container",minWidth:300,reference:"wfName",html:""},"-",{xtype:"button",reference:"wfPrevButton",iconCls:"wfprev",disabled:true},{xtype:"button",reference:"wfNextButton",iconCls:"wfnext",disabled:true},"-",{xtype:"container",reference:"wfInstruction"}]}]});a.callParent(arguments)}});Ext.define("Baff.utility.application.MainHeader",{extend:"Ext.panel.Panel",alias:"widget.mainheader",requires:["Ext.toolbar.Toolbar","Baff.utility.workflow.WorkflowToolbar"],layout:{align:"stretch",type:"hbox"},dtLoggedInAs:"Logged in as",dtLogOffBtn:"Logoff",initComponent:function(){var a=this;var c=Utils.userSecurityManager.getUserName();var b=a.dtLoggedInAs+" <b>"+c+"<b>";Ext.apply(a,{dockedItems:[{xtype:"toolbar",dock:"top",cls:"x-tab x-tab-active x-tab-default",items:[{xtype:"workflowtoolbar"},"->",{xtype:"container",layout:{type:"vbox",align:"center"},items:[{xtype:"container",cls:"x-tab x-tab-active x-tab-default",html:b,padding:10},{xtype:"toolbar",cls:"x-tab x-tab-active x-tab-default",border:false,items:[{xtype:"button",itemId:"logoffBtn",iconCls:"logoff",text:a.dtLogOffBtn}]}]}]}]});a.callParent(arguments)}});Ext.define("Baff.utility.application.MainApplicationController",{extend:"Ext.app.Controller",alias:"controller.mainapplication",requires:["Ext.window.MessageBox","Baff.utility.usersecurity.UserSecurityManager"],views:["Baff.utility.application.LogonWindow","Baff.utility.application.RegisterUserWindow","Baff.utility.application.UpdateUserWindow","Baff.utility.application.LogonWindow","Baff.utility.application.MainHeader"],refs:[{ref:"usernameField",selector:"logonwindow textfield[name=username]"},{ref:"passwordField",selector:"logonwindow textfield[name=password]"},{ref:"emailField",selector:"registeruserwindow textfield[name=email]"},{ref:"displayNameField",selector:"registeruserwindow textfield[name=displayName]"},{ref:"updatePasswordField",selector:"updateuserwindow textfield[name=password]"},{ref:"confirmPasswordField",selector:"updateuserwindow textfield[name=confirmPassword]"}],dtInvalidLogonTitle:"Invalid Logon",dtInvalidLogonMsg:"Please enter a valid username and password",dtInvalidRegisterUserTitle:"Invalid Registration",dtInvalidRegisterUserMsg:"Please enter a valid email and display name",dtAckRegisterUserTitle:"Registration Successful",dtAckRegisterUserMsg:"Please check your email for your login details",dtAckResetTitle:"Reset Successful",dtAckResetMsg:"Please check your email for your login details",dtInvalidResetTitle:"Invalid Reset",dtInvalidResetMsg:"Please enter a valid username",dtConfirmResetTitle:"Confirm Reset",dtConfirmResetMsg:"Are you sure you want to reset your password?",dtInvalidUpdateUserTitle:"Invalid Update",dtInvalidUpdateUserMsg:"Please enter a valid display name and password",dtAckUpdateUserTitle:"Update Successful",dtAckUpdateUserMsg:"Please login with your new password",dtConfirmLogoutTitle:"Confirm Logout",dtConfirmLogoutMsg:"Are you sure you want to log out?",dtLoading:"Please wait....",dtFailTitle:"Unrecoverable System Failure",dtRestartMsg:"The application will be now be restarted. Sorry for any inconvenience caused.",HTTP_REQUEST_OK:200,splashcreen:null,init:function(){Utils.logger.info("MainApplicationController::init");var a=this;a.control({"logonwindow #logonBtn":{click:a.onLogonButton},"logonwindow #optionBtn #register":{click:a.onShowRegisterUserButton},"logonwindow #optionBtn #reset":{click:a.onResetUserButton},"logonwindow #optionBtn #update":{click:a.onShowUpdateUserButton},"registeruserwindow #registerBtn":{click:a.onRegisterUserButton},"registeruserwindow #cancelBtn":{click:a.onCancelRegisterUserButton},"mainheader toolbar #logoffBtn":{click:a.onLogoffButton},"updateuserwindow #updateBtn":{click:a.onUpdateUserButton},"updateuserwindow #cancelBtn":{click:a.onCancelUpdateUserButton}});Utils.globals.application.on("systemfailure",a.onSystemFailure,a)},onSystemFailure:function(){Utils.logger.info("MainApplicationController::onSystemFailure");var a=this;Ext.Msg.alert(a.dtFailTitle,a.dtRestartMsg,function(){Utils.userSecurityManager.logoff();window.location.reload()})},onLaunch:function(){Utils.logger.info("MainApplicationController::onLaunch");var b=this;var a=new Ext.util.DelayedTask(function(){var c=Ext.fly("splashcreen");if(c!=null){c.destroy()}b.logonWindow=Ext.create("Baff.utility.application.LogonWindow");b.logonWindow.show()});a.delay(Utils.globals.splashScreenDelay)},onLogonButton:function(){Utils.logger.info("MainApplicationController::onLogonButton");var a=this;if(a.getUsernameField().validate()&&a.getPasswordField().validate()){a.logonWindow.setLoading(a.dtLoading);Utils.userSecurityManager.logon(a.getUsernameField().getValue(),a.getPasswordField().getValue(),a.postLogon,a)}else{Ext.Msg.alert(a.dtInvalidLogonTitle,a.dtInvalidLogonMsg)}},onShowRegisterUserButton:function(){Utils.logger.info("MainApplicationController::onShowRegisterUserButton");var a=this;a.logonWindow.hide();a.registerUserWindow=Ext.create("Baff.utility.application.RegisterUserWindow");a.registerUserWindow.show()},onRegisterUserButton:function(){Utils.logger.info("MainApplicationController::onRegisterUserButton");var a=this;if(a.getEmailField().validate()&&a.getDisplayNameField().validate()){a.registerUserWindow.setLoading(a.dtLoading);Utils.userSecurityManager.registerUser(a.getEmailField().getValue(),a.getDisplayNameField().getValue(),null,a.postRegistration,a)}else{Ext.Msg.alert(a.dtInvalidRegisterUserTitle,a.dtInvalidRegisterUserMsg)}},onCancelRegisterUserButton:function(){Utils.logger.info("MainApplicationController::onCancelRegisterUserButton");var a=this;a.registerUserWindow.close();a.registerUserWindow.destroy();a.logonWindow.show()},onResetUserButton:function(){Utils.logger.info("MainApplicationController::onResetUserButton");var a=this;if(a.getUsernameField().validate()){Ext.Msg.confirm(a.dtConfirmResetTitle,a.dtConfirmResetMsg,function(b){if(b==="yes"){a.doResetUser()}})}else{Ext.Msg.alert(a.dtInvalidResetTitle,a.dtInvalidResetMsg)}},doResetUser:function(){Utils.logger.info("MainApplicationController::doResetUser");var a=this;a.logonWindow.setLoading(a.dtLoading);Utils.userSecurityManager.resetUser(a.getUsernameField().getValue(),a.postResetUser,a)},onShowUpdateUserButton:function(){Utils.logger.info("MainApplicationController::onShowUpdateUserButton");var a=this;if(a.getUsernameField().validate()&&a.getPasswordField().validate()){a.logonWindow.hide();a.updateUserWindow=Ext.create("Baff.utility.application.UpdateUserWindow");a.updateUserWindow.show()}else{Ext.Msg.alert(a.dtInvalidLogonTitle,a.dtInvalidLogonMsg)}},onUpdateUserButton:function(){Utils.logger.info("MainApplicationController::onUpdateUserButton");var a=this;if(a.getUpdatePasswordField().validate()&&a.getUpdatePasswordField().getValue()==a.getConfirmPasswordField().getValue()){a.updateUserWindow.setLoading(a.dtLoading);Utils.userSecurityManager.updateUser(a.getUsernameField().getValue(),null,a.getPasswordField().getValue(),a.getUpdatePasswordField().getValue(),null,a.postUpdateUser,a)}else{Ext.Msg.alert(a.dtInvalidUpdateUserTitle,a.dtInvalidUpdateUserMsg)}},onCancelUpdateUserButton:function(){Utils.logger.info("MainApplicationController::onCancelUpdateUserButton");var a=this;a.updateUserWindow.close();a.updateUserWindow.destroy();a.logonWindow.show()},postLogon:function(a,c,b){Utils.logger.info("MainApplicationController::postLogon");b.logonWindow.setLoading(false);if(c){if(Utils.globals.manageUsers){Utils.userSecurityManager.loadUserAttributes(b.getUsernameField().getValue(),b.postGetUserAttributes,b)}b.logonWindow.destroy();Utils.globals.viewport=Ext.create("Baff.utility.application.Viewport");Utils.globals.viewport.show()}else{if(a.getResponse()!=null&&a.getResponse().status==b.HTTP_REQUEST_OK){Ext.Msg.alert(b.dtInvalidLogonTitle,b.dtInvalidLogonMsg)}else{b.onSystemFailure()}}},postGetUserAttributes:function(a,b,d,c){Utils.logger.info("MainApplicationController::postGetUserAttributes");if(!b.success&&(b.getResponse()==null||b.getResponse().status!=c.HTTP_REQUEST_OK)){c.onSystemFailure()}},postRegistration:function(d,a,b){Utils.logger.info("MainApplicationController::postRegistration");b.registerUserWindow.setLoading(false);if(d){var c=Ext.decode(a.responseText);if(c.success){Ext.Msg.alert(b.dtAckRegisterUserTitle,b.dtAckRegisterUserMsg,function(){b.registerUserWindow.destroy();b.logonWindow.show()})}else{if(c.message!=null){Ext.Msg.alert(b.dtInvalidRegisterUserTitle,c.message)}else{b.onSystemFailure()}}}else{if(a!=null&&a.status==b.HTTP_REQUEST_OK){Ext.Msg.alert(b.dtInvalidRegisterUserTitle,b.dtInvalidRegisterUserMsg)}else{b.onSystemFailure()}}},postResetUser:function(d,a,b){Utils.logger.info("MainApplicationController::postReset");b.logonWindow.setLoading(false);if(d){var c=Ext.decode(a.responseText);if(c.success){Ext.Msg.alert(b.dtAckResetTitle,b.dtAckResetMsg)}else{if(c.message!=null){Ext.Msg.alert(b.dtInvalidResetTitle,c.message)}else{b.onSystemFailure()}}}else{if(a!=null&&a.status==b.HTTP_REQUEST_OK){Ext.Msg.alert(b.dtInvalidResetTitle,b.dtInvalidResetMsg)}else{b.onSystemFailure()}}},postUpdateUser:function(d,a,b){Utils.logger.info("MainApplicationController::postUpdateUser");b.updateUserWindow.setLoading(false);if(d){var c=Ext.decode(a.responseText);if(c.success){Ext.Msg.alert(b.dtAckUpdateUserTitle,b.dtAckUpdateUserMsg,function(){b.getPasswordField().setValue(b.getUpdatePasswordField().getValue()),b.updateUserWindow.destroy();b.logonWindow.show()})}else{if(c.message!=null){Ext.Msg.alert(b.dtInvalidUpdateUserTitle,c.message)}else{b.onSystemFailure()}}}else{if(a!=null&&a.status==b.HTTP_REQUEST_OK){Ext.Msg.alert(b.dtInvalidUpdateUserTitle,b.dtInvalidUpdateUserMsg)}else{b.onSystemFailure()}}},onLogoffButton:function(){var a=this;Ext.Msg.confirm(a.dtConfirmLogoutTitle,a.dtConfirmLogoutMsg,function(b){if(b==="yes"){Utils.userSecurityManager.logoff();window.location.reload()}})}});Ext.define("Baff.utility.application.Viewport",{extend:"Ext.container.Viewport",requires:["Baff.utility.application.MainHeader"],cls:"x-tab-bar-default",dtLoading:"Please wait....",loaders:null,layout:{type:"vbox",align:"stretch"},initComponent:function(){var a=this;a.loaders=new Ext.util.HashMap();Ext.apply(a,{items:[{xtype:"mainheader",frame:true},{xtype:Utils.globals.mainView,frame:true,flex:1}]});a.callParent(arguments)},showWaitMask:function(a,c){var b=this;if(a){b.loaders.add(c,"loading");b.setLoading(b.dtLoading)}else{b.loaders.removeAtKey(c);if(b.loaders.getCount()<=0){b.setLoading(false)}}},showAlertMessage:function(c,b,d){var a=this;Ext.Msg.alert(c,b,function(e,f){if(a.loaders.getCount()>0){a.setLoading(a.dtLoading)}if(d!=null){d(e,f)}})}});Ext.define("Baff.utility.refdata.RefDataCode",{extend:"Ext.data.field.Field",alias:"data.field.refdatacode",constructor:function(){var a=this;a.callParent(arguments)}});